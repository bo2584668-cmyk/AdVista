<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تحقق من المشاهدة - Advista</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            padding: 50px;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.3);
            animation: fadeIn 0.8s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .logo {
            margin-bottom: 40px;
        }
        
        .logo-icon {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 25px;
            font-size: 50px;
            color: white;
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .status-card {
            padding: 40px;
            border-radius: 25px;
            margin-bottom: 40px;
            font-size: 1.2rem;
            transition: all 0.4s ease;
        }
        
        .loading {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
            border: 2px solid #667eea;
            color: #667eea;
        }
        
        .success {
            background: linear-gradient(135deg, rgba(0, 176, 155, 0.15), rgba(150, 201, 61, 0.15));
            border: 2px solid #00b09b;
            color: #00b09b;
            animation: pulse 2s infinite;
        }
        
        .error {
            background: linear-gradient(135deg, rgba(255, 65, 108, 0.15), rgba(255, 75, 43, 0.15));
            border: 2px solid #ff416c;
            color: #ff416c;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .points-display {
            font-size: 4.5rem;
            font-weight: 900;
            margin: 30px 0;
            text-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .loading-spinner {
            width: 80px;
            height: 80px;
            border: 8px solid rgba(102, 126, 234, 0.3);
            border-top: 8px solid #667eea;
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
            margin: 0 auto 30px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .btn {
            display: inline-block;
            padding: 20px 45px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.3rem;
            font-weight: 800;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.1);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
            margin-top: 20px;
        }
        
        .btn:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 25px 50px rgba(102, 126, 234, 0.5);
        }
        
        .btn:active {
            transform: translateY(-4px);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
            box-shadow: 0 15px 35px rgba(0, 176, 155, 0.4);
        }
        
        .btn-success:hover {
            box-shadow: 0 25px 50px rgba(0, 176, 155, 0.5);
        }
        
        .info-box {
            background: linear-gradient(135deg, rgba(247, 151, 30, 0.15), rgba(255, 210, 0, 0.15));
            border: 2px solid #f7971e;
            border-radius: 20px;
            padding: 25px;
            margin: 30px 0;
            text-align: right;
        }
        
        .info-box h3 {
            color: #f7971e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .info-box ul {
            list-style: none;
            color: #666;
            line-height: 2.2;
        }
        
        .info-box li {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .info-box i {
            color: #f7971e;
            font-size: 1.2rem;
        }
        
        .timer {
            font-size: 5rem;
            font-weight: 900;
            margin: 30px 0;
            color: #333;
            text-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 30px 20px;
            }
            
            .logo-icon {
                width: 90px;
                height: 90px;
                font-size: 35px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .points-display {
                font-size: 3.5rem;
            }
            
            .timer {
                font-size: 4rem;
            }
            
            .btn {
                padding: 18px 35px;
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <div class="logo-icon">
                <i class="fas fa-coins"></i>
            </div>
            <h1>Advista</h1>
        </div>
        
        <div id="statusCard" class="status-card loading">
            <div class="loading-spinner"></div>
            <h2>جاري التحقق من مشاهدة الإعلان...</h2>
            <p id="statusMessage">يرجى الانتظار بينما نتحقق من مشاهدتك للإعلان</p>
        </div>
        
        <div id="resultContent" style="display: none;">
            <div class="points-display" id="pointsEarned">+0</div>
            <h2 id="resultTitle"></h2>
            <p id="resultMessage"></p>
            
            <div class="info-box" id="adInfo" style="display: none;">
                <h3><i class="fas fa-info-circle"></i> معلومات الإعلان</h3>
                <ul>
                    <li><i class="fas fa-heading"></i> العنوان: <span id="adTitle"></span></li>
                    <li><i class="fas fa-coins"></i> النقاط: <span id="adPoints"></span></li>
                    <li><i class="fas fa-clock"></i> وقت المشاهدة: <span id="viewTime"></span></li>
                </ul>
            </div>
            
            <a href="https://ad-vista.vercel.app" id="returnBtn" class="btn btn-success">
                <i class="fas fa-arrow-right"></i> العودة إلى التطبيق
            </a>
        </div>
        
        <div id="countdownTimer" style="display: none;">
            <div class="timer" id="timerDisplay">30</div>
            <h3>جاري عد الثواني المتبقية...</h3>
            <p>يرجى عدم مغادرة هذه الصفحة حتى انتهاء العد التنازلي</p>
            <div class="info-box">
                <h3><i class="fas fa-exclamation-triangle"></i> ملاحظة هامة</h3>
                <ul>
                    <li><i class="fas fa-check"></i> إذا عدت بعد انتهاء العداد: تحصل على النقاط</li>
                    <li><i class="fas fa-times"></i> إذا عدت قبل انتهاء العداد: يتم الخصم</li>
                    <li><i class="fas fa-user-shield"></i> سيتم التحقق تلقائياً</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Font Awesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC4fZQ-BTUeHsN9nQtMGmnjJz-NKdcUgkc",
            authDomain: "advista-b64ab.firebaseapp.com",
            projectId: "advista-b64ab",
            storageBucket: "advista-b64ab.firebasestorage.app",
            messagingSenderId: "509713648189",
            appId: "1:509713648189:web:0ccd6ada1f4e07f85d3854",
            measurementId: "G-VG4S1SMKH8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // الحصول على المعلمات من الرابط
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('uid');
        const adId = urlParams.get('ad');
        
        // متغيرات العد التنازلي
        let countdownTime = 30; // 30 ثانية افتراضياً
        let countdownInterval;
        let adData = null;

        // دالة التحقق من المصدر (الأمان)
        function checkSecurity() {
            const referrer = document.referrer;
            console.log('Referrer:', referrer);
            
            // التحقق من أن المستخدم جاء من linkjust.com
            if (!referrer.includes('linkjust.com')) {
                return false;
            }
            
            return true;
        }

        // دالة بدء العد التنازلي
        function startCountdown() {
            const timerDisplay = document.getElementById('timerDisplay');
            const countdownTimer = document.getElementById('countdownTimer');
            const statusCard = document.getElementById('statusCard');
            
            // إخفاء بطاقة الحالة وإظهار العد التنازلي
            statusCard.style.display = 'none';
            countdownTimer.style.display = 'block';
            
            timerDisplay.textContent = countdownTime;
            
            countdownInterval = setInterval(() => {
                countdownTime--;
                timerDisplay.textContent = countdownTime;
                
                if (countdownTime <= 0) {
                    clearInterval(countdownInterval);
                    // بعد انتهاء الوقت، تحقق من المشاهدة
                    verifyAdView(true);
                }
            }, 1000);
        }

        // دالة التحقق من مشاهدة الإعلان
        async function verifyAdView(completed) {
            const statusCard = document.getElementById('statusCard');
            const resultContent = document.getElementById('resultContent');
            const countdownTimer = document.getElementById('countdownTimer');
            const pointsEarned = document.getElementById('pointsEarned');
            const resultTitle = document.getElementById('resultTitle');
            const resultMessage = document.getElementById('resultMessage');
            const adInfo = document.getElementById('adInfo');
            const adTitleElem = document.getElementById('adTitle');
            const adPointsElem = document.getElementById('adPoints');
            const viewTimeElem = document.getElementById('viewTime');
            
            // إخفاء العد التنازلي وإظهار النتيجة
            countdownTimer.style.display = 'none';
            statusCard.style.display = 'none';
            resultContent.style.display = 'block';
            
            try {
                // التحقق من الأمان أولاً
                if (!checkSecurity()) {
                    statusCard.className = 'status-card error';
                    statusCard.innerHTML = `
                        <h2><i class="fas fa-shield-alt"></i> خطأ أمني</h2>
                        <p>يجب مشاهدة الإعلان من خلال الرابط المختصر فقط.</p>
                        <p>لن يتم منح أي نقاط لهذه المحاولة.</p>
                    `;
                    statusCard.style.display = 'block';
                    resultContent.style.display = 'none';
                    return;
                }
                
                if (!userId || !adId) {
                    throw new Error('بيانات غير كافية للتحقق');
                }
                
                // جلب بيانات الإعلان
                const adRef = db.collection('ads').doc(adId);
                const adDoc = await adRef.get();
                
                if (!adDoc.exists) {
                    throw new Error('الإعلان غير موجود');
                }
                
                adData = { id: adDoc.id, ...adDoc.data() };
                const rewardPoints = adData.points || 50;
                const currentTime = new Date().toISOString();
                
                if (completed) {
                    // الحالة: اكتملت المشاهدة بنجاح
                    
                    // البحث عن تتبع الإعلان لهذا المستخدم
                    const trackingQuery = await db.collection('adTracking')
                        .where('userId', '==', userId)
                        .where('adId', '==', adId)
                        .where('status', '==', 'pending')
                        .orderBy('startTime', 'desc')
                        .limit(1)
                        .get();
                    
                    let trackingId = null;
                    if (!trackingQuery.empty) {
                        trackingId = trackingQuery.docs[0].id;
                    }
                    
                    // تحديث بيانات المستخدم
                    const userRef = db.collection('users').doc(userId);
                    
                    await db.runTransaction(async (transaction) => {
                        const userDoc = await transaction.get(userRef);
                        
                        if (!userDoc.exists) {
                            throw new Error('المستخدم غير موجود');
                        }
                        
                        const user = userDoc.data();
                        
                        // التحقق من الحد اليومي
                        if (user.adsViewedToday >= user.dailyAdsLimit) {
                            throw new Error('وصلت للحد اليومي من الإعلانات');
                        }
                        
                        // التحقق مما إذا شاهد الإعلان اليوم
                        if (user.viewedAdsToday && user.viewedAdsToday.includes(adId)) {
                            throw new Error('لقد شاهدت هذا الإعلان اليوم بالفعل');
                        }
                        
                        // تحديث بيانات المستخدم
                        transaction.update(userRef, {
                            balance: firebase.firestore.FieldValue.increment(rewardPoints),
                            dailyEarnings: firebase.firestore.FieldValue.increment(rewardPoints),
                            totalEarnings: firebase.firestore.FieldValue.increment(rewardPoints),
                            adsViewedToday: firebase.firestore.FieldValue.increment(1),
                            totalAdsViewed: firebase.firestore.FieldValue.increment(1),
                            lastAdViewDate: currentTime,
                            viewedAdsToday: firebase.firestore.FieldValue.arrayUnion(adId)
                        });
                        
                        // تحديث عدد مشاهدات الإعلان
                        transaction.update(adRef, {
                            totalViews: firebase.firestore.FieldValue.increment(1),
                            lastViewed: currentTime
                        });
                        
                        // تحديث حالة التتبع إذا كان موجوداً
                        if (trackingId) {
                            const trackingRef = db.collection('adTracking').doc(trackingId);
                            transaction.update(trackingRef, {
                                endTime: currentTime,
                                status: 'completed',
                                pointsAwarded: rewardPoints
                            });
                        }
                    });
                    
                    // تسجيل مشاهدة الإعلان في السجل
                    const adViewRef = db.collection('adViews').doc();
                    await adViewRef.set({
                        id: adViewRef.id,
                        userId: userId,
                        adId: adId,
                        adTitle: adData.title || 'إعلان مختصر',
                        points: rewardPoints,
                        completed: true,
                        viewedAt: currentTime,
                        type: 'short',
                        sessionId: generateSessionId()
                    });
                    
                    // البحث عن المدعو (إذا كان المستخدم لديه مدعو) لمنح العمولة
                    const userDoc = await userRef.get();
                    const userData = userDoc.data();
                    
                    if (userData.referredBy) {
                        const referralBonus = Math.floor(rewardPoints * 0.1);
                        const referrerRef = db.collection('users').doc(userData.referredBy);
                        
                        await referrerRef.update({
                            balance: firebase.firestore.FieldValue.increment(referralBonus),
                            referralEarnings: firebase.firestore.FieldValue.increment(referralBonus)
                        });
                    }
                    
                    // عرض رسالة النجاح
                    statusCard.className = 'status-card success';
                    pointsEarned.textContent = `+${rewardPoints}`;
                    pointsEarned.style.color = '#00b09b';
                    resultTitle.textContent = 'تمت المشاهدة بنجاح!';
                    resultMessage.textContent = `تمت إضافة ${rewardPoints} نقطة إلى رصيدك بنجاح.`;
                    
                    // عرض معلومات الإعلان
                    adInfo.style.display = 'block';
                    adTitleElem.textContent = adData.title || 'إعلان مختصر';
                    adPointsElem.textContent = rewardPoints + ' نقطة';
                    viewTimeElem.textContent = new Date().toLocaleTimeString('ar-EG');
                    
                } else {
                    // الحالة: لم تكتمل المشاهدة (خرج قبل الوقت)
                    
                    // خصم 5 نقاط
                    const penaltyPoints = 5;
                    
                    const userRef = db.collection('users').doc(userId);
                    await userRef.update({
                        balance: firebase.firestore.FieldValue.increment(-penaltyPoints)
                    });
                    
                    // تسجيل العقوبة في السجل
                    const adViewRef = db.collection('adViews').doc();
                    await adViewRef.set({
                        id: adViewRef.id,
                        userId: userId,
                        adId: adId,
                        adTitle: adData.title || 'إعلان مختصر',
                        points: -penaltyPoints,
                        completed: false,
                        viewedAt: currentTime,
                        type: 'short',
                        sessionId: generateSessionId(),
                        reason: 'خرج قبل انتهاء الوقت'
                    });
                    
                    // عرض رسالة العقوبة
                    statusCard.className = 'status-card error';
                    pointsEarned.textContent = `-${penaltyPoints}`;
                    pointsEarned.style.color = '#ff416c';
                    resultTitle.textContent = 'لم تكتمل المشاهدة';
                    resultMessage.textContent = `تم خصم ${penaltyPoints} نقطة بسبب الخروج قبل انتهاء الوقت.`;
                    
                    // تحديث حالة التتبع إذا كان موجوداً
                    const trackingQuery = await db.collection('adTracking')
                        .where('userId', '==', userId)
                        .where('adId', '==', adId)
                        .where('status', '==', 'pending')
                        .orderBy('startTime', 'desc')
                        .limit(1)
                        .get();
                    
                    if (!trackingQuery.empty) {
                        const trackingId = trackingQuery.docs[0].id;
                        const trackingRef = db.collection('adTracking').doc(trackingId);
                        await trackingRef.update({
                            endTime: currentTime,
                            status: 'failed',
                            pointsDeducted: penaltyPoints
                        });
                    }
                }
                
            } catch (error) {
                console.error('Error verifying ad view:', error);
                
                statusCard.className = 'status-card error';
                statusCard.innerHTML = `
                    <h2><i class="fas fa-exclamation-triangle"></i> حدث خطأ</h2>
                    <p>${error.message}</p>
                    <p>يرجى المحاولة مرة أخرى أو الاتصال بالدعم.</p>
                `;
                
                resultContent.style.display = 'none';
                statusCard.style.display = 'block';
            }
        }

        // دالة إنشاء ID للجلسة
        function generateSessionId() {
            return 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // دالة التحقق مما إذا كان المستخدم خرج من الصفحة
        function setupPageExitDetection() {
            let pageActive = true;
            
            // كشف عندما تكون الصفحة غير مرئية
            document.addEventListener('visibilitychange', function() {
                if (document.hidden && pageActive) {
                    pageActive = false;
                    // إذا خرج قبل انتهاء الوقت
                    if (countdownTime > 0) {
                        clearInterval(countdownInterval);
                        verifyAdView(false);
                    }
                }
            });
            
            // كشف إغلاق النافذة
            window.addEventListener('beforeunload', function(e) {
                if (countdownTime > 0 && pageActive) {
                    // حاول إرسال طلب قبل المغادرة (قد لا يعمل دائماً)
                    navigator.sendBeacon('/api/track-exit', JSON.stringify({
                        userId: userId,
                        adId: adId,
                        timeLeft: countdownTime
                    }));
                    
                    // عرض رسالة تحذير
                    e.preventDefault();
                    e.returnValue = 'إذا غادرت الآن سيتم خصم 5 نقاط. هل أنت متأكد؟';
                }
            });
        }

        // بدء العملية عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            // التحقق من البيانات الأساسية
            if (!userId || !adId) {
                document.getElementById('statusCard').className = 'status-card error';
                document.getElementById('statusCard').innerHTML = `
                    <h2><i class="fas fa-exclamation-triangle"></i> بيانات ناقصة</h2>
                    <p>لم يتم توفير بيانات كافية للتحقق.</p>
                    <p>يرجى مشاهدة الإعلان من خلال الرابط الصحيح.</p>
                `;
                return;
            }
            
            // إعداد كشف خروج الصفحة
            setupPageExitDetection();
            
            // بدء العد التنازلي
            startCountdown();
        });
    </script>
</body>
</html>
