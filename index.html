<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>أدفيستا - ربح الأموال من مشاهدة الإعلانات</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .referral-text, .withdrawal-text {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #2a3c8f, #3a4db2);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: pan-y;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo h1 {
            font-size: 1.8rem;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .points {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        
        @media (min-width: 768px) {
            .main-content {
                grid-template-columns: 2fr 1fr;
            }
        }
        
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }
        
        .card h2 {
            margin-bottom: 20px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #4facfe;
        }
        
        .card h2 i {
            font-size: 1.2rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #00f2fe;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .ads-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .ad-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            border: 1px solid transparent;
        }
        
        .ad-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(79, 172, 254, 0.3);
            transform: translateY(-3px);
        }
        
        .ad-info h3 {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        .ad-info p {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .ad-reward {
            color: #00f2fe;
            font-weight: 600;
        }
        
        .ad-timer {
            font-size: 0.9rem;
            color: #ffcc00;
        }
        
        .btn {
            background: linear-gradient(to right, #4facfe, #00f2fe);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(79, 172, 254, 0.3);
        }
        
        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-danger {
            background: linear-gradient(to right, #ff416c, #ff4b2b);
        }
        
        .btn-success {
            background: linear-gradient(to right, #00b09b, #96c93d);
        }
        
        .btn-warning {
            background: linear-gradient(to right, #f7971e, #ffd200);
        }
        
        .timer-container {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        
        .timer {
            font-size: 3rem;
            font-weight: 700;
            color: #00f2fe;
            margin: 15px 0;
        }
        
        .warning {
            color: #ffcc00;
            font-size: 0.9rem;
            margin-top: 10px;
        }
        
        .penalty {
            color: #ff416c;
            font-weight: 600;
        }
        
        .login-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            text-align: center;
        }
        
        .login-box {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 40px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .login-box h1 {
            margin-bottom: 10px;
            font-size: 2.2rem;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .login-box p {
            margin-bottom: 30px;
            opacity: 0.8;
            line-height: 1.6;
        }
        
        #buttonDiv {
            margin: 20px 0;
        }
        
        .nav-tabs {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .nav-tab {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            padding: 10px 20px;
            border-radius: 30px;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
        }
        
        .nav-tab.active {
            background: rgba(79, 172, 254, 0.2);
            color: #4facfe;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .referral-link-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .referral-link {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            word-break: break-all;
            margin: 15px 0;
            border: 1px dashed rgba(255, 255, 255, 0.2);
        }
        
        .withdrawal-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-weight: 600;
        }
        
        .form-control {
            padding: 15px;
            border-radius: 10px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
        }
        
        .form-control:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(79, 172, 254, 0.5);
        }
        
        .withdrawal-info {
            background: rgba(255, 193, 7, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            border-left: 4px solid #ffc107;
        }
        
        .admin-panel {
            display: none;
        }
        
        .admin-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .admin-section {
            margin-bottom: 30px;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 600;
        }
        
        tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        
        .status-pending {
            color: #ffc107;
        }
        
        .status-approved {
            color: #00b09b;
        }
        
        .status-rejected {
            color: #ff416c;
        }
        
        .ad-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        
        .ad-modal-content {
            width: 90%;
            max-width: 800px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 30px;
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255, 65, 108, 0.2);
            color: #ff416c;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .ad-frame {
            width: 100%;
            height: 400px;
            border: none;
            border-radius: 10px;
            background: white;
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 350px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.5s;
        }
        
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .notification.success {
            border-right: 4px solid #00b09b;
        }
        
        .notification.error {
            border-right: 4px solid #ff416c;
        }
        
        .notification.warning {
            border-right: 4px solid #ffc107;
        }
        
        .post-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        textarea.form-control {
            min-height: 150px;
            resize: vertical;
        }
        
        .post-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #4facfe;
        }
        
        .post-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .post-author {
            font-weight: 600;
            color: #4facfe;
        }
        
        .post-date {
            font-size: 0.9rem;
            opacity: 0.7;
        }
        
        .post-content {
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .post-stats {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .membership-badges {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .badge {
            background: linear-gradient(to right, #f7971e, #ffd200);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .badge.vip {
            background: linear-gradient(to right, #8a2387, #e94057, #f27121);
        }
        
        .badge.premium {
            background: linear-gradient(to right, #00b09b, #96c93d);
        }
        
        footer {
            text-align: center;
            padding: 20px 0;
            margin-top: 40px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
            opacity: 0.7;
        }
        
        .ad-counter {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
        }
        
        .counter-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #00f2fe;
        }
        
        .ad-frame-container {
            position: relative;
            width: 100%;
            height: 400px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .fake-ad {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            padding: 20px;
        }
        
        .fake-ad h3 {
            font-size: 1.8rem;
            margin-bottom: 15px;
        }
        
        .fake-ad p {
            font-size: 1.1rem;
            margin-bottom: 20px;
            opacity: 0.9;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .card {
                padding: 20px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .timer {
                font-size: 2.5rem;
            }
            
            .login-box {
                padding: 30px 20px;
            }
            
            .ad-modal-content {
                padding: 20px;
            }
            
            .ad-frame, .ad-frame-container {
                height: 300px;
            }
        }
        
        @media (max-width: 768px) {
            body {
                touch-action: pan-y;
            }
            
            input, textarea, select {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- شاشة تسجيل الدخول -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="logo">
                <i class="fas fa-ad" style="font-size: 2.5rem; color: #4facfe;"></i>
                <h1>أدفيستا</h1>
            </div>
            <p>اربح الأموال من خلال مشاهدة الإعلانات! سجل الدخول الآن وابدأ في جمع النقاط التي يمكنك تحويلها إلى أموال حقيقية.</p>
            
            <div id="buttonDiv"></div>
            
            <p style="margin-top: 20px; font-size: 0.9rem;">
                <i class="fas fa-shield-alt"></i> نحمي خصوصيتك ولا نشارك بياناتك مع أي جهة خارجية
            </p>
        </div>
    </div>
    
    <!-- لوحة المستخدم الرئيسية -->
    <div id="userDashboard" class="container" style="display: none;">
        <header>
            <div class="logo">
                <i class="fas fa-ad"></i>
                <h1>أدفيستا</h1>
            </div>
            <div class="user-info">
                <div class="points">
                    <i class="fas fa-coins"></i> <span id="userPoints">0</span> نقطة
                </div>
                <div class="user-avatar" id="userAvatar" onclick="toggleUserMenu()">
                    <i class="fas fa-user"></i>
                </div>
            </div>
        </header>
        
        <div class="nav-tabs" id="navTabs">
            <button class="nav-tab active" data-tab="dashboard">
                <i class="fas fa-tachometer-alt"></i> لوحة التحكم
            </button>
            <button class="nav-tab" data-tab="ads">
                <i class="fas fa-ad"></i> تصفح الإعلانات
            </button>
            <button class="nav-tab" data-tab="referrals">
                <i class="fas fa-users"></i> نظام الإحالات
            </button>
            <button class="nav-tab" data-tab="withdrawal">
                <i class="fas fa-money-bill-wave"></i> السحب
            </button>
            <button class="nav-tab" id="adminTab" style="display: none;" data-tab="admin">
                <i class="fas fa-crown"></i> لوحة الإدارة
            </button>
        </div>
        
        <!-- تبويب لوحة التحكم -->
        <div id="dashboardTab" class="tab-content active">
            <div class="card">
                <h2><i class="fas fa-chart-line"></i> إحصائياتك</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="currentBalance">0</div>
                        <div class="stat-label">الرصيد الحالي (نقاط)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="todayEarnings">0</div>
                        <div class="stat-label">أرباح اليوم</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalEarnings">0</div>
                        <div class="stat-label">إجمالي الأرباح</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="referralEarnings">0</div>
                        <div class="stat-label">أرباح الإحالات</div>
                    </div>
                </div>
                
                <h2><i class="fas fa-chart-bar"></i> نشاطك خلال الأسبوع</h2>
                <div style="height: 200px; display: flex; align-items: flex-end; gap: 10px; margin-top: 20px; padding: 0 10px;">
                    <div class="chart-bar" data-day="السبت" style="height: 30%; background: linear-gradient(to top, #4facfe, #00f2fe); flex: 1; border-radius: 5px 5px 0 0; position: relative;">
                        <div class="chart-label" style="position: absolute; bottom: -25px; width: 100%; text-align: center; font-size: 0.8rem;">السبت</div>
                    </div>
                    <div class="chart-bar" data-day="الأحد" style="height: 50%; background: linear-gradient(to top, #4facfe, #00f2fe); flex: 1; border-radius: 5px 5px 0 0; position: relative;">
                        <div class="chart-label" style="position: absolute; bottom: -25px; width: 100%; text-align: center; font-size: 0.8rem;">الأحد</div>
                    </div>
                    <div class="chart-bar" data-day="الإثنين" style="height: 70%; background: linear-gradient(to top, #4facfe, #00f2fe); flex: 1; border-radius: 5px 5px 0 0; position: relative;">
                        <div class="chart-label" style="position: absolute; bottom: -25px; width: 100%; text-align: center; font-size: 0.8rem;">الإثنين</div>
                    </div>
                    <div class="chart-bar" data-day="الثلاثاء" style="height: 90%; background: linear-gradient(to top, #4facfe, #00f2fe); flex: 1; border-radius: 5px 5px 0 0; position: relative;">
                        <div class="chart-label" style="position: absolute; bottom: -25px; width: 100%; text-align: center; font-size: 0.8rem;">الثلاثاء</div>
                    </div>
                    <div class="chart-bar" data-day="الأربعاء" style="height: 60%; background: linear-gradient(to top, #4facfe, #00f2fe); flex: 1; border-radius: 5px 5px 0 0; position: relative;">
                        <div class="chart-label" style="position: absolute; bottom: -25px; width: 100%; text-align: center; font-size: 0.8rem;">الأربعاء</div>
                    </div>
                    <div class="chart-bar" data-day="الخميس" style="height: 40%; background: linear-gradient(to top, #4facfe, #00f2fe); flex: 1; border-radius: 5px 5px 0 0; position: relative;">
                        <div class="chart-label" style="position: absolute; bottom: -25px; width: 100%; text-align: center; font-size: 0.8rem;">الخميس</div>
                    </div>
                    <div class="chart-bar" data-day="الجمعة" style="height: 80%; background: linear-gradient(to top, #4facfe, #00f2fe); flex: 1; border-radius: 5px 5px 0 0; position: relative;">
                        <div class="chart-label" style="position: absolute; bottom: -25px; width: 100%; text-align: center; font-size: 0.8rem;">الجمعة</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-bullhorn"></i> الإعلانات المتاحة</h2>
                <div class="ads-list" id="availableAds">
                    <!-- سيتم ملؤها بواسطة JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- تبويب تصفح الإعلانات -->
        <div id="adsTab" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-ad"></i> تصفح الإعلانات واربح النقاط</h2>
                <p style="margin-bottom: 20px; opacity: 0.8;">اضغط على أي إعلان لمشاهدته وانتظر 30 ثانية للحصول على النقاط. إذا غادرت قبل انتهاء الوقت سيتم خصم 5 نقاط.</p>
                
                <div class="ad-counter">
                    <span>عدد الإعلانات التي شاهدتها اليوم:</span>
                    <div class="counter-value" id="adsWatchedToday">0</div>
                    <span>/ 25</span>
                </div>
                
                <div id="adsContainer">
                    <!-- سيتم ملؤها بواسطة JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- تبويب نظام الإحالات -->
        <div id="referralsTab" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-users"></i> نظام الإحالات</h2>
                <p>ادعُ أصدقاءك لموقع أدفيستا واربح 10% من أرباحهم لمدة شهر كامل!</p>
                
                <div class="referral-link-container">
                    <h3><i class="fas fa-link"></i> رابط الإحالة الخاص بك</h3>
                    <div class="referral-link referral-text" id="referralLink">
                        جاري التحميل...
                    </div>
                    <button class="btn" onclick="copyReferralLink()">
                        <i class="fas fa-copy"></i> نسخ رابط الإحالة
                    </button>
                </div>
                
                <h3><i class="fas fa-chart-pie"></i> إحصائيات الإحالات</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalReferrals">0</div>
                        <div class="stat-label">إجمالي المُحالين</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="activeReferrals">0</div>
                        <div class="stat-label">المُحالين النشطين</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="referralEarningsTab">0</div>
                        <div class="stat-label">أرباح الإحالات (نقاط)</div>
                    </div>
                </div>
                
                <h3><i class="fas fa-users"></i> قائمة المُحالين</h3>
                <div class="table-container">
                    <table id="referralsList">
                        <thead>
                            <tr>
                                <th>البريد الإلكتروني</th>
                                <th>تاريخ التسجيل</th>
                                <th>حالة الحساب</th>
                                <th>الأرباح المولدة</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="4" style="text-align: center;">لا توجد إحالات حتى الآن</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- تبويب السحب -->
        <div id="withdrawalTab" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-money-bill-wave"></i> سحب الأرباح</h2>
                
                <div class="withdrawal-info">
                    <p><i class="fas fa-info-circle"></i> 30,000 نقطة = 1 دولار</p>
                    <p>الحد الأدنى للسحب هو 30,000 نقطة (1 دولار)</p>
                    <p>طريقة السحب: فودافون كاش فقط</p>
                </div>
                
                <div class="withdrawal-form">
                    <div class="form-group">
                        <label for="vodafoneNumber">رقم فودافون كاش</label>
                        <input type="text" id="vodafoneNumber" class="form-control withdrawal-text" placeholder="أدخل رقم فودافون كاش (مثال: 01012345678)" maxlength="11">
                    </div>
                    
                    <div class="form-group">
                        <label for="withdrawalAmount">عدد النقاط المراد سحبها</label>
                        <input type="number" id="withdrawalAmount" class="form-control withdrawal-text" placeholder="أدخل عدد النقاط (الحد الأدنى: 30000)" min="30000" step="100">
                        <small style="opacity: 0.7; margin-top: 5px;">المبلغ بالدولار: <span id="dollarAmount">0</span> دولار</small>
                    </div>
                    
                    <button class="btn btn-success" onclick="requestWithdrawal()" id="withdrawalBtn">
                        <i class="fas fa-paper-plane"></i> إرسال طلب السحب
                    </button>
                </div>
                
                <h3 style="margin-top: 30px;"><i class="fas fa-history"></i> سجل طلبات السحب</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>المبلغ (نقاط)</th>
                                <th>المبلغ (دولار)</th>
                                <th>رقم فودافون</th>
                                <th>الحالة</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawalHistory">
                            <tr>
                                <td colspan="5" style="text-align: center;">لا توجد طلبات سحب سابقة</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- تبويب لوحة الإدارة (للأدمن فقط) -->
        <div id="adminTab" class="tab-content admin-panel">
            <div class="card">
                <h2><i class="fas fa-crown"></i> لوحة إدارة أدفيستا</h2>
                
                <div class="admin-controls">
                    <div class="card">
                        <h3><i class="fas fa-ad"></i> نشر إعلان جديد</h3>
                        <div class="form-group">
                            <label for="adTitle">عنوان الإعلان (نص الزرار)</label>
                            <input type="text" id="adTitle" class="form-control" placeholder="عنوان الإعلان">
                        </div>
                        <div class="form-group">
                            <label for="adDescription">وصف الإعلان (اختياري)</label>
                            <textarea id="adDescription" class="form-control" placeholder="وصف الإعلان"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="adLink">رابط الإعلان</label>
                            <input type="url" id="adLink" class="form-control" placeholder="https://example.com">
                        </div>
                        <div class="form-group">
                            <label for="adReward">عدد النقاط</label>
                            <input type="number" id="adReward" class="form-control" placeholder="10" min="1" value="10">
                        </div>
                        <div class="form-group">
                            <label for="adDuration">المدة (ثانية)</label>
                            <input type="number" id="adDuration" class="form-control" placeholder="30" min="10" value="30">
                        </div>
                        <button class="btn btn-success" onclick="addNewAd()">
                            <i class="fas fa-plus"></i> نشر الإعلان
                        </button>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-users"></i> إحصائيات الموقع</h3>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="totalUsers">0</div>
                                <div class="stat-label">إجمالي المستخدمين</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="totalAds">0</div>
                                <div class="stat-label">إجمالي الإعلانات</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="totalClicks">0</div>
                                <div class="stat-label">إجمالي النقرات</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="totalWithdrawals">0</div>
                                <div class="stat-label">طلبات السحب</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="admin-section">
                    <h3><i class="fas fa-money-bill-wave"></i> طلبات السحب المعلقة</h3>
                    <div class="table-container">
                        <table id="pendingWithdrawalsTable">
                            <thead>
                                <tr>
                                    <th>المستخدم</th>
                                    <th>رقم فودافون</th>
                                    <th>المبلغ (نقاط)</th>
                                    <th>المبلغ (دولار)</th>
                                    <th>التاريخ</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" style="text-align: center;">لا توجد طلبات سحب معلقة</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="admin-section">
                    <h3><i class="fas fa-ad"></i> إدارة الإعلانات</h3>
                    <div class="table-container">
                        <table id="adsManagementTable">
                            <thead>
                                <tr>
                                    <th>العنوان</th>
                                    <th>الوصف</th>
                                    <th>الرابط</th>
                                    <th>النقاط</th>
                                    <th>المدة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" style="text-align: center;">لا توجد إعلانات</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- نافذة عرض الإعلان -->
        <div class="ad-modal" id="adModal">
            <div class="ad-modal-content">
                <button class="close-modal" onclick="closeAdModal()">
                    <i class="fas fa-times"></i>
                </button>
                <h2 id="adModalTitle">مشاهدة الإعلان</h2>
                <div class="timer-container">
                    <p>يجب مشاهدة الإعلان لمدة <span id="adDurationDisplay">30</span> ثانية للحصول على النقاط</p>
                    <div class="timer" id="adTimer">30</div>
                    <p class="warning">تحذير: إذا غادرت قبل انتهاء الوقت سيتم خصم <span class="penalty">5 نقاط</span> من رصيدك!</p>
                </div>
                
                <div class="ad-frame-container">
                    <div class="fake-ad" id="fakeAdContent">
                        <h3 id="adDisplayTitle">جاري تحميل الإعلان...</h3>
                        <p id="adDisplayDescription">شاهد هذا الإعلان لمدة 30 ثانية لتحصل على النقاط</p>
                        <div style="margin-top: 20px; font-size: 2rem;">
                            <i class="fas fa-ad"></i>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" id="completeAdBtn" style="display: none;" onclick="completeAd()">
                        <i class="fas fa-check"></i> تمت مشاهدة الإعلان
                    </button>
                </div>
            </div>
        </div>
        
        <!-- الإشعارات -->
        <div class="notification" id="notification">
            <i class="fas fa-info-circle"></i>
            <span id="notificationMessage">هذه رسالة إشعار</span>
        </div>
        
        <footer>
            <p>© 2023 أدفيستا. جميع الحقوق محفوظة.</p>
            <p>هذا الموقع مخصص للأشخاص الذين تبلغ أعمارهم 18 عامًا أو أكثر.</p>
        </footer>
    </div>
    
    <script>
        // تهيئة Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC4fZQ-BTUeHsN9nQtMGmnjJz-NKdcUgkc",
            authDomain: "advista-b64ab.firebaseapp.com",
            projectId: "advista-b64ab",
            storageBucket: "advista-b64ab.firebasestorage.app",
            messagingSenderId: "509713648189",
            appId: "1:509713648189:web:0ccd6ada1f4e07f85d3854",
            measurementId: "G-VG4S1SMKH8"
        };
        
        // تهيئة Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // بيانات المستخدم الحالي
        let currentUser = null;
        let userData = null;
        let ads = [];
        let currentAd = null;
        let timerInterval = null;
        let timeLeft = 30;
        let adCompleted = false;
        let adsWatchedToday = 0;
        
        // تهيئة تسجيل الدخول عبر جوجل
        function initializeGoogleSignIn() {
            if (typeof google === 'undefined') {
                setTimeout(initializeGoogleSignIn, 100);
                return;
            }
            
            google.accounts.id.initialize({
                client_id: "805966277330-9j5j1nvluj69f8uieog0kk77p0jb46q4.apps.googleusercontent.com",
                callback: handleCredentialResponse,
                auto_select: false,
                cancel_on_tap_outside: true,
                context: "signin"
            });
            
            // عرض زر تسجيل الدخول
            google.accounts.id.renderButton(
                document.getElementById("buttonDiv"),
                { 
                    theme: "filled_blue", 
                    size: "large",
                    text: "signin_with",
                    shape: "rectangular",
                    width: "250",
                    locale: "ar",
                    logo_alignment: "left"
                }
            );
            
            google.accounts.id.prompt();
        }
        
        // معالجة الاستجابة والبيانات
        async function handleCredentialResponse(response) {
            try {
                // فك تشفير التوكن للحصول على البيانات
                const userData = parseJwt(response.credential);
                
                // إنشاء كائن المستخدم
                const user = {
                    uid: userData.sub,
                    email: userData.email,
                    name: userData.name || userData.email.split('@')[0],
                    points: 0,
                    totalEarned: 0,
                    referralEarnings: 0,
                    dailyStats: {},
                    adsWatchedToday: 0,
                    lastAdWatch: null,
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString(),
                    referralCode: generateReferralCode(),
                    referredBy: getReferralFromURL() || null,
                    membership: "free",
                    isAdmin: userData.email === 'bo2584668@gmail.com' ? true : false
                };
                
                console.log("تم تسجيل الدخول بنجاح للمستخدم:", user.email);
                
                // حفظ المستخدم في Firebase
                await saveUserToFirestore(user);
                
                // توجيه إلى الصفحة الرئيسية
                showDashboard();
                
            } catch (error) {
                console.error("حدث خطأ أثناء معالجة بيانات جوجل:", error);
                showNotification("حدث خطأ أثناء تسجيل الدخول. يرجى المحاولة مرة أخرى.", "error");
            }
        }
        
        // وظيفة فك تشفير JWT
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                
                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error("JWT Error:", error);
                return null;
            }
        }
        
        // حفظ المستخدم في Firestore
        async function saveUserToFirestore(user) {
            try {
                const userRef = db.collection('users').doc(user.uid);
                const doc = await userRef.get();
                
                if (!doc.exists) {
                    // مستخدم جديد
                    await userRef.set(user);
                    console.log("تم إنشاء مستخدم جديد:", user.email);
                    
                    // إذا كان المستخدم قد أتى عبر رابط إحالة
                    if (user.referredBy) {
                        await handleReferral(user.referredBy, user.uid);
                    }
                    
                    // إضافة 100 نقطة ترحيبية للمستخدم الجديد
                    await userRef.update({
                        points: firebase.firestore.FieldValue.increment(100)
                    });
                    
                    showNotification("مرحباً بك في أدفيستا! لقد حصلت على 100 نقطة ترحيبية.", "success");
                } else {
                    // تحديث آخر تسجيل دخول للمستخدم الحالي
                    await userRef.update({
                        lastLogin: new Date().toISOString()
                    });
                    console.log("تم تحديث آخر تسجيل دخول للمستخدم:", user.email);
                    
                    // تحميل عدد الإعلانات التي شاهدها اليوم
                    const userData = doc.data();
                    const today = new Date().toDateString();
                    const lastAdWatchDate = userData.lastAdWatch ? new Date(userData.lastAdWatch).toDateString() : null;
                    
                    if (lastAdWatchDate !== today) {
                        await userRef.update({
                            adsWatchedToday: 0
                        });
                    }
                }
                
                // تعيين المستخدم الحالي
                currentUser = user;
                const userDoc = await userRef.get();
                userData = userDoc.data();
                userData.uid = user.uid;
                
                // تحديث واجهة المستخدم
                updateUserUI();
                
                // إذا كان المستخدم هو الأدمن
                if (user.email === 'bo2584668@gmail.com') {
                    document.getElementById('adminTab').style.display = 'inline-block';
                    loadAdminData();
                }
                
                // تحميل عدد الإعلانات التي شاهدها اليوم
                adsWatchedToday = userData.adsWatchedToday || 0;
                document.getElementById('adsWatchedToday').textContent = adsWatchedToday;
                
            } catch (error) {
                console.error("خطأ في حفظ المستخدم:", error);
                showNotification("حدث خطأ في حفظ بيانات المستخدم.", "error");
            }
        }
        
        // توليد كود إحالة عشوائي
        function generateReferralCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        // الحصول على كود الإحالة من URL
        function getReferralFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('ref');
        }
        
        // معالجة الإحالة
        async function handleReferral(referralCode, newUserId) {
            try {
                // البحث عن المستخدم الذي له كود الإحالة هذا
                const usersRef = db.collection('users');
                const querySnapshot = await usersRef.where('referralCode', '==', referralCode).get();
                
                if (!querySnapshot.empty) {
                    const referrerDoc = querySnapshot.docs[0];
                    const referrerId = referrerDoc.id;
                    
                    // تسجيل الإحالة
                    await db.collection('referrals').add({
                        referrerId: referrerId,
                        refereeId: newUserId,
                        refereeEmail: currentUser.email,
                        timestamp: new Date().toISOString(),
                        status: 'active'
                    });
                    
                    // منح الأدمن 50 نقطة للإحالة الناجحة
                    await usersRef.doc(referrerId).update({
                        referralEarnings: firebase.firestore.FieldValue.increment(50),
                        points: firebase.firestore.FieldValue.increment(50)
                    });
                    
                    console.log("تم تسجيل إحالة ناجحة من:", referrerId, "إلى:", newUserId);
                    
                    // إشعار للمستخدم الذي قام بالإحالة
                    await db.collection('notifications').add({
                        userId: referrerId,
                        message: `لقد قام ${currentUser.email} بالتسجيل عبر رابط الإحالة الخاص بك!`,
                        timestamp: new Date().toISOString(),
                        read: false
                    });
                }
            } catch (error) {
                console.error("خطأ في معالجة الإحالة:", error);
            }
        }
        
        // عرض لوحة التحكم
        function showDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('userDashboard').style.display = 'block';
            
            // تحميل بيانات المستخدم والإعلانات
            loadUserData();
            loadAds();
            setupNavigation();
        }
        
        // تحديث واجهة المستخدم
        function updateUserUI() {
            if (userData) {
                document.getElementById('userPoints').textContent = userData.points || 0;
                document.getElementById('currentBalance').textContent = userData.points || 0;
                
                // حساب أرباح اليوم
                const today = new Date().toISOString().split('T')[0];
                const todayEarnings = userData.dailyStats && userData.dailyStats[today] ? userData.dailyStats[today] : 0;
                document.getElementById('todayEarnings').textContent = todayEarnings;
                
                document.getElementById('totalEarnings').textContent = userData.totalEarned || 0;
                document.getElementById('referralEarnings').textContent = userData.referralEarnings || 0;
                document.getElementById('referralEarningsTab').textContent = userData.referralEarnings || 0;
                
                // تحديث رابط الإحالة
                const referralLink = `${window.location.origin}${window.location.pathname}?ref=${userData.referralCode}`;
                document.getElementById('referralLink').textContent = referralLink;
                
                // تحديث صورة المستخدم
                const userAvatar = document.getElementById('userAvatar');
                userAvatar.innerHTML = `<i class="fas fa-user"></i>`;
                userAvatar.title = userData.name || userData.email;
                
                // إذا كان أدمن، عرض تبويب الإدارة
                if (userData.isAdmin) {
                    document.getElementById('adminTab').style.display = 'inline-block';
                }
            }
        }
        
        // تحميل بيانات المستخدم
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                const userRef = db.collection('users').doc(currentUser.uid);
                const doc = await userRef.get();
                
                if (doc.exists) {
                    userData = doc.data();
                    userData.uid = currentUser.uid;
                    updateUserUI();
                    
                    // تحميل سجل السحب
                    loadWithdrawalHistory();
                    
                    // تحميل إحصائيات الإحالات
                    loadReferralStats();
                    
                    // تحميل قائمة المحالين
                    loadReferralsList();
                }
            } catch (error) {
                console.error("خطأ في تحميل بيانات المستخدم:", error);
            }
        }
        
        // تحميل الإعلانات
        async function loadAds() {
            try {
                const adsRef = db.collection('ads');
                const querySnapshot = await adsRef.where('active', '==', true).get();
                
                ads = [];
                querySnapshot.forEach(doc => {
                    ads.push({ id: doc.id, ...doc.data() });
                });
                
                // إذا لم توجد إعلانات، إنشاء الإعلانات المطلوبة
                if (ads.length === 0) {
                    await createRequiredAds();
                    await loadAds(); // إعادة تحميل الإعلانات
                    return;
                }
                
                displayAds();
                
            } catch (error) {
                console.error("خطأ في تحميل الإعلانات:", error);
                // إنشاء إعلانات مطلوبة في حالة الخطأ
                await createRequiredAds();
                await loadAds();
            }
        }
        
        // إنشاء الإعلانات المطلوبة (45 من الرابط الأول، 25 من الرابط الثاني)
        async function createRequiredAds() {
            const linkjustAds = [];
            const otieuAds = [];
            
            // إنشاء 45 إعلان من الرابط الأول
            for (let i = 1; i <= 45; i++) {
                linkjustAds.push({
                    title: `إعلان LinkJust ${i}`,
                    description: `إعلان تجريبي من LinkJust - ${i}`,
                    link: "https://linkjust.com/xbTIX",
                    reward: Math.floor(Math.random() * 20) + 5, // 5-25 نقطة
                    duration: 30,
                    category: "عام",
                    source: "linkjust",
                    active: true,
                    clicks: 0,
                    createdAt: new Date().toISOString()
                });
            }
            
            // إنشاء 25 إعلان من الرابط الثاني
            for (let i = 1; i <= 25; i++) {
                otieuAds.push({
                    title: `إعلان Otiue ${i}`,
                    description: `إعلان تجريبي من Otiue - ${i}`,
                    link: "https://otieu.com/4/10528245",
                    reward: Math.floor(Math.random() * 30) + 10, // 10-40 نقطة
                    duration: 30,
                    category: "خاص",
                    source: "otieu",
                    active: true,
                    clicks: 0,
                    createdAt: new Date().toISOString()
                });
            }
            
            try {
                // إضافة إعلانات LinkJust
                for (const ad of linkjustAds) {
                    await saveAdToFirestore(ad);
                }
                
                // إضافة إعلانات Otiue
                for (const ad of otieuAds) {
                    await saveAdToFirestore(ad);
                }
                
                console.log("تم إنشاء 70 إعلان بنجاح (45 من LinkJust، 25 من Otiue)");
                showNotification("تم تحميل 70 إعلان جديد!", "success");
            } catch (error) {
                console.error("خطأ في إنشاء الإعلانات المطلوبة:", error);
            }
        }
        
        // حفظ الإعلان في Firestore
        async function saveAdToFirestore(adData) {
            try {
                const adsRef = db.collection('ads');
                
                await adsRef.add({
                    title: adData.title,        // نص الزرار
                    description: adData.description || '', // وصف تحت الزرار (اختياري)
                    link: adData.link,          // الرابط المرتبط بالزرار
                    reward: adData.reward || 10,
                    duration: adData.duration || 30,
                    category: adData.category || "عام",
                    source: adData.source || "custom",
                    active: true,
                    clicks: 0,
                    createdAt: new Date().toISOString()
                });
                
                console.log("تم حفظ الإعلان بنجاح.");
                return true;
            } catch (error) {
                console.error("خطأ في حفظ الإعلان:", error);
                return false;
            }
        }
        
        // عرض الإعلانات
        function displayAds() {
            const adsContainer = document.getElementById('adsContainer');
            const availableAds = document.getElementById('availableAds');
            
            if (!adsContainer || !availableAds) return;
            
            // تفريغ الحاويات
            adsContainer.innerHTML = '';
            availableAds.innerHTML = '';
            
            // فصل الإعلانات حسب المصدر
            const linkjustAds = ads.filter(ad => ad.source === 'linkjust').slice(0, 45);
            const otieuAds = ads.filter(ad => ad.source === 'otieu').slice(0, 25);
            
            // عرض الإعلانات
            let adIndex = 0;
            
            // عرض إعلانات LinkJust أولاً (45 إعلان)
            linkjustAds.forEach((ad, index) => {
                const adElement = createAdElement(ad, adIndex);
                adsContainer.appendChild(adElement);
                adIndex++;
                
                // للإعلانات المتاحة في لوحة التحكم (عرض 5 فقط)
                if (index < 5) {
                    availableAds.appendChild(adElement.cloneNode(true));
                }
            });
            
            // ثم عرض إعلانات Otiue (25 إعلان)
            otieuAds.forEach((ad, index) => {
                const adElement = createAdElement(ad, adIndex);
                adsContainer.appendChild(adElement);
                adIndex++;
            });
            
            // إذا كان المستخدم قد شاهد 25 إعلانًا اليوم، إضافة رسالة الانتظار
            if (adsWatchedToday >= 25) {
                const waitMessage = document.createElement('div');
                waitMessage.className = 'ad-item';
                waitMessage.innerHTML = `
                    <div class="ad-info">
                        <h3>إعلانات إضافية</h3>
                        <p>لقد شاهدت ${adsWatchedToday} إعلان اليوم</p>
                        <p class="ad-timer">يجب الانتظار 24 ساعة لمشاهدة المزيد من الإعلانات</p>
                    </div>
                    <button class="btn" disabled>
                        <i class="fas fa-clock"></i> انتظر 24 ساعة
                    </button>
                `;
                adsContainer.appendChild(waitMessage);
            }
        }
        
        // إنشاء عنصر إعلان
        function createAdElement(ad, index) {
            const div = document.createElement('div');
            div.className = 'ad-item';
            
            // تحديد إذا كان الإعلان متاحًا للمشاهدة
            const isAvailable = index < 25 && adsWatchedToday < 25;
            const buttonText = isAvailable ? 'مشاهدة الإعلان' : 'غير متاح';
            
            div.innerHTML = `
                <div class="ad-info">
                    <h3>${ad.title}</h3>
                    <p>${ad.description || ''}</p>
                    <p class="ad-reward"><i class="fas fa-coins"></i> ${ad.reward} نقطة</p>
                    <p class="ad-timer"><i class="fas fa-clock"></i> ${ad.duration} ثانية</p>
                </div>
                <button class="btn" onclick="viewAd('${ad.id}', ${index})" ${!isAvailable ? 'disabled' : ''}>
                    <i class="fas fa-play"></i> ${buttonText}
                </button>
            `;
            return div;
        }
        
        // مشاهدة الإعلان
        async function viewAd(adId, adIndex) {
            // التحقق من عدد الإعلانات التي شاهدها اليوم
            if (adsWatchedToday >= 25) {
                showNotification("لقد وصلت للحد الأقصى للإعلانات اليوم (25 إعلان). يجب الانتظار 24 ساعة.", "warning");
                return;
            }
            
            // التحقق من أن الإعلان ضمن أول 25 إعلان
            if (adIndex >= 25) {
                showNotification("يجب مشاهدة الإعلانات بالترتيب. هذا الإعلان غير متاح الآن.", "warning");
                return;
            }
            
            currentAd = ads.find(ad => ad.id === adId);
            if (!currentAd) return;
            
            // عرض نافذة الإعلان
            document.getElementById('adModal').style.display = 'flex';
            document.getElementById('adModalTitle').textContent = currentAd.title;
            document.getElementById('adDurationDisplay').textContent = currentAd.duration;
            document.getElementById('adTimer').textContent = currentAd.duration;
            
            // عرض محتوى الإعلان
            document.getElementById('adDisplayTitle').textContent = currentAd.title;
            document.getElementById('adDisplayDescription').textContent = currentAd.description || 'شاهد هذا الإعلان لمدة 30 ثانية لتحصل على النقاط';
            
            // إخفاء زر الإكمال في البداية
            document.getElementById('completeAdBtn').style.display = 'none';
            
            // بدء العداد
            timeLeft = currentAd.duration;
            adCompleted = false;
            
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('adTimer').textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    adCompleted = true;
                    // إظهار زر الإكمال
                    document.getElementById('completeAdBtn').style.display = 'inline-block';
                }
            }, 1000);
        }
        
        // إكمال مشاهدة الإعلان
        async function completeAd() {
            if (!adCompleted || timeLeft > 0) {
                showNotification("يجب الانتظار حتى انتهاء الوقت!", "warning");
                return;
            }
            
            // منح النقاط
            await addPoints(currentAd.reward);
            
            // تسجيل النقرة
            await recordAdClick();
            
            // تحديث عدد الإعلانات التي شاهدها اليوم
            await updateAdsWatchedToday();
            
            // إغلاق النافذة
            closeAdModal();
            
            showNotification(`مبروك! لقد ربحت ${currentAd.reward} نقطة من مشاهدة الإعلان.`, "success");
        }
        
        // إغلاق نافذة الإعلان
        function closeAdModal() {
            // إذا لم يكتمل الإعلان وكان الوقت أقل من المدة المطلوبة
            if (!adCompleted && timeLeft > 0) {
                // خصم 5 نقاط
                deductPoints(5);
                showNotification("تم خصم 5 نقاط لأنك غادرت قبل انتهاء وقت الإعلان!", "error");
            }
            
            // إعادة تعيين المتغيرات
            document.getElementById('adModal').style.display = 'none';
            
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            currentAd = null;
        }
        
        // خصم النقاط
        async function deductPoints(points) {
            if (!currentUser) return;
            
            try {
                const userRef = db.collection('users').doc(currentUser.uid);
                await userRef.update({
                    points: firebase.firestore.FieldValue.increment(-points)
                });
                
                // تحديث واجهة المستخدم
                userData.points -= points;
                updateUserUI();
                
            } catch (error) {
                console.error("خطأ في خصم النقاط:", error);
            }
        }
        
        // إضافة النقاط
        async function addPoints(points) {
            if (!currentUser) return;
            
            try {
                const userRef = db.collection('users').doc(currentUser.uid);
                const today = new Date().toISOString().split('T')[0];
                
                // تحديث النقاط
                await userRef.update({
                    points: firebase.firestore.FieldValue.increment(points),
                    totalEarned: firebase.firestore.FieldValue.increment(points),
                    [`dailyStats.${today}`]: firebase.firestore.FieldValue.increment(points)
                });
                
                // تحديث واجهة المستخدم
                userData.points += points;
                userData.totalEarned += points;
                
                // تحديث أرباح اليوم
                if (!userData.dailyStats) userData.dailyStats = {};
                userData.dailyStats[today] = (userData.dailyStats[today] || 0) + points;
                
                updateUserUI();
                
            } catch (error) {
                console.error("خطأ في إضافة النقاط:", error);
            }
        }
        
        // تسجيل نقرة على الإعلان
        async function recordAdClick() {
            if (!currentUser || !currentAd) return;
            
            try {
                await db.collection('clicks').add({
                    userId: currentUser.uid,
                    adId: currentAd.id,
                    timestamp: new Date().toISOString(),
                    pointsEarned: currentAd.reward,
                    completed: true
                });
                
                // تحديث عدد النقرات على الإعلان
                const adRef = db.collection('ads').doc(currentAd.id);
                await adRef.update({
                    clicks: firebase.firestore.FieldValue.increment(1)
                });
                
            } catch (error) {
                console.error("خطأ في تسجيل النقرة:", error);
            }
        }
        
        // تحديث عدد الإعلانات التي شاهدها اليوم
        async function updateAdsWatchedToday() {
            if (!currentUser) return;
            
            try {
                const userRef = db.collection('users').doc(currentUser.uid);
                await userRef.update({
                    adsWatchedToday: firebase.firestore.FieldValue.increment(1),
                    lastAdWatch: new Date().toISOString()
                });
                
                // تحديث العداد المحلي
                adsWatchedToday++;
                userData.adsWatchedToday = adsWatchedToday;
                document.getElementById('adsWatchedToday').textContent = adsWatchedToday;
                
                // إعادة تحميل الإعلانات لتحديث حالة الأزرار
                displayAds();
                
            } catch (error) {
                console.error("خطأ في تحديث عدد الإعلانات:", error);
            }
        }
        
        // نسخ رابط الإحالة
        function copyReferralLink() {
            const referralLink = document.getElementById('referralLink').textContent;
            navigator.clipboard.writeText(referralLink)
                .then(() => {
                    showNotification("تم نسخ رابط الإحالة بنجاح!", "success");
                })
                .catch(err => {
                    console.error('خطأ في النسخ: ', err);
                    showNotification("فشل نسخ الرابط. حاول مرة أخرى.", "error");
                });
        }
        
        // تحميل إحصائيات الإحالات
        async function loadReferralStats() {
            if (!currentUser) return;
            
            try {
                const referralsRef = db.collection('referrals');
                const querySnapshot = await referralsRef.where('referrerId', '==', currentUser.uid).get();
                
                const totalReferrals = querySnapshot.size;
                let activeReferrals = 0;
                
                document.getElementById('totalReferrals').textContent = totalReferrals;
                document.getElementById('activeReferrals').textContent = activeReferrals;
                
            } catch (error) {
                console.error("خطأ في تحميل إحصائيات الإحالات:", error);
            }
        }
        
        // تحميل قائمة المحالين
        async function loadReferralsList() {
            if (!currentUser) return;
            
            try {
                const referralsRef = db.collection('referrals');
                const querySnapshot = await referralsRef.where('referrerId', '==', currentUser.uid).get();
                
                const tbody = document.getElementById('referralsList').getElementsByTagName('tbody')[0];
                tbody.innerHTML = '';
                
                if (querySnapshot.empty) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align: center;">لا توجد إحالات حتى الآن</td>
                        </tr>
                    `;
                    return;
                }
                
                for (const doc of querySnapshot.docs) {
                    const referral = doc.data();
                    const userRef = db.collection('users').doc(referral.refereeId);
                    const userDoc = await userRef.get();
                    
                    let userEmail = 'مستخدم غير معروف';
                    let userCreatedAt = 'غير معروف';
                    let userStatus = 'غير نشط';
                    let userEarnings = 0;
                    
                    if (userDoc.exists) {
                        const user = userDoc.data();
                        userEmail = user.email;
                        userCreatedAt = new Date(user.createdAt).toLocaleDateString('ar-EG');
                        
                        // تحديد حالة الحساب (آخر تسجيل دخول خلال 7 أيام)
                        const lastLogin = user.lastLogin ? new Date(user.lastLogin) : new Date(user.createdAt);
                        const weekAgo = new Date();
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        
                        userStatus = lastLogin > weekAgo ? 'نشط' : 'غير نشط';
                        
                        // حساب الأرباح المولدة (10% من إجمالي أرباح المحال)
                        userEarnings = Math.floor((user.totalEarned || 0) * 0.1);
                    }
                    
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${userEmail}</td>
                        <td>${userCreatedAt}</td>
                        <td>${userStatus}</td>
                        <td>${userEarnings} نقطة</td>
                    `;
                }
                
            } catch (error) {
                console.error("خطأ في تحميل قائمة المحالين:", error);
            }
        }
        
        // تحميل سجل السحب
        async function loadWithdrawalHistory() {
            if (!currentUser) return;
            
            try {
                const withdrawalsRef = db.collection('withdrawals');
                const querySnapshot = await withdrawalsRef.where('userId', '==', currentUser.uid).orderBy('timestamp', 'desc').get();
                
                const tbody = document.getElementById('withdrawalHistory');
                tbody.innerHTML = '';
                
                if (querySnapshot.empty) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center;">لا توجد طلبات سحب سابقة</td>
                        </tr>
                    `;
                    return;
                }
                
                querySnapshot.forEach(doc => {
                    const withdrawal = doc.data();
                    const date = new Date(withdrawal.timestamp).toLocaleDateString('ar-EG');
                    // 30,000 نقطة = 1 دولار
                    const amountInDollars = (withdrawal.amount / 30000).toFixed(2);
                    
                    let statusClass = '';
                    let statusText = '';
                    
                    switch (withdrawal.status) {
                        case 'pending':
                            statusClass = 'status-pending';
                            statusText = 'قيد المراجعة';
                            break;
                        case 'approved':
                            statusClass = 'status-approved';
                            statusText = 'تم الموافقة';
                            break;
                        case 'rejected':
                            statusClass = 'status-rejected';
                            statusText = 'مرفوض';
                            break;
                    }
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${date}</td>
                        <td>${withdrawal.amount} نقطة</td>
                        <td>${amountInDollars} دولار</td>
                        <td>${withdrawal.vodafoneNumber}</td>
                        <td class="${statusClass}">${statusText}</td>
                    `;
                    tbody.appendChild(row);
                });
                
            } catch (error) {
                console.error("خطأ في تحميل سجل السحب:", error);
            }
        }
        
        // تحديث مبلغ الدولار في تبويب السحب
        function updateDollarAmount() {
            const points = parseInt(document.getElementById('withdrawalAmount').value) || 0;
            // 30,000 نقطة = 1 دولار
            const dollars = (points / 30000).toFixed(2);
            document.getElementById('dollarAmount').textContent = dollars;
        }
        
        // طلب سحب
        async function requestWithdrawal() {
            if (!currentUser) return;
            
            const vodafoneNumber = document.getElementById('vodafoneNumber').value;
            const amount = parseInt(document.getElementById('withdrawalAmount').value);
            
            // التحقق من صحة البيانات
            if (!vodafoneNumber || !vodafoneNumber.match(/^01[0-9]{9}$/)) {
                showNotification("رقم فودافون غير صحيح. يجب أن يكون 11 رقمًا ويبدأ بـ 01.", "error");
                return;
            }
            
            // 30,000 نقطة = 1 دولار
            if (amount < 30000) {
                showNotification("الحد الأدنى للسحب هو 30,000 نقطة (1 دولار).", "error");
                return;
            }
            
            if (amount > (userData.points || 0)) {
                showNotification("رصيدك غير كافي للسحب.", "error");
                return;
            }
            
            try {
                // إنشاء طلب السحب
                const withdrawalRef = await db.collection('withdrawals').add({
                    userId: currentUser.uid,
                    userEmail: userData.email,
                    vodafoneNumber: vodafoneNumber,
                    amount: amount,
                    status: 'pending',
                    timestamp: new Date().toISOString()
                });
                
                // خصم النقاط من رصيد المستخدم
                const userRef = db.collection('users').doc(currentUser.uid);
                await userRef.update({
                    points: firebase.firestore.FieldValue.increment(-amount)
                });
                
                // تحديث واجهة المستخدم
                userData.points -= amount;
                updateUserUI();
                
                // إرسال إشعار للأدمن
                await sendAdminNotification(`طلب سحب جديد من ${userData.email} بمبلغ ${amount} نقطة (${(amount/30000).toFixed(2)} دولار) إلى رقم ${vodafoneNumber}`);
                
                // إعادة تعيين النموذج
                document.getElementById('vodafoneNumber').value = '';
                document.getElementById('withdrawalAmount').value = '';
                document.getElementById('dollarAmount').textContent = '0';
                
                showNotification("تم إرسال طلب السحب بنجاح. سيتم مراجعته من قبل الإدارة.", "success");
                
                // تحديث سجل السحب
                loadWithdrawalHistory();
                
            } catch (error) {
                console.error("خطأ في طلب السحب:", error);
                showNotification("حدث خطأ أثناء إرسال طلب السحب. حاول مرة أخرى.", "error");
            }
        }
        
        // إرسال إشعار للأدمن
        async function sendAdminNotification(message) {
            try {
                await db.collection('notifications').add({
                    type: 'withdrawal_request',
                    message: message,
                    timestamp: new Date().toISOString(),
                    read: false,
                    adminEmail: 'bo2584668@gmail.com'
                });
            } catch (error) {
                console.error("خطأ في إرسال إشعار الأدمن:", error);
            }
        }
        
        // تحميل بيانات الأدمن
        async function loadAdminData() {
            try {
                // إحصائيات الموقع
                const usersSnapshot = await db.collection('users').get();
                const adsSnapshot = await db.collection('ads').get();
                const clicksSnapshot = await db.collection('clicks').get();
                const withdrawalsSnapshot = await db.collection('withdrawals').get();
                
                document.getElementById('totalUsers').textContent = usersSnapshot.size;
                document.getElementById('totalAds').textContent = adsSnapshot.size;
                document.getElementById('totalClicks').textContent = clicksSnapshot.size;
                document.getElementById('totalWithdrawals').textContent = withdrawalsSnapshot.size;
                
                // طلبات السحب المعلقة
                const pendingWithdrawals = await db.collection('withdrawals').where('status', '==', 'pending').get();
                const pendingTable = document.getElementById('pendingWithdrawalsTable').getElementsByTagName('tbody')[0];
                pendingTable.innerHTML = '';
                
                if (pendingWithdrawals.empty) {
                    pendingTable.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center;">لا توجد طلبات سحب معلقة</td>
                        </tr>
                    `;
                } else {
                    for (const doc of pendingWithdrawals.docs) {
                        const withdrawal = doc.data();
                        const userDoc = await db.collection('users').doc(withdrawal.userId).get();
                        const userName = userDoc.exists ? userDoc.data().email : 'مستخدم غير معروف';
                        const date = new Date(withdrawal.timestamp).toLocaleDateString('ar-EG');
                        // 30,000 نقطة = 1 دولار
                        const amountInDollars = (withdrawal.amount / 30000).toFixed(2);
                        
                        const row = pendingTable.insertRow();
                        row.innerHTML = `
                            <td>${userName}</td>
                            <td>${withdrawal.vodafoneNumber}</td>
                            <td>${withdrawal.amount} نقطة</td>
                            <td>${amountInDollars} دولار</td>
                            <td>${date}</td>
                            <td>
                                <button class="btn btn-success" onclick="approveWithdrawal('${doc.id}')">
                                    <i class="fas fa-check"></i> قبول
                                </button>
                                <button class="btn btn-danger" onclick="rejectWithdrawal('${doc.id}')">
                                    <i class="fas fa-times"></i> رفض
                                </button>
                            </td>
                        `;
                    }
                }
                
                // إدارة الإعلانات
                const adsTable = document.getElementById('adsManagementTable').getElementsByTagName('tbody')[0];
                adsTable.innerHTML = '';
                
                if (adsSnapshot.empty) {
                    adsTable.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center;">لا توجد إعلانات</td>
                        </tr>
                    `;
                } else {
                    for (const doc of adsSnapshot.docs) {
                        const ad = doc.data();
                        const row = adsTable.insertRow();
                        row.innerHTML = `
                            <td>${ad.title}</td>
                            <td>${ad.description ? ad.description.substring(0, 30) + (ad.description.length > 30 ? '...' : '') : 'لا يوجد وصف'}</td>
                            <td><a href="${ad.link}" target="_blank">${ad.link.substring(0, 20)}...</a></td>
                            <td>${ad.reward}</td>
                            <td>${ad.duration} ثانية</td>
                            <td>
                                <button class="btn btn-danger" onclick="deleteAd('${doc.id}')">
                                    <i class="fas fa-trash"></i> حذف
                                </button>
                            </td>
                        `;
                    }
                }
                
            } catch (error) {
                console.error("خطأ في تحميل بيانات الأدمن:", error);
            }
        }
        
        // الموافقة على طلب السحب
        async function approveWithdrawal(withdrawalId) {
            try {
                await db.collection('withdrawals').doc(withdrawalId).update({
                    status: 'approved',
                    approvedAt: new Date().toISOString()
                });
                
                showNotification("تم قبول طلب السحب بنجاح.", "success");
                loadAdminData();
                
            } catch (error) {
                console.error("خطأ في قبول طلب السحب:", error);
                showNotification("حدث خطأ أثناء قبول طلب السحب.", "error");
            }
        }
        
        // رفض طلب السحب
        async function rejectWithdrawal(withdrawalId) {
            try {
                const withdrawalDoc = await db.collection('withdrawals').doc(withdrawalId).get();
                const withdrawal = withdrawalDoc.data();
                
                // إعادة النقاط للمستخدم
                await db.collection('users').doc(withdrawal.userId).update({
                    points: firebase.firestore.FieldValue.increment(withdrawal.amount)
                });
                
                // تحديث حالة السحب
                await db.collection('withdrawals').doc(withdrawalId).update({
                    status: 'rejected',
                    rejectedAt: new Date().toISOString()
                });
                
                showNotification("تم رفض طلب السحب وإعادة النقاط للمستخدم.", "success");
                loadAdminData();
                
            } catch (error) {
                console.error("خطأ في رفض طلب السحب:", error);
                showNotification("حدث خطأ أثناء رفض طلب السحب.", "error");
            }
        }
        
        // حذف إعلان
        async function deleteAd(adId) {
            if (confirm("هل أنت متأكد من حذف هذا الإعلان؟")) {
                try {
                    await db.collection('ads').doc(adId).delete();
                    showNotification("تم حذف الإعلان بنجاح.", "success");
                    loadAdminData();
                    loadAds(); // تحديث الإعلانات للمستخدمين
                } catch (error) {
                    console.error("خطأ في حذف الإعلان:", error);
                    showNotification("حدث خطأ أثناء حذف الإعلان.", "error");
                }
            }
        }
        
        // إضافة إعلان جديد (للأدمن)
        async function addNewAd() {
            const title = document.getElementById('adTitle').value;
            const description = document.getElementById('adDescription').value;
            const link = document.getElementById('adLink').value;
            const reward = parseInt(document.getElementById('adReward').value);
            const duration = parseInt(document.getElementById('adDuration').value);
            
            if (!title || !link) {
                showNotification("يرجى ملء عنوان الإعلان والرابط.", "error");
                return;
            }
            
            if (reward < 1) {
                showNotification("عدد النقاط يجب أن يكون على الأقل 1.", "error");
                return;
            }
            
            if (duration < 10) {
                showNotification("مدة الإعلان يجب أن تكون على الأقل 10 ثواني.", "error");
                return;
            }
            
            try {
                // استخدام دالة saveAdToFirestore التي طلبتها
                const success = await saveAdToFirestore({
                    title: title,
                    description: description,
                    link: link,
                    reward: reward,
                    duration: duration,
                    category: "إعلان من الإدارة",
                    source: "admin"
                });
                
                if (success) {
                    // إعادة تعيين النموذج
                    document.getElementById('adTitle').value = '';
                    document.getElementById('adDescription').value = '';
                    document.getElementById('adLink').value = '';
                    document.getElementById('adReward').value = '10';
                    document.getElementById('adDuration').value = '30';
                    
                    showNotification("تم نشر الإعلان الجديد بنجاح.", "success");
                    loadAdminData();
                    loadAds();
                } else {
                    showNotification("حدث خطأ أثناء نشر الإعلان.", "error");
                }
                
            } catch (error) {
                console.error("خطأ في إضافة الإعلان:", error);
                showNotification("حدث خطأ أثناء إضافة الإعلان.", "error");
            }
        }
        
        // إعداد التنقل بين التبويبات
        function setupNavigation() {
            const tabs = document.querySelectorAll('.nav-tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    // إزالة النشاط من جميع التبويبات
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(tc => tc.classList.remove('active'));
                    
                    // إضافة النشاط للتبويب المحدد
                    tab.classList.add('active');
                    document.getElementById(`${tabId}Tab`).classList.add('active');
                    
                    // إذا كان تبويب السحب، تحديث مبلغ الدولار
                    if (tabId === 'withdrawal') {
                        updateDollarAmount();
                    }
                    
                    // إذا كان تبويب الإدارة وكان المستخدم أدمن
                    if (tabId === 'admin' && userData && userData.isAdmin) {
                        loadAdminData();
                    }
                });
            });
        }
        
        // تبديل قائمة المستخدم
        function toggleUserMenu() {
            showNotification(`مرحباً ${userData.name || userData.email}`, "success");
        }
        
        // عرض الإشعارات
        function showNotification(message, type = "info") {
            const notification = document.getElementById('notification');
            const messageElement = document.getElementById('notificationMessage');
            
            messageElement.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }
        
        // تهيئة الموقع عند التحميل
        document.addEventListener('DOMContentLoaded', function() {
            initializeGoogleSignIn();
            
            // التحقق مما إذا كان المستخدم مسجل الدخول بالفعل
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // المستخدم مسجل الدخول بالفعل
                    currentUser = {
                        uid: user.uid,
                        email: user.email
                    };
                    
                    // تحميل بيانات المستخدم
                    const userRef = db.collection('users').doc(user.uid);
                    const doc = await userRef.get();
                    
                    if (doc.exists) {
                        userData = doc.data();
                        userData.uid = user.uid;
                        
                        showDashboard();
                        
                        // إذا كان المستخدم هو الأدمن
                        if (userData.isAdmin) {
                            document.getElementById('adminTab').style.display = 'inline-block';
                        }
                    }
                }
            });
            
            // منع التكبير والتصغير
            document.addEventListener('touchstart', function(event) {
                if (event.touches.length > 1) {
                    event.preventDefault();
                }
            }, { passive: false });
            
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
            // منع نسخ النص عدا النصوص المسموح بها
            document.addEventListener('copy', function(e) {
                const selectedText = window.getSelection().toString();
                const isAllowed = e.target.classList.contains('referral-text') || 
                                 e.target.classList.contains('withdrawal-text') ||
                                 e.target.id === 'referralLink' ||
                                 e.target.id === 'vodafoneNumber' ||
                                 e.target.id === 'withdrawalAmount';
                
                if (!isAllowed && selectedText.length > 0) {
                    e.preventDefault();
                    showNotification("نسخ النص غير مسموح به في هذا الموقع.", "warning");
                }
            });
            
            // إعداد تحديث مبلغ الدولار في تبويب السحب
            document.getElementById('withdrawalAmount').addEventListener('input', updateDollarAmount);
        });
    </script>
</body>
</html>
