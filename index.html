<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ادفيستا - ربح النقاط من الإعلانات</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.8rem;
            color: white !important;
        }
        
        .nav-link {
            color: rgba(255, 255, 255, 0.9) !important;
            font-weight: 500;
            transition: all 0.3s;
            margin: 0 5px;
        }
        
        .nav-link:hover {
            color: white !important;
            transform: translateY(-2px);
        }
        
        .user-info {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50px;
            padding: 5px 15px;
        }
        
        .user-points {
            color: #f1c40f;
            font-weight: bold;
        }
        
        .main-container {
            min-height: calc(100vh - 200px);
            padding: 30px 0;
        }
        
        .dashboard-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s, box-shadow 0.3s;
            height: 100%;
            border: none;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
        }
        
        .card-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            margin-bottom: 20px;
        }
        
        .points-card .card-icon {
            background-color: rgba(52, 152, 219, 0.15);
            color: var(--secondary-color);
        }
        
        .tasks-card .card-icon {
            background-color: rgba(46, 204, 113, 0.15);
            color: var(--success-color);
        }
        
        .withdraw-card .card-icon {
            background-color: rgba(155, 89, 182, 0.15);
            color: #9b59b6;
        }
        
        .stats-card .card-icon {
            background-color: rgba(241, 196, 15, 0.15);
            color: var(--warning-color);
        }
        
        .card-title {
            font-weight: 700;
            color: var(--dark-color);
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .card-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .card-unit {
            font-size: 1rem;
            color: #7f8c8d;
            margin-right: 5px;
        }
        
        .ads-container {
            margin-top: 30px;
        }
        
        .section-title {
            color: var(--primary-color);
            font-weight: 700;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--secondary-color);
            display: inline-block;
        }
        
        .ad-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s;
            margin-bottom: 25px;
            border: none;
        }
        
        .ad-card:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
            transform: translateY(-3px);
        }
        
        .ad-header {
            background: linear-gradient(to right, #3498db, #2c3e50);
            color: white;
            padding: 15px;
        }
        
        .ad-title {
            font-weight: 600;
            font-size: 1.2rem;
            margin: 0;
        }
        
        .ad-body {
            padding: 20px;
        }
        
        .ad-duration, .ad-points {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .ad-duration i, .ad-points i {
            width: 25px;
            color: var(--secondary-color);
        }
        
        .btn-view-ad {
            background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
            margin-top: 15px;
        }
        
        .btn-view-ad:hover {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-view-ad:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        
        .timer-container {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-top: 20px;
            border: 2px dashed #dee2e6;
        }
        
        .timer {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-color);
            margin: 15px 0;
        }
        
        .timer-message {
            color: #7f8c8d;
            margin-bottom: 15px;
        }
        
        .captcha-container {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-top: 20px;
            border: 2px dashed #dee2e6;
        }
        
        .captcha-box {
            background-color: white;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            font-size: 1.8rem;
            letter-spacing: 5px;
            font-weight: bold;
            color: #2c3e50;
            margin: 15px 0;
            user-select: none;
        }
        
        .captcha-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            text-align: center;
            font-size: 1.2rem;
            margin-bottom: 15px;
        }
        
        .btn-verify {
            background-color: var(--success-color);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-verify:hover {
            background-color: #219653;
            transform: translateY(-2px);
        }
        
        .footer {
            background-color: var(--primary-color);
            color: white;
            padding: 40px 0 20px;
            margin-top: 60px;
        }
        
        .footer h5 {
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--light-color);
        }
        
        .footer-links li {
            margin-bottom: 10px;
        }
        
        .footer-links a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .footer-links a:hover {
            color: white;
            text-decoration: underline;
        }
        
        .social-icons a {
            display: inline-block;
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            text-align: center;
            line-height: 40px;
            margin-right: 10px;
            color: white;
            transition: all 0.3s;
        }
        
        .social-icons a:hover {
            background-color: var(--secondary-color);
            transform: translateY(-3px);
        }
        
        .copyright {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 20px;
            margin-top: 30px;
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
        }
        
        /* واجهة الإدمن */
        .admin-panel {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        
        .admin-sidebar {
            background-color: var(--primary-color);
            color: white;
            min-height: 100vh;
            padding: 0;
        }
        
        .admin-header {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 20px;
            text-align: center;
        }
        
        .admin-menu {
            list-style: none;
            padding: 0;
        }
        
        .admin-menu li {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .admin-menu a {
            color: white;
            display: block;
            padding: 15px 20px;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .admin-menu a:hover, .admin-menu a.active {
            background-color: var(--secondary-color);
            padding-right: 30px;
        }
        
        .admin-content {
            padding: 30px;
        }
        
        .admin-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }
        
        /* صفحة تسجيل الدخول */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            padding: 20px;
        }
        
        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 450px;
            text-align: center;
        }
        
        .login-logo {
            font-size: 3rem;
            color: var(--secondary-color);
            margin-bottom: 20px;
        }
        
        .login-title {
            color: var(--primary-color);
            font-weight: 700;
            margin-bottom: 30px;
        }
        
        .login-subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
        }
        
        .login-info {
            background-color: #e8f4fc;
            border-radius: 10px;
            padding: 15px;
            color: var(--primary-color);
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        /* تخصيص زر جوجل */
        #buttonDiv {
            margin: 20px auto;
            display: flex;
            justify-content: center;
            width: 100%;
            max-width: 400px;
        }
        
        #buttonDiv > div {
            width: 100% !important;
            border-radius: 15px !important;
            overflow: hidden !important;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1) !important;
        }
        
        /* تحسينات للجوال */
        @media (max-width: 768px) {
            .card-value {
                font-size: 1.8rem;
            }
            
            .timer {
                font-size: 2rem;
            }
            
            .navbar-brand {
                font-size: 1.4rem;
            }
            
            .login-card {
                padding: 30px 20px;
            }
            
            #buttonDiv {
                max-width: 300px;
            }
        }
        
        /* رسائل التنبيه */
        .alert-custom {
            border-radius: 10px;
            border: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        /* تخصيص Bootstrap */
        .btn-primary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }
        
        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            border-color: var(--warning-color);
        }
        
        .btn-danger {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        
        .table th {
            background-color: var(--primary-color);
            color: white;
        }
        
        /* تصميم قسم العقوبات */
        .penalty-badge {
            background-color: var(--accent-color);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        
        /* تحسينات للواجهة */
        .progress-bar-custom {
            background-color: var(--secondary-color);
        }
        
        .login-page {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            padding: 20px;
        }
    </style>
</head>
<body>
    <!-- صفحة تسجيل الدخول -->
    <div id="loginPage" class="login-page">
        <div class="login-card">
            <div class="login-logo">
                <i class="fas fa-ad"></i>
            </div>
            <h1 class="login-title">ادفيستا</h1>
            <p class="login-subtitle">منصة ربح النقاط الأولى من خلال مشاهدة الإعلانات</p>
            
            <!-- زر جوجل الجديد -->
            <div id="buttonDiv" class="mb-4"></div>
            
            <div class="login-info">
                <i class="fas fa-info-circle"></i>
                يجب أن يكون حسابك على جوجل مفعل لدخول الموقع
            </div>
            
            <hr class="my-4">
            
            <h5 class="fw-bold mb-3">تواصل مع الإدارة</h5>
            <div class="social-icons d-flex justify-content-center mb-4">
                <a href="https://wa.me/201273740256" target="_blank" title="واتساب">
                    <i class="fab fa-whatsapp"></i>
                </a>
                <a href="https://www.instagram.com/Baraa___offical" target="_blank" title="انستجرام">
                    <i class="fab fa-instagram"></i>
                </a>
                <a href="https://www.tiktok.com/@Baraa_offical" target="_blank" title="تيك توك">
                    <i class="fab fa-tiktok"></i>
                </a>
                <a href="https://www.facebook.com/baraa_omar_talaat" target="_blank" title="فيسبوك">
                    <i class="fab fa-facebook-f"></i>
                </a>
            </div>
            
            <div class="mt-4">
                <small class="text-muted">الإدمن: bo2584668@gmail.com</small>
            </div>
        </div>
    </div>

    <!-- صفحة المستخدم الرئيسية (مخفية حتى تسجيل الدخول) -->
    <div id="userPage" style="display: none;">
        <!-- شريط التنقل -->
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
                <a class="navbar-brand" href="#">
                    <i class="fas fa-ad me-2"></i>ادفيستا
                </a>
                
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                                <i class="fas fa-home me-1"></i> الرئيسية
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('ads')">
                                <i class="fas fa-ad me-1"></i> الإعلانات
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('withdraw')">
                                <i class="fas fa-wallet me-1"></i> السحوبات
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('history')">
                                <i class="fas fa-history me-1"></i> التاريخ
                            </a>
                        </li>
                    </ul>
                    
                    <div class="d-flex align-items-center">
                        <div class="user-info me-3">
                            <span class="me-2" id="userName">أهلاً، </span>
                            <span class="user-points">
                                <i class="fas fa-coins me-1"></i> <span id="userPoints">0</span>
                            </span>
                        </div>
                        
                        <div class="dropdown">
                            <button class="btn btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle me-1"></i> الحساب
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" onclick="showSection('profile')"><i class="fas fa-user me-2"></i> الملف الشخصي</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showSection('settings')"><i class="fas fa-cog me-2"></i> الإعدادات</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="signOut()"><i class="fas fa-sign-out-alt me-2"></i> تسجيل الخروج</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- المحتوى الرئيسي -->
        <div class="container main-container">
            <!-- قسم الرئيسية -->
            <div id="dashboardSection">
                <div class="row mb-4">
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="dashboard-card points-card">
                            <div class="card-icon">
                                <i class="fas fa-coins"></i>
                            </div>
                            <h5 class="card-title">رصيد النقاط</h5>
                            <div class="card-value">
                                <span class="card-unit">نقطة</span><span id="totalPoints">0</span>
                            </div>
                            <p class="text-muted mt-2" id="pointsInDollars">ما يعادل: 0 دولار</p>
                        </div>
                    </div>
                    
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="dashboard-card tasks-card">
                            <div class="card-icon">
                                <i class="fas fa-tasks"></i>
                            </div>
                            <h5 class="card-title">المهام اليومية</h5>
                            <div class="card-value">
                                <span class="card-unit">مهمة</span><span id="dailyTasks">0</span>/20
                            </div>
                            <p class="text-muted mt-2">النقاط اليومية: <span id="dailyPoints">0</span></p>
                        </div>
                    </div>
                    
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="dashboard-card withdraw-card">
                            <div class="card-icon">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <h5 class="card-title">السحوبات</h5>
                            <div class="card-value">
                                <span class="card-unit">مرة</span><span id="withdrawCount">0</span>
                            </div>
                            <p class="text-muted mt-2">إجمالي السحوبات: <span id="totalWithdraw">0</span> دولار</p>
                        </div>
                    </div>
                    
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="dashboard-card stats-card">
                            <div class="card-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <h5 class="card-title">الأرباح الشهرية</h5>
                            <div class="card-value">
                                <span class="card-unit">دولار</span><span id="monthlyEarnings">0</span>
                            </div>
                            <p class="text-muted mt-2">النقاط الشهرية: <span id="monthlyPoints">0</span></p>
                        </div>
                    </div>
                </div>
                
                <!-- الإعلانات اليومية -->
                <div class="ads-container">
                    <h3 class="section-title">
                        <i class="fas fa-bolt me-2"></i>إعلانات اليوم السريعة
                    </h3>
                    
                    <div class="row" id="quickAdsContainer">
                        <!-- سيتم ملؤها بواسطة JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- قسم الإعلانات -->
            <div id="adsSection" style="display: none;">
                <h3 class="section-title">
                    <i class="fas fa-ad me-2"></i>جميع الإعلانات المتاحة
                </h3>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" id="searchAds" placeholder="ابحث عن إعلان...">
                            <button class="btn btn-primary" onclick="searchAds()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <select class="form-select" id="sortAds" onchange="loadAds()">
                            <option value="newest">الأحدث أولاً</option>
                            <option value="highest">أعلى نقاط</option>
                            <option value="lowest">أقل مدة</option>
                        </select>
                    </div>
                </div>
                
                <div class="row" id="adsContainer">
                    <!-- سيتم ملؤها بواسطة JavaScript -->
                </div>
                
                <div class="text-center mt-4">
                    <button class="btn btn-outline-primary" onclick="loadMoreAds()" id="loadMoreBtn">
                        <i class="fas fa-plus me-2"></i>تحميل المزيد
                    </button>
                </div>
            </div>
            
            <!-- قسم السحوبات -->
            <div id="withdrawSection" style="display: none;">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="dashboard-card">
                            <h5 class="card-title">
                                <i class="fas fa-money-bill-wave me-2"></i>طلب سحب الأرباح
                            </h5>
                            <p class="text-muted mb-3">الحد الأدنى للسحب: 1 دولار (20,000 نقطة)</p>
                            
                            <div class="mb-3">
                                <label class="form-label">رقم فودافون كاش</label>
                                <input type="text" class="form-control" id="vodafoneNumber" placeholder="أدخل رقم الهاتف المرتبط بفودافون كاش" required>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">عدد النقاط للسحب</label>
                                <input type="number" class="form-control" id="withdrawPoints" min="20000" step="1000" value="20000" required>
                                <div class="form-text" id="withdrawAmount">المبلغ: 1 دولار</div>
                            </div>
                            
                            <button class="btn btn-success w-100" id="requestWithdraw" onclick="requestWithdrawal()">
                                <i class="fas fa-paper-plane me-2"></i>إرسال طلب السحب
                            </button>
                        </div>
                        
                        <!-- طلبات السحب السابقة -->
                        <div class="dashboard-card mt-4">
                            <h5 class="card-title">
                                <i class="fas fa-history me-2"></i>طلبات السحب السابقة
                            </h5>
                            <div class="table-responsive">
                                <table class="table table-hover" id="withdrawHistoryTable">
                                    <thead>
                                        <tr>
                                            <th>التاريخ</th>
                                            <th>النقاط</th>
                                            <th>المبلغ</th>
                                            <th>رقم الهاتف</th>
                                            <th>الحالة</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- سيتم ملؤها بواسطة JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="dashboard-card">
                            <h5 class="card-title">
                                <i class="fas fa-info-circle me-2"></i>معلومات مهمة
                            </h5>
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    الحد الأدنى للسحب: 20,000 نقطة (1 دولار)
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    السحب حصرياً عبر فودافون كاش
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    معالجة طلبات السحب خلال 24-48 ساعة
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    يجب أن يكون الرصيد من نقاط الإعلانات فقط
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    العمولة: 5% من المبلغ المسحوب
                                </li>
                            </ul>
                            
                            <div class="alert alert-warning alert-custom mt-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                يتم خصم 5% عمولة على كل عملية سحب
                            </div>
                        </div>
                        
                        <!-- حاسبة النقاط -->
                        <div class="dashboard-card mt-4">
                            <h5 class="card-title">
                                <i class="fas fa-calculator me-2"></i>حاسبة النقاط
                            </h5>
                            <div class="mb-3">
                                <label class="form-label">عدد النقاط</label>
                                <input type="number" class="form-control" id="calcPoints" min="0" value="20000" oninput="calculatePoints()">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">القيمة بالدولار</label>
                                <input type="text" class="form-control" id="calcDollars" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">بعد الخصم (5%)</label>
                                <input type="text" class="form-control" id="calcAfterFees" readonly>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- قسم التاريخ -->
            <div id="historySection" style="display: none;">
                <div class="dashboard-card">
                    <h5 class="card-title">
                        <i class="fas fa-history me-2"></i>سجل النشاط
                    </h5>
                    
                    <ul class="nav nav-tabs" id="historyTabs">
                        <li class="nav-item">
                            <button class="nav-link active" onclick="showHistoryTab('ads')">الإعلانات</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" onclick="showHistoryTab('points')">النقاط</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" onclick="showHistoryTab('penalties')">العقوبات</button>
                        </li>
                    </ul>
                    
                    <div class="tab-content mt-3">
                        <div class="tab-pane fade show active" id="adsHistoryTab">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>التاريخ</th>
                                            <th>الإعلان</th>
                                            <th>النقاط</th>
                                            <th>المدة</th>
                                            <th>الحالة</th>
                                        </tr>
                                    </thead>
                                    <tbody id="adsHistoryBody">
                                        <!-- سيتم ملؤها بواسطة JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="pointsHistoryTab">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>التاريخ</th>
                                            <th>النوع</th>
                                            <th>النقاط</th>
                                            <th>الرصيد قبل</th>
                                            <th>الرصيد بعد</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pointsHistoryBody">
                                        <!-- سيتم ملؤها بواسطة JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="penaltiesHistoryTab">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>التاريخ</th>
                                            <th>النوع</th>
                                            <th>النقاط المخصومة</th>
                                            <th>السبب</th>
                                        </tr>
                                    </thead>
                                    <tbody id="penaltiesHistoryBody">
                                        <!-- سيتم ملؤها بواسطة JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- قسم الملف الشخصي -->
            <div id="profileSection" style="display: none;">
                <div class="row">
                    <div class="col-lg-4">
                        <div class="dashboard-card text-center">
                            <div class="mb-3">
                                <img src="https://ui-avatars.com/api/?name=مستخدم&background=3498db&color=fff&size=150" 
                                     class="rounded-circle" alt="صورة المستخدم" id="userAvatar">
                            </div>
                            <h5 id="profileName"></h5>
                            <p class="text-muted" id="profileEmail"></p>
                            <p class="text-muted">تاريخ الانضمام: <span id="joinDate"></span></p>
                        </div>
                    </div>
                    
                    <div class="col-lg-8">
                        <div class="dashboard-card">
                            <h5 class="card-title">معلومات الحساب</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">الاسم الكامل</label>
                                        <input type="text" class="form-control" id="profileFullName">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">رقم الهاتف</label>
                                        <input type="text" class="form-control" id="profilePhone">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">البلد</label>
                                        <select class="form-select" id="profileCountry">
                                            <option value="egypt">مصر</option>
                                            <option value="saudi">السعودية</option>
                                            <option value="uae">الإمارات</option>
                                            <option value="other">دولة أخرى</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">المدينة</label>
                                        <input type="text" class="form-control" id="profileCity">
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="saveProfile()">
                                <i class="fas fa-save me-2"></i>حفظ التغييرات
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- قسم الإعدادات -->
            <div id="settingsSection" style="display: none;">
                <div class="dashboard-card">
                    <h5 class="card-title">الإعدادات</h5>
                    
                    <div class="mb-4">
                        <h6>إشعارات البريد الإلكتروني</h6>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                            <label class="form-check-label" for="emailNotifications">تفعيل الإشعارات بالبريد</label>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h6>إعدادات الخصوصية</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="showProfile" checked>
                            <label class="form-check-label" for="showProfile">إظهار ملفي الشخصي للآخرين</label>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="saveSettings()">
                        <i class="fas fa-save me-2"></i>حفظ الإعدادات
                    </button>
                </div>
            </div>
        </div>

        <!-- الفوتر -->
        <footer class="footer">
            <div class="container">
                <div class="row">
                    <div class="col-lg-4 col-md-6 mb-4">
                        <h5>عن ادفيستا</h5>
                        <p>منصة عربية لربح النقاط من خلال مشاهدة الإعلانات. نوفر فرصة ربح حقيقية للمستخدمين مع شروط واضحة وشفافة.</p>
                        <div class="social-icons mt-4">
                            <a href="https://wa.me/201273740256" target="_blank" title="واتساب">
                                <i class="fab fa-whatsapp"></i>
                            </a>
                            <a href="https://www.instagram.com/Baraa___offical" target="_blank" title="انستجرام">
                                <i class="fab fa-instagram"></i>
                            </a>
                            <a href="https://www.tiktok.com/@Baraa_offical" target="_blank" title="تيك توك">
                                <i class="fab fa-tiktok"></i>
                            </a>
                            <a href="https://www.facebook.com/baraa_omar_talaat" target="_blank" title="فيسبوك">
                                <i class="fab fa-facebook-f"></i>
                            </a>
                        </div>
                    </div>
                    
                    <div class="col-lg-4 col-md-6 mb-4">
                        <h5>روابط سريعة</h5>
                        <ul class="footer-links list-unstyled">
                            <li><a href="#" onclick="showSection('dashboard')"><i class="fas fa-chevron-left me-2"></i>كيفية الربح</a></li>
                            <li><a href="#" onclick="showSection('withdraw')"><i class="fas fa-chevron-left me-2"></i>شروط السحب</a></li>
                            <li><a href="#"><i class="fas fa-chevron-left me-2"></i>الأسئلة الشائعة</a></li>
                            <li><a href="#"><i class="fas fa-chevron-left me-2"></i>سياسة الخصوصية</a></li>
                            <li><a href="#" onclick="showSection('profile')"><i class="fas fa-chevron-left me-2"></i>اتصل بنا</a></li>
                        </ul>
                    </div>
                    
                    <div class="col-lg-4 col-md-12 mb-4">
                        <h5>معلومات الاتصال</h5>
                        <ul class="footer-links list-unstyled">
                            <li><i class="fas fa-envelope me-2"></i> bo2584668@gmail.com</li>
                            <li><i class="fab fa-whatsapp me-2"></i> 201273740256</li>
                            <li><i class="fas fa-globe me-2"></i> مصر</li>
                        </ul>
                        
                        <div class="mt-4">
                            <h6>طرق السحب المتاحة</h6>
                            <div class="d-flex align-items-center mt-2">
                                <div class="bg-white rounded p-2 me-2">
                                    <i class="fas fa-money-bill-wave text-success fa-2x"></i>
                                </div>
                                <span>فودافون كاش</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="copyright">
                    <p>جميع الحقوق محفوظة &copy; 2023 ادفيستا. تم التطوير بواسطة بَراء</p>
                </div>
            </div>
        </footer>
    </div>

    <!-- لوحة تحكم الإدمن -->
    <div id="adminPage" style="display: none;">
        <div class="admin-panel">
            <div class="container-fluid">
                <div class="row">
                    <!-- الشريط الجانبي -->
                    <div class="col-lg-2 col-md-3 admin-sidebar">
                        <div class="admin-header">
                            <h4><i class="fas fa-user-shield me-2"></i>لوحة التحكم</h4>
                            <p class="small mb-0" id="adminEmail"></p>
                        </div>
                        
                        <ul class="admin-menu">
                            <li><a href="#" class="active" onclick="showAdminSection('dashboard')"><i class="fas fa-tachometer-alt me-2"></i> الإحصائيات</a></li>
                            <li><a href="#" onclick="showAdminSection('ads')"><i class="fas fa-ad me-2"></i> إدارة الإعلانات</a></li>
                            <li><a href="#" onclick="showAdminSection('users')"><i class="fas fa-users me-2"></i> إدارة المستخدمين</a></li>
                            <li><a href="#" onclick="showAdminSection('withdrawals')"><i class="fas fa-money-check me-2"></i> طلبات السحب</a></li>
                            <li><a href="#" onclick="showAdminSection('reports')"><i class="fas fa-chart-bar me-2"></i> التقارير</a></li>
                            <li><a href="#" onclick="signOut()"><i class="fas fa-sign-out-alt me-2"></i> تسجيل الخروج</a></li>
                        </ul>
                    </div>
                    
                    <!-- المحتوى الرئيسي -->
                    <div class="col-lg-10 col-md-9 admin-content">
                        <!-- قسم إحصائيات الإدمن -->
                        <div id="adminDashboard">
                            <h3 class="mb-4">إحصائيات النظام</h3>
                            
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <div class="admin-card">
                                        <h6>إجمالي المستخدمين</h6>
                                        <h2 id="totalUsers">0</h2>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="admin-card">
                                        <h6>الإعلانات النشطة</h6>
                                        <h2 id="activeAds">0</h2>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="admin-card">
                                        <h6>طلبات السحب</h6>
                                        <h2 id="pendingWithdrawals">0</h2>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="admin-card">
                                        <h6>إجمالي النقاط</h6>
                                        <h2 id="totalSystemPoints">0</h2>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- رسومات بيانية -->
                            <div class="row mt-4">
                                <div class="col-md-6 mb-3">
                                    <div class="admin-card">
                                        <h6>نشاط المستخدمين</h6>
                                        <canvas id="userActivityChart" height="200"></canvas>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="admin-card">
                                        <h6>الإعلانات الأكثر مشاهدة</h6>
                                        <canvas id="topAdsChart" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- قسم إدارة الإعلانات -->
                        <div id="adminAds" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h3>إدارة الإعلانات</h3>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAdModal">
                                    <i class="fas fa-plus me-2"></i>إضافة إعلان جديد
                                </button>
                            </div>
                            
                            <div class="admin-card">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>العنوان</th>
                                                <th>الرابط</th>
                                                <th>النقاط</th>
                                                <th>المدة</th>
                                                <th>المشاهدات</th>
                                                <th>الحالة</th>
                                                <th>الإجراءات</th>
                                            </tr>
                                        </thead>
                                        <tbody id="adminAdsTable">
                                            <!-- سيتم ملؤها بواسطة JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- قسم إدارة المستخدمين -->
                        <div id="adminUsers" style="display: none;">
                            <h3 class="mb-4">إدارة المستخدمين</h3>
                            
                            <div class="admin-card">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>الاسم</th>
                                                <th>البريد</th>
                                                <th>النقاط</th>
                                                <th>السحوبات</th>
                                                <th>تاريخ الانضمام</th>
                                                <th>الحالة</th>
                                                <th>الإجراءات</th>
                                            </tr>
                                        </thead>
                                        <tbody id="adminUsersTable">
                                            <!-- سيتم ملؤها بواسطة JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- قسم طلبات السحب -->
                        <div id="adminWithdrawals" style="display: none;">
                            <h3 class="mb-4">طلبات السحب المعلقة</h3>
                            
                            <div class="admin-card">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>المستخدم</th>
                                                <th>النقاط</th>
                                                <th>المبلغ</th>
                                                <th>رقم الهاتف</th>
                                                <th>التاريخ</th>
                                                <th>الحالة</th>
                                                <th>الإجراءات</th>
                                            </tr>
                                        </thead>
                                        <tbody id="adminWithdrawalsTable">
                                            <!-- سيتم ملؤها بواسطة JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- قسم التقارير -->
                        <div id="adminReports" style="display: none;">
                            <h3 class="mb-4">التقارير والإحصائيات</h3>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="admin-card">
                                        <h6>أعلى المستخدمين ربحاً</h6>
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>المستخدم</th>
                                                    <th>النقاط</th>
                                                </tr>
                                            </thead>
                                            <tbody id="topEarnersTable">
                                                <!-- سيتم ملؤها بواسطة JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="admin-card">
                                        <h6>أحدث النشاطات</h6>
                                        <div style="max-height: 300px; overflow-y: auto;">
                                            <ul class="list-unstyled" id="recentActivities">
                                                <!-- سيتم ملؤها بواسطة JavaScript -->
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة العدّاد -->
    <div class="modal fade" id="timerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">مشاهدة الإعلان</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="timer-container">
                        <p class="timer-message" id="adTitleMessage">يجب مشاهدة الإعلان حتى النهاية للحصول على النقاط</p>
                        <div class="timer" id="countdown">30</div>
                        <p>ثانية متبقية</p>
                        
                        <div class="alert alert-warning alert-custom mt-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="warningMessage">لا تغلق نافذة الإعلان أو تترك هذه الصفحة حتى ينتهي العدّاد</span>
                            <div class="mt-2 small text-danger" id="penaltyWarning" style="display: none;">
                                <i class="fas fa-skull-crossbones me-1"></i>
                                تحذير: إذا أغلقت الإعلان قبل الوقت سيتم خصم <span id="penaltyAmount">0</span> نقطة
                            </div>
                        </div>
                        
                        <div class="progress mt-3" style="height: 10px;">
                            <div class="progress-bar progress-bar-custom" id="timerProgress" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="captcha-container d-none" id="captchaSection">
                        <p>أدخل الأحاظ في الصورة أدناه لتأكيد المشاهدة</p>
                        <div class="captcha-box" id="captchaText">A3B7C</div>
                        <input type="text" class="captcha-input" id="captchaInput" placeholder="أدخل النص أعلاه">
                        <button class="btn btn-verify" id="verifyCaptcha">
                            <i class="fas fa-check-circle me-2"></i>تأكيد والحصول على النقاط
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة إعلان جديد -->
    <div class="modal fade" id="addAdModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إضافة إعلان جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addAdForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">عنوان الإعلان</label>
                                <input type="text" class="form-control" id="adTitle" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">رابط الإعلان</label>
                                <input type="url" class="form-control" id="adUrl" value="https://linkjust.com/xbTIX" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">عدد النقاط</label>
                                <input type="number" class="form-control" id="adPoints" min="50" max="1000" value="150" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">مدة المشاهدة (ثانية)</label>
                                <input type="number" class="form-control" id="adDuration" min="10" max="120" value="30" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">عدد مرات المشاهدة</label>
                                <input type="number" class="form-control" id="adViewsLimit" min="1" max="10000" value="1000" required>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label">وصف الإعلان</label>
                                <textarea class="form-control" id="adDescription" rows="3"></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">فئة الإعلان</label>
                                <select class="form-select" id="adCategory">
                                    <option value="general">عام</option>
                                    <option value="shopping">تسوق</option>
                                    <option value="games">ألعاب</option>
                                    <option value="apps">تطبيقات</option>
                                    <option value="education">تعليم</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">الصورة (اختياري)</label>
                                <input type="file" class="form-control" id="adImage" accept="image/*">
                            </div>
                        </div>
                        
                        <div class="alert alert-info alert-custom">
                            <i class="fas fa-info-circle me-2"></i>
                            سيتم نشر الإعلان فور إضافته وسيظهر للمستخدمين مباشرة
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="addNewAd()">إضافة الإعلان</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تفاصيل المستخدم -->
    <div class="modal fade" id="userDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">تفاصيل المستخدم</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="userDetailsContent">
                    <!-- سيتم ملؤها بواسطة JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- مكتبات JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // ============================================
        // إعدادات Firebase
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyC4fZQ-BTUeHsN9nQtMGmnjJz-NKdcUgkc",
            authDomain: "advista-b64ab.firebaseapp.com",
            projectId: "advista-b64ab",
            storageBucket: "advista-b64ab.firebasestorage.app",
            messagingSenderId: "509713648189",
            appId: "1:509713648189:web:0ccd6ada1f4e07f85d3854",
            measurementId: "G-VG4S1SMKH8"
        };
        
        // تهيئة Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        // ============================================
        // المتغيرات العامة
        // ============================================
        let currentUser = null;
        let userData = null;
        let ads = [];
        let adsPerPage = 12;
        let currentPage = 1;
        let currentAd = null;
        let timerValue = 30;
        let totalTime = 30;
        let countdownInterval = null;
        let isWindowFocused = true;
        let penaltyPoints = 0;
        let adTab = null;
        
        // ============================================
        // نظام المصادقة باستخدام Google Sign-In الجديد
        // ============================================
        

    
    }
}

// وظيفة فك تشفير JWT (جاهزة ومجربة)
function parseJwt(token) {
    try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));

        return JSON.parse(jsonPayload);
    } catch (error) {
        console.error("JWT Error:", error);
        return null;
    }
}

// استدعاء التشغيل
initializeGoogleSignIn();

                
                
        }
        
        // فك تشفير JWT token
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
        
                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error("خطأ في فك تشفير JWT:", error);
                return null;
            }
        }
        
        // إنشاء أو تحديث بيانات المستخدم في Firebase
        async function createOrUpdateUser(user) {
            const userRef = db.collection('users').doc(user.uid);
            const userDoc = await userRef.get();
            
            if (!userDoc.exists) {
                // إنشاء مستخدم جديد
                await userRef.set({
                    uid: user.uid,
                    email: user.email,
                    name: user.displayName || 'مستخدم جديد',
                    photoURL: user.photoURL || '',
                    points: 100, // نقاط ترحيبية
                    dailyPoints: 0,
                    dailyTasks: 0,
                    totalWithdrawals: 0,
                    totalEarned: 0,
                    totalAdsWatched: 0,
                    referralCode: generateReferralCode(),
                    referrals: [],
                    referralEarnings: 0,
                    joinDate: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                    lastGoogleSignIn: new Date().toISOString(),
                    profile: {
                        phone: '',
                        country: 'egypt',
                        city: '',
                        address: '',
                        birthDate: '',
                        gender: ''
                    },
                    settings: {
                        emailNotifications: true,
                        showProfile: true,
                        emailPromotions: true,
                        emailWithdrawal: true,
                        showEarnings: false,
                        allowMessages: true
                    },
                    penalties: 0,
                    level: 'مبتدئ',
                    accountStatus: 'active',
                    authProvider: 'google'
                });
                
                // إنشاء سجل النقاط الأولي
                await db.collection('points_history').add({
                    userId: user.uid,
                    type: 'registration',
                    points: 100,
                    balanceBefore: 0,
                    balanceAfter: 100,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    description: 'نقاط ترحيبية للتسجيل'
                });
            } else {
                // تحديث آخر دخول
                await userRef.update({
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                    lastGoogleSignIn: new Date().toISOString()
                });
            }
            
            currentUser = user;
            await loadUserData(user.uid);
        }
        
        // إنشاء مستخدم إدمن
        async function createAdminUser(user) {
            const adminRef = db.collection('admins').doc(user.uid);
            const adminDoc = await adminRef.get();
            
            if (!adminDoc.exists) {
                await adminRef.set({
                    uid: user.uid,
                    email: user.email,
                    name: user.displayName || 'مدير النظام',
                    role: 'super_admin',
                    permissions: ['all'],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                });
            } else {
                await adminRef.update({
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            currentUser = user;
        }
        
        // توليد كود إحالة
        function generateReferralCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return 'ADV-' + code;
        }
        
        // ============================================
        // تحميل بيانات المستخدم
        // ============================================
        async function loadUserData(userId) {
            const userDoc = await db.collection('users').doc(userId).get();
            if (userDoc.exists) {
                userData = userDoc.data();
                updateUserUI();
                loadUserAdsHistory(userId);
                loadWithdrawHistory(userId);
                loadPointsHistory(userId);
                loadPenaltiesHistory(userId);
            }
        }
        
        function updateUserUI() {
            if (userData) {
                document.getElementById('userName').textContent = `أهلاً، ${userData.name}`;
                document.getElementById('userPoints').textContent = userData.points.toLocaleString();
                document.getElementById('totalPoints').textContent = userData.points.toLocaleString();
                document.getElementById('dailyTasks').textContent = userData.dailyTasks || 0;
                document.getElementById('dailyPoints').textContent = userData.dailyPoints || 0;
                document.getElementById('withdrawCount').textContent = userData.totalWithdrawals || 0;
                document.getElementById('totalWithdraw').textContent = (userData.totalWithdrawals || 0).toFixed(2);
                
                const dollars = (userData.points / 20000).toFixed(2);
                document.getElementById('pointsInDollars').textContent = `ما يعادل: ${dollars} دولار`;
                
                // تحديث الملف الشخصي
                document.getElementById('profileName').textContent = userData.name;
                document.getElementById('profileEmail').textContent = userData.email;
                document.getElementById('profileFullName').value = userData.name;
                document.getElementById('profilePhone').value = userData.profile?.phone || '';
                document.getElementById('profileCountry').value = userData.profile?.country || 'egypt';
                document.getElementById('profileCity').value = userData.profile?.city || '';
                
                if (userData.joinDate) {
                    const date = userData.joinDate.toDate();
                    document.getElementById('joinDate').textContent = date.toLocaleDateString('ar-EG');
                }
                
                // تحديث الإعدادات
                document.getElementById('emailNotifications').checked = userData.settings?.emailNotifications || true;
                document.getElementById('showProfile').checked = userData.settings?.showProfile || true;
            }
        }
        
        // ============================================
        // إظهار وإخفاء الصفحات
        // ============================================
        function showUserPage() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('userPage').style.display = 'block';
            document.getElementById('adminPage').style.display = 'none';
            loadAds();
            loadQuickAds();
            showSection('dashboard');
        }
        
        function showAdminPage() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('userPage').style.display = 'none';
            document.getElementById('adminPage').style.display = 'block';
            document.getElementById('adminEmail').textContent = currentUser.email;
            loadAdminDashboard();
            showAdminSection('dashboard');
        }
        
        function showSection(section) {
            // إخفاء جميع الأقسام
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('adsSection').style.display = 'none';
            document.getElementById('withdrawSection').style.display = 'none';
            document.getElementById('historySection').style.display = 'none';
            document.getElementById('profileSection').style.display = 'none';
            document.getElementById('settingsSection').style.display = 'none';
            
            // إظهار القسم المطلوب
            document.getElementById(section + 'Section').style.display = 'block';
            
            // تحديث القائمة النشطة
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[onclick="showSection('${section}')"]`).classList.add('active');
            
            // تحميل البيانات إذا لزم
            if (section === 'history' && currentUser) {
                showHistoryTab('ads');
            } else if (section === 'withdraw' && currentUser) {
                loadWithdrawHistory(currentUser.uid);
            }
        }
        
        function showAdminSection(section) {
            // إخفاء جميع الأقسام
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('adminAds').style.display = 'none';
            document.getElementById('adminUsers').style.display = 'none';
            document.getElementById('adminWithdrawals').style.display = 'none';
            document.getElementById('adminReports').style.display = 'none';
            
            // إزالة النشط من جميع القوائم
            document.querySelectorAll('.admin-menu a').forEach(link => {
                link.classList.remove('active');
            });
            
            // إظهار القسم المطلوب
            document.getElementById('admin' + section.charAt(0).toUpperCase() + section.slice(1)).style.display = 'block';
            
            // إضافة النشط للقائمة
            event.target.classList.add('active');
        }
        
        // ============================================
        // تسجيل الخروج
        // ============================================
        async function signOut() {
            try {
                // تسجيل الخروج من جوجل
                if (typeof google !== 'undefined' && google.accounts) {
                    google.accounts.id.disableAutoSelect();
                }
                
                // مسح البيانات المحلية
                currentUser = null;
                userData = null;
                localStorage.removeItem('advista_user');
                
                // إعادة التوجيه
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('userPage').style.display = 'none';
                document.getElementById('adminPage').style.display = 'none';
                
                // إعادة تحميل الصفحة
                setTimeout(() => {
                    window.location.reload();
                }, 500);
                
            } catch (error) {
                console.error("خطأ في تسجيل الخروج:", error);
            }
        }
        
        // ============================================
        // نظام الإعلانات
        // ============================================
        async function loadAds() {
            try {
                const sortBy = document.getElementById('sortAds').value;
                let query = db.collection('ads').where('status', '==', 'active');
                
                if (sortBy === 'newest') {
                    query = query.orderBy('createdAt', 'desc');
                } else if (sortBy === 'highest') {
                    query = query.orderBy('points', 'desc');
                } else if (sortBy === 'lowest') {
                    query = query.orderBy('duration', 'asc');
                }
                
                const snapshot = await query.limit(adsPerPage * currentPage).get();
                ads = [];
                snapshot.forEach(doc => {
                    ads.push({ id: doc.id, ...doc.data() });
                });
                
                displayAds();
            } catch (error) {
                console.error("خطأ في تحميل الإعلانات:", error);
                loadDefaultAds();
            }
        }
        
        function loadDefaultAds() {
            ads = [];
            for (let i = 1; i <= 20; i++) {
                ads.push({
                    id: `ad${i}`,
                    title: `إعلان تطبيق جديد ${i}`,
                    url: "https://linkjust.com/xbTIX",
                    points: 100 + (i * 10),
                    duration: 20 + (i * 2),
                    description: "إعلان تجريبي للموقع",
                    category: "general",
                    views: Math.floor(Math.random() * 1000),
                    maxViews: 1000,
                    status: "active",
                    createdAt: new Date()
                });
            }
            displayAds();
        }
        
        function displayAds() {
            const container = document.getElementById('adsContainer');
            container.innerHTML = '';
            
            const startIndex = 0;
            const endIndex = Math.min(currentPage * adsPerPage, ads.length);
            
            for (let i = startIndex; i < endIndex; i++) {
                const ad = ads[i];
                const adCard = document.createElement('div');
                adCard.className = 'col-lg-3 col-md-4 col-sm-6';
                adCard.innerHTML = `
                    <div class="ad-card">
                        <div class="ad-header">
                            <h6 class="ad-title">${ad.title}</h6>
                        </div>
                        <div class="ad-body">
                            <div class="ad-points">
                                <i class="fas fa-coins"></i>
                                <span>النقاط: <strong>${ad.points}</strong></span>
                            </div>
                            <div class="ad-duration">
                                <i class="fas fa-clock"></i>
                                <span>المدة: <strong>${ad.duration}</strong> ثانية</span>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">
                                    <i class="fas fa-eye me-1"></i> ${ad.views || 0}/${ad.maxViews || 1000}
                                </small>
                            </div>
                            <button class="btn btn-view-ad" onclick="startAd('${ad.id}')" ${userData && userData.dailyTasks >= 20 ? 'disabled' : ''}>
                                <i class="fas fa-play-circle me-2"></i>${userData && userData.dailyTasks >= 20 ? 'اكتمل اليوم' : 'ابدأ المشاهدة'}
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(adCard);
            }
            
            document.getElementById('loadMoreBtn').style.display = 
                endIndex < ads.length ? 'block' : 'none';
        }
        
        function loadQuickAds() {
            const container = document.getElementById('quickAdsContainer');
            container.innerHTML = '';
            
            const quickAds = ads.slice(0, 4);
            
            quickAds.forEach(ad => {
                const adCard = document.createElement('div');
                adCard.className = 'col-lg-3 col-md-6';
                adCard.innerHTML = `
                    <div class="ad-card">
                        <div class="ad-header">
                            <h6 class="ad-title">${ad.title}</h6>
                        </div>
                        <div class="ad-body">
                            <div class="ad-points">
                                <i class="fas fa-coins"></i>
                                <span>النقاط: <strong>${ad.points}</strong></span>
                            </div>
                            <div class="ad-duration">
                                <i class="fas fa-clock"></i>
                                <span>المدة: <strong>${ad.duration}</strong> ثانية</span>
                            </div>
                            <button class="btn btn-view-ad" onclick="startAd('${ad.id}')" ${userData && userData.dailyTasks >= 20 ? 'disabled' : ''}>
                                <i class="fas fa-bolt me-2"></i>مشاهدة سريعة
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(adCard);
            });
        }
        
        function loadMoreAds() {
            currentPage++;
            displayAds();
        }
        
        function searchAds() {
            const searchTerm = document.getElementById('searchAds').value.toLowerCase();
            const filteredAds = ads.filter(ad => 
                ad.title.toLowerCase().includes(searchTerm) || 
                ad.description.toLowerCase().includes(searchTerm)
            );
            
            const container = document.getElementById('adsContainer');
            container.innerHTML = '';
            
            filteredAds.forEach(ad => {
                const adCard = document.createElement('div');
                adCard.className = 'col-lg-3 col-md-4 col-sm-6';
                adCard.innerHTML = `
                    <div class="ad-card">
                        <div class="ad-header">
                            <h6 class="ad-title">${ad.title}</h6>
                        </div>
                        <div class="ad-body">
                            <div class="ad-points">
                                <i class="fas fa-coins"></i>
                                <span>النقاط: <strong>${ad.points}</strong></span>
                            </div>
                            <div class="ad-duration">
                                <i class="fas fa-clock"></i>
                                <span>المدة: <strong>${ad.duration}</strong> ثانية</span>
                            </div>
                            <button class="btn btn-view-ad" onclick="startAd('${ad.id}')" ${userData && userData.dailyTasks >= 20 ? 'disabled' : ''}>
                                <i class="fas fa-play-circle me-2"></i>ابدأ المشاهدة
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(adCard);
            });
        }
        
        // ============================================
        // نظام مشاهدة الإعلانات
        // ============================================
        async function startAd(adId) {
            if (userData.dailyTasks >= 20) {
                alert("لقد وصلت للحد الأقصى من المهام اليومية (20 مهمة). عد غداً!");
                return;
            }
            
            const ad = ads.find(a => a.id === adId);
            if (!ad) return;
            
            // التحقق إذا كان المستخدم قد شاهد هذا الإعلان اليوم
            const today = new Date().toDateString();
            const adHistoryRef = db.collection('ad_history')
                .where('userId', '==', currentUser.uid)
                .where('adId', '==', adId)
                .where('date', '==', today)
                .limit(1);
            
            const historySnapshot = await adHistoryRef.get();
            if (!historySnapshot.empty) {
                alert("لقد شاهدت هذا الإعلان اليوم بالفعل!");
                return;
            }
            
            currentAd = ad;
            timerValue = ad.duration;
            totalTime = ad.duration;
            penaltyPoints = Math.floor(ad.points * 0.5);
            
            // فتح الإعلان في تبويب جديد
            adTab = window.open(ad.url, '_blank', 'noopener,noreferrer');
            
            // تحديث واجهة العدّاد
            document.getElementById('adTitleMessage').textContent = `جاري مشاهدة: ${ad.title}`;
            document.getElementById('countdown').textContent = timerValue;
            document.getElementById('penaltyAmount').textContent = penaltyPoints;
            document.getElementById('penaltyWarning').style.display = 'block';
            document.getElementById('timerProgress').style.width = '0%';
            
            // إظهار نافذة العدّاد
            const timerModal = new bootstrap.Modal(document.getElementById('timerModal'));
            timerModal.show();
            
            // بدء العدّاد
            startCountdown();
            
            // مراقبة التركيز
            window.addEventListener('blur', handleWindowBlur);
            window.addEventListener('focus', handleWindowFocus);
            window.addEventListener('beforeunload', handleBeforeUnload);
            
            // بدء تتبع المشاهدة
            await startAdTracking(adId);
        }
        
        async function startAdTracking(adId) {
            const trackingRef = db.collection('ad_tracking').doc();
            await trackingRef.set({
                userId: currentUser.uid,
                adId: adId,
                startTime: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'watching',
                penaltyApplied: false,
                pointsEarned: 0
            });
            
            currentAd.trackingId = trackingRef.id;
        }
        
        function startCountdown() {
            const countdownElement = document.getElementById('countdown');
            const progressBar = document.getElementById('timerProgress');
            
            countdownInterval = setInterval(async () => {
                if (isWindowFocused && timerValue > 0) {
                    timerValue--;
                    countdownElement.textContent = timerValue;
                    
                    const progress = ((totalTime - timerValue) / totalTime) * 100;
                    progressBar.style.width = `${progress}%`;
                    
                    if (adTab && adTab.closed) {
                        handleAdClosed();
                    }
                    
                    if (timerValue <= 0) {
                        clearInterval(countdownInterval);
                        await handleAdCompleted();
                    }
                }
            }, 1000);
        }
        
        function handleWindowBlur() {
            isWindowFocused = false;
        }
        
        function handleWindowFocus() {
            isWindowFocused = true;
        }
        
        function handleBeforeUnload(e) {
            if (currentAd && timerValue > 0) {
                e.preventDefault();
                e.returnValue = 'إذا غادرت الآن سيتم خصم النقاط. هل أنت متأكد؟';
            }
        }
        
        async function handleAdClosed() {
            if (timerValue > 0) {
                clearInterval(countdownInterval);
                await applyPenalty();
                document.getElementById('timerContainer').style.display = 'none';
                document.getElementById('warningMessage').innerHTML = 
                    '<i class="fas fa-times-circle text-danger me-2"></i>تم إغلاق الإعلان قبل الوقت! تم خصم ' + penaltyPoints + ' نقطة';
                await recordPenalty();
            }
        }
        
        async function handleAdCompleted() {
            window.removeEventListener('blur', handleWindowBlur);
            window.removeEventListener('focus', handleWindowFocus);
            window.removeEventListener('beforeunload', handleBeforeUnload);
            
            document.querySelector('.timer-container').style.display = 'none';
            document.getElementById('captchaSection').classList.remove('d-none');
            generateCaptcha();
            
            if (currentAd.trackingId) {
                await db.collection('ad_tracking').doc(currentAd.trackingId).update({
                    endTime: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'completed',
                    completed: true
                });
            }
        }
        
        function generateCaptcha() {
            const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
            let captcha = "";
            
            for (let i = 0; i < 5; i++) {
                captcha += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            document.getElementById('captchaText').textContent = captcha;
            return captcha;
        }
        
        document.getElementById('verifyCaptcha').addEventListener('click', async function() {
            const captchaInput = document.getElementById('captchaInput').value;
            const captchaText = document.getElementById('captchaText').textContent;
            
            if (captchaInput === captchaText) {
                await addPoints(currentAd.points);
                
                if (adTab && !adTab.closed) {
                    adTab.close();
                }
                
                const timerModal = bootstrap.Modal.getInstance(document.getElementById('timerModal'));
                timerModal.hide();
                
                resetAdSystem();
                showSuccessMessage(`تمت إضافة ${currentAd.points} نقطة إلى رصيدك!`);
            } else {
                alert("كود التأكيد غير صحيح. حاول مرة أخرى.");
                generateCaptcha();
                document.getElementById('captchaInput').value = '';
            }
        });
        
        async function addPoints(points) {
            if (!currentUser || !userData) return;
            
            const newPoints = userData.points + points;
            const newDailyPoints = (userData.dailyPoints || 0) + points;
            const newDailyTasks = (userData.dailyTasks || 0) + 1;
            
            await db.collection('users').doc(currentUser.uid).update({
                points: newPoints,
                dailyPoints: newDailyPoints,
                dailyTasks: newDailyTasks,
                totalEarned: (userData.totalEarned || 0) + points
            });
            
            userData.points = newPoints;
            userData.dailyPoints = newDailyPoints;
            userData.dailyTasks = newDailyTasks;
            
            updateUserUI();
            
            await db.collection('points_history').add({
                userId: currentUser.uid,
                type: 'ad_watch',
                points: points,
                balanceBefore: userData.points - points,
                balanceAfter: userData.points,
                adId: currentAd.id,
                adTitle: currentAd.title,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await db.collection('ad_history').add({
                userId: currentUser.uid,
                adId: currentAd.id,
                adTitle: currentAd.title,
                points: points,
                date: new Date().toDateString(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        async function applyPenalty() {
            if (!currentUser || !userData || penaltyPoints <= 0) return;
            
            const newPoints = Math.max(0, userData.points - penaltyPoints);
            
            await db.collection('users').doc(currentUser.uid).update({
                points: newPoints,
                penalties: (userData.penalties || 0) + 1
            });
            
            userData.points = newPoints;
            userData.penalties = (userData.penalties || 0) + 1;
            
            updateUserUI();
            await recordPenalty();
            
            if (currentAd.trackingId) {
                await db.collection('ad_tracking').doc(currentAd.trackingId).update({
                    penaltyApplied: true,
                    pointsDeducted: penaltyPoints,
                    status: 'penalized'
                });
            }
        }
        
        async function recordPenalty() {
            await db.collection('penalties_history').add({
                userId: currentUser.uid,
                type: 'ad_closure',
                points: penaltyPoints,
                reason: 'إغلاق الإعلان قبل انتهاء الوقت',
                adId: currentAd.id,
                adTitle: currentAd.title,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        function resetAdSystem() {
            clearInterval(countdownInterval);
            currentAd = null;
            timerValue = 30;
            totalTime = 30;
            isWindowFocused = true;
            penaltyPoints = 0;
            adTab = null;
            
            document.getElementById('captchaSection').classList.add('d-none');
            document.getElementById('captchaInput').value = '';
            document.querySelector('.timer-container').style.display = 'block';
            document.getElementById('timerProgress').style.width = '0%';
            document.getElementById('penaltyWarning').style.display = 'none';
            
            window.removeEventListener('blur', handleWindowBlur);
            window.removeEventListener('focus', handleWindowFocus);
            window.removeEventListener('beforeunload', handleBeforeUnload);
        }
        
        // ============================================
        // نظام السحب
        // ============================================
        document.getElementById('withdrawPoints').addEventListener('input', function() {
            const points = parseInt(this.value) || 20000;
            const dollars = (points / 20000).toFixed(2);
            document.getElementById('withdrawAmount').textContent = `المبلغ: ${dollars} دولار`;
        });
        
        async function requestWithdrawal() {
            if (!currentUser || !userData) {
                alert("يجب تسجيل الدخول أولاً");
                return;
            }
            
            const points = parseInt(document.getElementById('withdrawPoints').value);
            const phone = document.getElementById('vodafoneNumber').value.trim();
            
            if (points < 20000) {
                alert("الحد الأدنى للسحب هو 20,000 نقطة (1 دولار)");
                return;
            }
            
            if (userData.points < points) {
                alert("رصيدك الحالي غير كافي للسحب");
                return;
            }
            
            if (!phone || phone.length < 10) {
                alert("يرجى إدخال رقم هاتف صحيح لفودافون كاش");
                return;
            }
            
            const fee = points * 0.05;
            const netPoints = points - fee;
            const amount = (points / 20000).toFixed(2);
            const netAmount = (netPoints / 20000).toFixed(2);
            
            if (!confirm(`سحب ${points} نقطة (${amount} دولار)\nبعد خصم العمولة 5%: ${netPoints} نقطة (${netAmount} دولار)\nهل تريد المتابعة؟`)) {
                return;
            }
            
            try {
                const newPoints = userData.points - points;
                await db.collection('users').doc(currentUser.uid).update({
                    points: newPoints,
                    totalWithdrawals: (userData.totalWithdrawals || 0) + parseFloat(amount)
                });
                
                userData.points = newPoints;
                userData.totalWithdrawals = (userData.totalWithdrawals || 0) + parseFloat(amount);
                
                await db.collection('withdrawals').add({
                    userId: currentUser.uid,
                    userName: userData.name,
                    userEmail: userData.email,
                    points: points,
                    amount: parseFloat(amount),
                    netAmount: parseFloat(netAmount),
                    phone: phone,
                    status: 'pending',
                    fee: fee,
                    requestedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    adminNote: ''
                });
                
                await db.collection('points_history').add({
                    userId: currentUser.uid,
                    type: 'withdrawal',
                    points: -points,
                    balanceBefore: userData.points + points,
                    balanceAfter: userData.points,
                    notes: `طلب سحب إلى فودافون كاش: ${phone}`,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                updateUserUI();
                
                document.getElementById('vodafoneNumber').value = '';
                document.getElementById('withdrawPoints').value = '20000';
                document.getElementById('withdrawAmount').textContent = 'المبلغ: 1 دولار';
                
                showSuccessMessage("تم إرسال طلب السحب بنجاح! سيتم معالجته خلال 24-48 ساعة.");
                loadWithdrawHistory(currentUser.uid);
            } catch (error) {
                console.error("خطأ في طلب السحب:", error);
                alert("حدث خطأ في إرسال طلب السحب: " + error.message);
            }
        }
        
        async function loadWithdrawHistory(userId) {
            try {
                const snapshot = await db.collection('withdrawals')
                    .where('userId', '==', userId)
                    .orderBy('requestedAt', 'desc')
                    .limit(10)
                    .get();
                
                const tbody = document.getElementById('withdrawHistoryTable').querySelector('tbody');
                tbody.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = document.createElement('tr');
                    
                    const date = data.requestedAt ? data.requestedAt.toDate().toLocaleDateString('ar-EG') : '---';
                    const statusBadge = getStatusBadge(data.status);
                    
                    row.innerHTML = `
                        <td>${date}</td>
                        <td>${data.points.toLocaleString()}</td>
                        <td>$${data.amount}</td>
                        <td>${data.phone}</td>
                        <td>${statusBadge}</td>
                    `;
                    
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error("خطأ في تحميل سجل السحوبات:", error);
            }
        }
        
        function getStatusBadge(status) {
            switch(status) {
                case 'pending': return '<span class="badge bg-warning">قيد الانتظار</span>';
                case 'approved': return '<span class="badge bg-success">مقبول</span>';
                case 'rejected': return '<span class="badge bg-danger">مرفوض</span>';
                case 'completed': return '<span class="badge bg-info">مكتمل</span>';
                default: return '<span class="badge bg-secondary">' + status + '</span>';
            }
        }
        
        function calculatePoints() {
            const points = parseInt(document.getElementById('calcPoints').value) || 0;
            const dollars = (points / 20000).toFixed(2);
            const afterFees = (points * 0.95 / 20000).toFixed(2);
            
            document.getElementById('calcDollars').value = `${dollars} دولار`;
            document.getElementById('calcAfterFees').value = `${afterFees} دولار`;
        }
        
        // ============================================
        // نظام التاريخ والنشاطات
        // ============================================
        async function loadUserAdsHistory(userId) {
            try {
                const snapshot = await db.collection('ad_history')
                    .where('userId', '==', userId)
                    .orderBy('timestamp', 'desc')
                    .limit(20)
                    .get();
                
                const tbody = document.getElementById('adsHistoryBody');
                tbody.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = document.createElement('tr');
                    
                    const date = data.timestamp ? data.timestamp.toDate().toLocaleDateString('ar-EG') : '---';
                    const time = data.timestamp ? data.timestamp.toDate().toLocaleTimeString('ar-EG') : '---';
                    
                    row.innerHTML = `
                        <td>${date}<br><small>${time}</small></td>
                        <td>${data.adTitle}</td>
                        <td>+${data.points}</td>
                        <td>30 ثانية</td>
                        <td><span class="badge bg-success">مكتمل</span></td>
                    `;
                    
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error("خطأ في تحميل سجل الإعلانات:", error);
            }
        }
        
        async function loadPointsHistory(userId) {
            try {
                const snapshot = await db.collection('points_history')
                    .where('userId', '==', userId)
                    .orderBy('timestamp', 'desc')
                    .limit(20)
                    .get();
                
                const tbody = document.getElementById('pointsHistoryBody');
                tbody.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = document.createElement('tr');
                    
                    const date = data.timestamp ? data.timestamp.toDate().toLocaleDateString('ar-EG') : '---';
                    const typeText = getPointsTypeText(data.type);
                    const pointsClass = data.points > 0 ? 'text-success' : 'text-danger';
                    const pointsSign = data.points > 0 ? '+' : '';
                    
                    row.innerHTML = `
                        <td>${date}</td>
                        <td>${typeText}</td>
                        <td class="${pointsClass}">${pointsSign}${data.points}</td>
                        <td>${data.balanceBefore || 0}</td>
                        <td>${data.balanceAfter || 0}</td>
                    `;
                    
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error("خطأ في تحميل سجل النقاط:", error);
            }
        }
        
        async function loadPenaltiesHistory(userId) {
            try {
                const snapshot = await db.collection('penalties_history')
                    .where('userId', '==', userId)
                    .orderBy('timestamp', 'desc')
                    .limit(20)
                    .get();
                
                const tbody = document.getElementById('penaltiesHistoryBody');
                tbody.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = document.createElement('tr');
                    
                    const date = data.timestamp ? data.timestamp.toDate().toLocaleDateString('ar-EG') : '---';
                    
                    row.innerHTML = `
                        <td>${date}</td>
                        <td>${data.type}</td>
                        <td class="text-danger">-${data.points}</td>
                        <td>${data.reason}</td>
                    `;
                    
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error("خطأ في تحميل سجل العقوبات:", error);
            }
        }
        
        function getPointsTypeText(type) {
            switch(type) {
                case 'registration': return 'نقاط ترحيبية';
                case 'ad_watch': return 'مشاهدة إعلان';
                case 'withdrawal': return 'سحب نقاط';
                case 'referral': return 'إحالة';
                case 'bonus': return 'مكافأة';
                default: return type;
            }
        }
        
        function showHistoryTab(tabName) {
            document.querySelectorAll('#historyTabs button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            switch(tabName) {
                case 'ads':
                    if (currentUser) loadUserAdsHistory(currentUser.uid);
                    break;
                case 'points':
                    if (currentUser) loadPointsHistory(currentUser.uid);
                    break;
                case 'penalties':
                    if (currentUser) loadPenaltiesHistory(currentUser.uid);
                    break;
            }
        }
        
        // ============================================
        // الملف الشخصي والإعدادات
        // ============================================
        async function saveProfile() {
            if (!currentUser) return;
            
            const profileData = {
                name: document.getElementById('profileFullName').value,
                profile: {
                    phone: document.getElementById('profilePhone').value,
                    country: document.getElementById('profileCountry').value,
                    city: document.getElementById('profileCity').value
                }
            };
            
            try {
                await db.collection('users').doc(currentUser.uid).update(profileData);
                
                userData.name = profileData.name;
                if (!userData.profile) userData.profile = {};
                userData.profile.phone = profileData.profile.phone;
                userData.profile.country = profileData.profile.country;
                userData.profile.city = profileData.profile.city;
                
                updateUserUI();
                showSuccessMessage("تم حفظ التغييرات بنجاح!");
            } catch (error) {
                console.error("خطأ في حفظ الملف الشخصي:", error);
                alert("حدث خطأ في حفظ التغييرات: " + error.message);
            }
        }
        
        async function saveSettings() {
            if (!currentUser) return;
            
            const settingsData = {
                settings: {
                    emailNotifications: document.getElementById('emailNotifications').checked,
                    showProfile: document.getElementById('showProfile').checked
                }
            };
            
            try {
                await db.collection('users').doc(currentUser.uid).update(settingsData);
                
                if (!userData.settings) userData.settings = {};
                userData.settings.emailNotifications = settingsData.settings.emailNotifications;
                userData.settings.showProfile = settingsData.settings.showProfile;
                
                showSuccessMessage("تم حفظ الإعدادات بنجاح!");
            } catch (error) {
                console.error("خطأ في حفظ الإعدادات:", error);
                alert("حدث خطأ في حفظ الإعدادات: " + error.message);
            }
        }
        
        // ============================================
        // لوحة تحكم الإدمن
        // ============================================
        async function loadAdminDashboard() {
            try {
                const usersSnapshot = await db.collection('users').get();
                document.getElementById('totalUsers').textContent = usersSnapshot.size;
                
                const adsSnapshot = await db.collection('ads').where('status', '==', 'active').get();
                document.getElementById('activeAds').textContent = adsSnapshot.size;
                
                const withdrawalsSnapshot = await db.collection('withdrawals').where('status', '==', 'pending').get();
                document.getElementById('pendingWithdrawals').textContent = withdrawalsSnapshot.size;
                
                let totalPoints = 0;
                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    totalPoints += user.points || 0;
                });
                document.getElementById('totalSystemPoints').textContent = totalPoints.toLocaleString();
                
                loadAdminUsers();
                loadAdminAds();
                loadAdminWithdrawals();
                loadAdminReports();
            } catch (error) {
                console.error("خطأ في تحميل إحصائيات الإدمن:", error);
            }
        }
        
        async function loadAdminUsers() {
            try {
                const snapshot = await db.collection('users')
                    .orderBy('joinDate', 'desc')
                    .limit(50)
                    .get();
                
                const tbody = document.getElementById('adminUsersTable');
                tbody.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = document.createElement('tr');
                    
                    const joinDate = data.joinDate ? data.joinDate.toDate().toLocaleDateString('ar-EG') : '---';
                    const penalties = data.penalties || 0;
                    const penaltyBadge = penalties > 0 ? `<span class="penalty-badge">${penalties}</span>` : '';
                    
                    row.innerHTML = `
                        <td>${snapshot.docs.indexOf(doc) + 1}</td>
                        <td>${data.name}</td>
                        <td>${data.email}</td>
                        <td>${data.points.toLocaleString()} ${penaltyBadge}</td>
                        <td>${data.totalWithdrawals || 0}</td>
                        <td>${joinDate}</td>
                        <td><span class="badge bg-success">نشط</span></td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="viewUserDetails('${doc.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error("خطأ في تحميل المستخدمين:", error);
            }
        }
        
        async function loadAdminAds() {
            try {
                const snapshot = await db.collection('ads')
                    .orderBy('createdAt', 'desc')
                    .limit(50)
                    .get();
                
                const tbody = document.getElementById('adminAdsTable');
                tbody.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = document.createElement('tr');
                    
                    const createdAt = data.createdAt ? data.createdAt.toDate().toLocaleDateString('ar-EG') : '---';
                    const statusBadge = data.status === 'active' ? 
                        '<span class="badge bg-success">نشط</span>' : 
                        '<span class="badge bg-secondary">غير نشط</span>';
                    
                    row.innerHTML = `
                        <td>${snapshot.docs.indexOf(doc) + 1}</td>
                        <td>${data.title}</td>
                        <td><small>${data.url.substring(0, 30)}...</small></td>
                        <td>${data.points}</td>
                        <td>${data.duration} ثانية</td>
                        <td>${data.views || 0}/${data.maxViews || 1000}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-warning me-1">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteAd('${doc.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error("خطأ في تحميل الإعلانات:", error);
            }
        }
        
        async function loadAdminWithdrawals() {
            try {
                const snapshot = await db.collection('withdrawals')
                    .where('status', '==', 'pending')
                    .orderBy('requestedAt', 'desc')
                    .limit(50)
                    .get();
                
                const tbody = document.getElementById('adminWithdrawalsTable');
                tbody.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = document.createElement('tr');
                    
                    const requestedAt = data.requestedAt ? data.requestedAt.toDate().toLocaleDateString('ar-EG') : '---';
                    
                    row.innerHTML = `
                        <td>${snapshot.docs.indexOf(doc) + 1}</td>
                        <td>${data.userName}</td>
                        <td>${data.points.toLocaleString()}</td>
                        <td>$${data.amount} (صافي: $${data.netAmount})</td>
                        <td>${data.phone}</td>
                        <td>${requestedAt}</td>
                        <td><span class="badge bg-warning">قيد الانتظار</span></td>
                        <td>
                            <button class="btn btn-sm btn-success me-1" onclick="approveWithdrawal('${doc.id}')">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="rejectWithdrawal('${doc.id}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error("خطأ في تحميل طلبات السحب:", error);
            }
        }
        
        async function loadAdminReports() {
            try {
                const usersSnapshot = await db.collection('users')
                    .orderBy('totalEarned', 'desc')
                    .limit(10)
                    .get();
                
                const tbody = document.getElementById('topEarnersTable');
                tbody.innerHTML = '';
                
                usersSnapshot.forEach(doc => {
                    const data = doc.data();
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${data.name}</td>
                        <td>${(data.totalEarned || 0).toLocaleString()}</td>
                    `;
                    
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error("خطأ في تحميل التقارير:", error);
            }
        }
        
        async function addNewAd() {
            const adData = {
                title: document.getElementById('adTitle').value,
                url: document.getElementById('adUrl').value,
                points: parseInt(document.getElementById('adPoints').value),
                duration: parseInt(document.getElementById('adDuration').value),
                maxViews: parseInt(document.getElementById('adViewsLimit').value),
                description: document.getElementById('adDescription').value,
                category: document.getElementById('adCategory').value,
                views: 0,
                status: 'active',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            if (!adData.title || !adData.url || adData.points < 1 || adData.duration < 1) {
                alert("يرجى ملء جميع الحقول المطلوبة بشكل صحيح");
                return;
            }
            
            try {
                await db.collection('ads').add(adData);
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('addAdModal'));
                modal.hide();
                document.getElementById('addAdForm').reset();
                loadAdminAds();
                showSuccessMessage("تمت إضافة الإعلان بنجاح!");
            } catch (error) {
                console.error("خطأ في إضافة الإعلان:", error);
                alert("حدث خطأ في إضافة الإعلان: " + error.message);
            }
        }
        
        async function deleteAd(adId) {
            if (!confirm("هل أنت متأكد من حذف هذا الإعلان؟")) return;
            
            try {
                await db.collection('ads').doc(adId).update({
                    status: 'inactive'
                });
                
                loadAdminAds();
                showSuccessMessage("تم حذف الإعلان بنجاح!");
            } catch (error) {
                console.error("خطأ في حذف الإعلان:", error);
                alert("حدث خطأ في حذف الإعلان: " + error.message);
            }
        }
        
        async function approveWithdrawal(withdrawalId) {
            if (!confirm("هل أنت متأكد من قبول طلب السحب؟")) return;
            
            try {
                await db.collection('withdrawals').doc(withdrawalId).update({
                    status: 'approved',
                    approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    adminNote: 'تم القبول وتحويل المبلغ'
                });
                
                loadAdminWithdrawals();
                showSuccessMessage("تم قبول طلب السحب!");
            } catch (error) {
                console.error("خطأ في قبول طلب السحب:", error);
                alert("حدث خطأ في قبول طلب السحب: " + error.message);
            }
        }
        
        async function rejectWithdrawal(withdrawalId) {
            const reason = prompt("يرجى إدخال سبب الرفض:");
            if (!reason) return;
            
            try {
                const withdrawalDoc = await db.collection('withdrawals').doc(withdrawalId).get();
                const withdrawalData = withdrawalDoc.data();
                
                await db.collection('users').doc(withdrawalData.userId).update({
                    points: firebase.firestore.FieldValue.increment(withdrawalData.points)
                });
                
                await db.collection('withdrawals').doc(withdrawalId).update({
                    status: 'rejected',
                    rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    adminNote: reason
                });
                
                loadAdminWithdrawals();
                showSuccessMessage("تم رفض طلب السحب وإعادة النقاط للمستخدم!");
            } catch (error) {
                console.error("خطأ في رفض طلب السحب:", error);
                alert("حدث خطأ في رفض طلب السحب: " + error.message);
            }
        }
        
        async function viewUserDetails(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                const userData = userDoc.data();
                
                const content = `
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(userData.name)}&background=3498db&color=fff&size=100" 
                                 class="rounded-circle mb-3" alt="صورة المستخدم">
                            <h5>${userData.name}</h5>
                            <p class="text-muted">${userData.email}</p>
                        </div>
                        <div class="col-md-8">
                            <table class="table table-sm">
                                <tr>
                                    <th>النقاط الحالية:</th>
                                    <td>${userData.points.toLocaleString()}</td>
                                </tr>
                                <tr>
                                    <th>إجمالي الأرباح:</th>
                                    <td>${(userData.totalEarned || 0).toLocaleString()}</td>
                                </tr>
                                <tr>
                                    <th>إجمالي السحوبات:</th>
                                    <td>${(userData.totalWithdrawals || 0).toFixed(2)} دولار</td>
                                </tr>
                                <tr>
                                    <th>عدد العقوبات:</th>
                                    <td>${userData.penalties || 0}</td>
                                </tr>
                                <tr>
                                    <th>تاريخ الانضمام:</th>
                                    <td>${userData.joinDate ? userData.joinDate.toDate().toLocaleDateString('ar-EG') : '---'}</td>
                                </tr>
                                <tr>
                                    <th>آخر دخول:</th>
                                    <td>${userData.lastLogin ? userData.lastLogin.toDate().toLocaleDateString('ar-EG') : '---'}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                `;
                
                document.getElementById('userDetailsContent').innerHTML = content;
                const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
                modal.show();
            } catch (error) {
                console.error("خطأ في تحميل تفاصيل المستخدم:", error);
            }
        }
        
        // ============================================
        // وظائف مساعدة
        // ============================================
        function showSuccessMessage(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-custom position-fixed';
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                ${message}
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
        
        function showErrorMessage(message) {
            alert(message);
        }
        
        function showLoading() {
            // يمكنك إضافة شاشة تحميل هنا
        }
        
        function hideLoading() {
            // إزالة شاشة التحميل
        }
        
        function initializeWebsite() {
            calculatePoints();
            showSection('dashboard');
            
            setTimeout(() => {
                document.querySelectorAll('.dashboard-card').forEach((card, index) => {
                    card.style.animationDelay = `${index * 0.1}s`;
                });
            }, 100);
        }

        // 1. وظيفة فك تشفير بيانات المستخدم من توكن جوجل
function parseJwt(token) {
    try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));

        return JSON.parse(jsonPayload);
    } catch (e) {
        console.error("خطأ في فك تشفير التوكن:", e);
        return null;
    }
}

// 2. معالجة استجابة جوجل بعد اختيار الحساب
async function handleCredentialResponse(response) {
    try {
        const userData = parseJwt(response.credential);
        if (!userData) return;

        // هيكلة البيانات الكاملة التي طلبتها
        const currentUser = {
            uid: userData.sub,           // معرف المستخدم الفريد
            email: userData.email,       // البريد الإلكتروني
            points: 0,                   // النقاط الحالية
            totalEarned: 0,              // إجمالي النقاط المكتسبة
            dailyStats: {                // إحصائيات يومية فارغة في البداية
                date: new Date().toISOString().split('T')[0],
                adsWatched: 0,
                pointsEarned: 0
            },
            createdAt: new Date().toISOString() // تاريخ التسجيل
        };

        console.log("تم تسجيل الدخول بنجاح:", currentUser);

        // التحقق من الأدمن (البريد الذي حددته)
        if (currentUser.email === 'bo2584668@gmail.com') {
            console.log("مرحباً بالأدمن");
            // هنا تضع كود فتح لوحة التحكم
        } else {
            console.log("مرحباً بالمستخدم");
            // هنا تضع كود فتح صفحة المستخدم
        }

    } catch (error) {
        console.error("حدث خطأ أثناء معالجة تسجيل الدخول:", error);
    }
}

// 3. تهيئة ورسم زر جوجل (مع ميزة الانتظار لضمان الظهور)
function startGoogleSignIn() {
    const checkInterval = setInterval(() => {
        const buttonDiv = document.getElementById("buttonDiv");
        
        // التأكد من وجود العنصر ومن تحميل مكتبة جوجل
        if (buttonDiv && typeof google !== 'undefined' && google.accounts) {
            
            google.accounts.id.initialize({
                client_id: "805966277330-9j5j1nvluj69f8uieog0kk77p0jb46q4.apps.googleusercontent.com",
                callback: handleCredentialResponse,
                auto_select: false,
                context: "signin"
            });

            google.accounts.id.renderButton(buttonDiv, {
                theme: "filled_blue",
                size: "large",
                text: "signin_with",
                shape: "rectangular",
                width: "250"
            });

            google.accounts.id.prompt(); // إظهار نافذة One-tap اختياريًا
            
            clearInterval(checkInterval); // إيقاف البحث بمجرد نجاح الرسم
            console.log("✅ تم تشغيل نظام جوجل بنجاح");
        }
    }, 1000); // يفحص كل ثانية واحدة
}

// تشغيل السكريبت
startGoogleSignIn();

        // ============================================
        // تهيئة التطبيق
        // ============================================
        window.onload = function() {
            firebase.initializeApp(firebaseConfig);
            
            const checkGoogleLoad = setInterval(() => {
                if (typeof google !== 'undefined' && google.accounts) {
                    initializeGoogleSignIn();
                    clearInterval(checkGoogleLoad);
                }
            }, 100);
            
            initializeWebsite();
        };
    </script>
</body>
                                        </html>
