<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Advista - كسب المال من مشاهدة الإعلانات</title>
    
    <!-- Firebase & Google Sign-In -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Segoe UI', 'Cairo', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            touch-action: manipulation;
            overflow-x: hidden;
            color: #333;
            line-height: 1.6;
        }
        
        /* Disable Zoom and Selection */
        body.no-zoom {
            touch-action: pan-x pan-y;
            max-zoom: 1;
            min-zoom: 1;
        }
        
        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }
        
        /* Login Screen */
        #loginScreen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px 30px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            max-width: 450px;
            width: 100%;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .logo {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .logo-icon {
            font-size: 4rem;
            color: #667eea;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .logo h1 {
            color: #667eea;
            font-size: 2.5rem;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .points-display {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            padding: 10px 20px;
            border-radius: 50px;
            color: #333;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 3px 10px rgba(255, 165, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.3s ease;
        }
        
        .points-display:hover {
            transform: scale(1.05);
        }
        
        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            animation: fadeInUp 0.5s ease;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }
        
        .card-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            background: white;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .stat-item:hover {
            transform: translateY(-3px);
        }
        
        .stat-item h3 {
            color: #666;
            font-size: 0.95rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
        }
        
        /* Ads Grid */
        .ads-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .ad-card {
            background: white;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .ad-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        
        .ad-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
        }
        
        .ad-title {
            font-weight: bold;
            color: #333;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        
        .ad-reward {
            color: #FFD700;
            font-weight: bold;
            background: rgba(255, 215, 0, 0.1);
            padding: 6px 12px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.95rem;
        }
        
        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-50px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .timer {
            font-size: 3.5rem;
            font-weight: bold;
            color: #667eea;
            margin: 25px 0;
            font-family: 'Courier New', monospace;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Buttons */
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:hover::after {
            width: 300px;
            height: 300px;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn:active {
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #FF416C, #FF4B2B);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #00b09b, #96c93d);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #FFD700, #FFA500);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
        }
        
        /* Inputs */
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
            background: white;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        /* Loading */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            flex-direction: column;
            gap: 20px;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        /* Alert Messages */
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            animation: slideInRight 0.3s ease;
            position: relative;
            padding-right: 40px;
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .alert-close {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 10px 10px 0 0;
            background: #f5f5f5;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .tab:hover {
            background: #e9ecef;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }
        
        .tab-content {
            animation: fadeIn 0.3s ease;
        }
        
        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 600px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
        }
        
        th {
            background: #667eea;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        
        tbody tr {
            transition: background 0.3s ease;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        tbody tr:last-child td {
            border-bottom: none;
        }
        
        /* Status Badges */
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            display: inline-block;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-approved {
            background: #d4edda;
            color: #155724;
        }
        
        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        
        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background: #333;
            color: white;
            text-align: center;
            padding: 10px;
            border-radius: 6px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9rem;
            font-weight: normal;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            background: #667eea;
            color: white;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-right: 5px;
        }
        
        /* Admin Panel */
        .admin-panel {
            display: none;
        }
        
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .admin-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .admin-card:hover {
            transform: translateY(-5px);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                flex-direction: column;
                text-align: center;
                padding: 15px;
            }
            
            .user-info {
                justify-content: center;
                width: 100%;
            }
            
            .ads-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                padding: 20px;
                width: 95%;
            }
            
            .timer {
                font-size: 2.5rem;
            }
            
            .login-card {
                padding: 25px 20px;
            }
            
            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
                padding-bottom: 5px;
            }
            
            .tab {
                white-space: nowrap;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        @media (max-width: 480px) {
            .logo h1 {
                font-size: 2rem;
            }
            
            .logo-icon {
                font-size: 3rem;
            }
            
            .card-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .points-display {
                font-size: 1rem;
                padding: 8px 15px;
            }
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }
        
        /* Selection (only for allowed elements) */
        ::selection {
            background: rgba(102, 126, 234, 0.3);
            color: #333;
        }
        
        /* Custom Checkbox */
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            cursor: pointer;
        }
        
        .checkbox-container input[type="checkbox"] {
            width: auto;
            transform: scale(1.2);
        }
        
        /* Divider */
        .divider {
            height: 1px;
            background: linear-gradient(to right, transparent, #e0e0e0, transparent);
            margin: 20px 0;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #ddd;
        }
        
        /* Notification Bell */
        .notification-bell {
            position: relative;
            cursor: pointer;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #FF416C;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Gradient Text */
        .gradient-text {
            background: linear-gradient(45deg, #667eea, #FF416C);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Flip Card */
        .flip-card {
            perspective: 1000px;
            height: 200px;
        }
        
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.8s;
            transform-style: preserve-3d;
        }
        
        .flip-card:hover .flip-card-inner {
            transform: rotateY(180deg);
        }
        
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .flip-card-front {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .flip-card-back {
            background: white;
            color: #333;
            transform: rotateY(180deg);
        }
        
        /* Pulse Animation */
        .pulse {
            animation: pulse 2s infinite;
        }
        
        /* Shake Animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .shake {
            animation: shake 0.5s;
        }
        
        /* Countdown Animation */
        @keyframes countdown {
            from { width: 100%; }
            to { width: 0%; }
        }
        
        .countdown-bar {
            height: 5px;
            background: #667eea;
            border-radius: 3px;
            animation: countdown 30s linear;
        }
        
        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 100;
            transition: all 0.3s ease;
        }
        
        .fab:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        /* Step Wizard */
        .step-wizard {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
            position: relative;
        }
        
        .step-wizard::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e0e0e0;
            z-index: 1;
        }
        
        .step {
            position: relative;
            z-index: 2;
            text-align: center;
            flex: 1;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .step.active .step-number {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }
        
        .step.completed .step-number {
            background: #00b09b;
            border-color: #00b09b;
            color: white;
        }
        
        /* Glass Effect */
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Grid Layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        
        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }
        }
        
        /* Text Utilities */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        .text-bold { font-weight: bold; }
        .text-muted { color: #666; }
        .text-small { font-size: 0.9rem; }
        .text-large { font-size: 1.2rem; }
        
        /* Margin & Padding Utilities */
        .m-0 { margin: 0; }
        .m-1 { margin: 5px; }
        .m-2 { margin: 10px; }
        .m-3 { margin: 15px; }
        .m-4 { margin: 20px; }
        
        .p-0 { padding: 0; }
        .p-1 { padding: 5px; }
        .p-2 { padding: 10px; }
        .p-3 { padding: 15px; }
        .p-4 { padding: 20px; }
        
        .mt-1 { margin-top: 5px; }
        .mt-2 { margin-top: 10px; }
        .mt-3 { margin-top: 15px; }
        .mt-4 { margin-top: 20px; }
        
        .mb-1 { margin-bottom: 5px; }
        .mb-2 { margin-bottom: 10px; }
        .mb-3 { margin-bottom: 15px; }
        .mb-4 { margin-bottom: 20px; }
        
        /* Flex Utilities */
        .d-flex { display: flex; }
        .flex-column { flex-direction: column; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .align-center { align-items: center; }
        .gap-1 { gap: 5px; }
        .gap-2 { gap: 10px; }
        .gap-3 { gap: 15px; }
        .gap-4 { gap: 20px; }
        
        /* Width Utilities */
        .w-100 { width: 100%; }
        .w-75 { width: 75%; }
        .w-50 { width: 50%; }
        .w-25 { width: 25%; }
        
        /* Special Effects */
        .hover-lift {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .hover-lift:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .shadow-sm { box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .shadow-md { box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .shadow-lg { box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        
        .rounded-sm { border-radius: 5px; }
        .rounded-md { border-radius: 10px; }
        .rounded-lg { border-radius: 15px; }
        .rounded-circle { border-radius: 50%; }
        
        /* Custom Scrollbar for specific elements */
        .custom-scroll {
            scrollbar-width: thin;
            scrollbar-color: #667eea #f1f1f1;
        }
        
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }
        
        /* Print Styles */
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
            
            .card, .modal-content {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }
        }
        
        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                color: #f0f0f0;
            }
            
            .card, .login-card, .modal-content, .stat-item, .ad-card {
                background: rgba(30, 30, 46, 0.95);
                color: #f0f0f0;
            }
            
            .card-header h2, .ad-title, th {
                color: #f0f0f0;
            }
            
            input, select, textarea {
                background: #2d2d44;
                border-color: #444;
                color: #f0f0f0;
            }
            
            table {
                background: #2d2d44;
            }
            
            th {
                background: #667eea;
            }
            
            td {
                border-color: #444;
            }
        }
        
        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* Focus Styles for Accessibility */
        button:focus, input:focus, select:focus, textarea:focus {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }
        
        /* Custom Animations */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .float {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }
        
        .shimmer {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }
    </style>
</head>
<body class="no-zoom" oncontextmenu="return false;" onselectstart="return false;" ondragstart="return false;">
    <!-- Loading Overlay -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">جاري التحميل...</div>
    </div>

    <!-- Alert Container -->
    <div id="alertContainer" style="position: fixed; top: 20px; right: 20px; max-width: 400px; z-index: 9999;"></div>

    <!-- Login Screen -->
<!--    <div id="loginScreen">
        <div class="login-card">
            <div class="logo">
                <i class="fas fa-gem logo-icon float"></i>
                <h1 class="gradient-text">Advista</h1>
                <p style="color: #666; font-size: 1.1rem; max-width: 300px; margin: 0 auto;">منصة كسب المال من مشاهدة الإعلانات</p>
            </div>
            
            <div style="margin: 30px 0;">
                <h2 style="color: #333; margin-bottom: 10px;">سجل الدخول لتبدأ الربح</h2>
                <p style="color: #666; margin-bottom: 25px;">سجل دخولك باستخدام حساب جوجل للبدء في كسب النقاط</p>
                
                <div id="googleSignInButton" style="margin: 25px 0;">
                    <div id="buttonDiv"></div>
                </div>
                
                <div style="color: #666; font-size: 0.9rem; margin-top: 20px;">
                    <p>بالتسجيل فإنك توافق على <a href="#" style="color: #667eea;">شروط الاستخدام</a> و <a href="#" style="color: #667eea;">سياسة الخصوصية</a></p>
                </div>
            </div> --/
            
            <!-- Stats Info -->
            <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); padding: 20px; border-radius: 10px; margin-top: 30px;">
                <h3 style="color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; justify-content: center;">
                    <i class="fas fa-chart-line"></i> إحصائيات المنصة
                </h3>
                <div class="grid-2" style="gap: 15px;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.8rem; font-weight: bold; color: #667eea;" id="totalUsersStat">10,000+</div>
                        <div style="color: #666; font-size: 0.9rem;">مستخدم نشط</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.8rem; font-weight: bold; color: #00b09b;" id="totalPaidStat">$50,000+</div>
                        <div style="color: #666; font-size: 0.9rem;">إجمالي المدفوعات</div>
                    </div>
                </div>
            </div> */
            
            <!-- Features -->
            <div style="margin-top: 30px;">
                <div class="grid-2" style="gap: 15px; margin-bottom: 20px;">
                    <div style="text-align: center; padding: 15px; background: rgba(0, 176, 155, 0.1); border-radius: 10px;">
                        <i class="fas fa-bolt" style="color: #00b09b; font-size: 1.5rem; margin-bottom: 8px;"></i>
                        <div style="font-weight: bold; color: #333;">سحب سريع</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: rgba(255, 215, 0, 0.1); border-radius: 10px;">
                        <i class="fas fa-users" style="color: #FFD700; font-size: 1.5rem; margin-bottom: 8px;"></i>
                        <div style="font-weight: bold; color: #333;">نظام إحالة</div>
                    </div>
                </div>
                
                <div class="grid-2" style="gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: rgba(255, 65, 108, 0.1); border-radius: 10px;">
                        <i class="fas fa-shield-alt" style="color: #FF416C; font-size: 1.5rem; margin-bottom: 8px;"></i>
                        <div style="font-weight: bold; color: #333;">آمن</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 10px;">
                        <i class="fas fa-headset" style="color: #667eea; font-size: 1.5rem; margin-bottom: 8px;"></i>
                        <div style="font-weight: bold; color: #333;">دعم فني</div>
                    </div>
                </div>
            </div>
            
            <!-- Footer Info -->
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                <p style="color: #999; font-size: 0.85rem; text-align: center;">
                    <i class="fas fa-lock"></i> معلوماتك محمية ولا يتم مشاركتها مع أي طرف ثالث
                </p>
            </div>
        </div>
    </div>

    <!-- User Dashboard (Hidden by default) -->
    <div id="userDashboard" style="display: none;">
        <!-- Floating Action Button -->
        <div class="fab no-print" onclick="showWithdrawalModal()" title="طلب سحب">
            <i class="fas fa-wallet"></i>
        </div>
        
        <!-- Notification Bell -->
        <div class="fab" style="left: 90px; background: linear-gradient(45deg, #FF416C, #FF4B2B);" onclick="showNotifications()" title="الإشعارات">
            <i class="fas fa-bell"></i>
            <div class="notification-badge" id="notificationBadge" style="display: none;">0</div>
        </div>

        <div class="container">
            <!-- Alert Messages -->
            <div id="mainAlert" class="alert" style="display: none;"></div>
            
            <!-- Header -->
            <div class="header">
                <div class="d-flex align-center gap-2">
                    <i class="fas fa-gem" style="font-size: 2rem; color: #667eea;"></i>
                    <div>
                        <h1 style="margin: 0; color: #667eea; font-size: 1.5rem;">Advista</h1>
                        <p style="margin: 5px 0 0; color: #666; font-size: 0.9rem;" id="userEmail"></p>
                    </div>
                </div>
                
                <div class="user-info">
                    <div class="points-display tooltip" data-tooltip="انقر لعرض تفاصيل النقاط" onclick="showPointsDetails()">
                        <i class="fas fa-coins"></i>
                        <span id="userPoints">0</span> نقطة
                    </div>
                    
                    <div class="d-flex align-center gap-1">
                        <button onclick="showProfileModal()" class="btn btn-secondary" style="padding: 8px 15px;">
                            <i class="fas fa-user"></i>
                            <span class="hide-on-mobile">الملف الشخصي</span>
                        </button>
                        <button onclick="logout()" class="btn btn-danger" style="padding: 8px 15px;">
                            <i class="fas fa-sign-out-alt"></i>
                            <span class="hide-on-mobile">خروج</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-item">
                    <h3><i class="fas fa-chart-line"></i> إجمالي الأرباح</h3>
                    <div class="stat-value" id="totalEarned">0 نقطة</div>
                    <div class="progress-bar mt-2">
                        <div class="progress-fill" id="totalEarnedProgress" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="stat-item">
                    <h3><i class="fas fa-calendar-day"></i> أرباح اليوم</h3>
                    <div class="stat-value" id="dailyEarned">0 نقطة</div>
                    <div class="progress-bar mt-2">
                        <div class="progress-fill" id="dailyEarnedProgress" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="stat-item">
                    <h3><i class="fas fa-users"></i> الإحالات</h3>
                    <div class="stat-value" id="referralCount">0 مستخدم</div>
                    <div class="d-flex align-center gap-1 mt-2">
                        <span style="color: #666; font-size: 0.9rem;">+500 نقطة لكل إحالة</span>
                    </div>
                </div>
                
                <div class="stat-item">
                    <h3><i class="fas fa-ad"></i> الإعلانات المتاحة</h3>
                    <div class="stat-value" id="adsCount">0 إعلان</div>
                    <div class="d-flex align-center gap-1 mt-2">
                        <span style="color: #666; font-size: 0.9rem;">30 ثانية لكل إعلان</span>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card" style="margin-bottom: 15px;">
                <div class="d-flex justify-between align-center flex-wrap gap-2">
                    <div>
                        <h3 style="margin: 0; color: #333;"><i class="fas fa-bolt"></i> إجراءات سريعة</h3>
                    </div>
                    <div class="d-flex gap-1">
                        <button onclick="showWithdrawalModal()" class="btn btn-success">
                            <i class="fas fa-wallet"></i> سحب الرصيد
                        </button>
                        <button onclick="switchTab('referral')" class="btn">
                            <i class="fas fa-share-alt"></i> رابط الإحالة
                        </button>
                        <button onclick="loadAds()" class="btn btn-secondary">
                            <i class="fas fa-sync-alt"></i> تحديث
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs" id="mainTabs">
                <div class="tab active" onclick="switchTab('ads')">
                    <i class="fas fa-ad"></i>
                    <span>الإعلانات</span>
                </div>
                <div class="tab" onclick="switchTab('referral')">
                    <i class="fas fa-share-alt"></i>
                    <span>نظام الإحالة</span>
                </div>
                <div class="tab" onclick="switchTab('history')">
                    <i class="fas fa-history"></i>
                    <span>سجل العمليات</span>
                </div>
                <div class="tab" onclick="switchTab('help')">
                    <i class="fas fa-question-circle"></i>
                    <span>المساعدة</span>
                </div>
            </div>

            <!-- Ads Tab -->
            <div id="adsTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-ad"></i> الإعلانات المتاحة للمشاهدة</h2>
                        <div style="color: #666; font-size: 0.9rem;">
                            <i class="fas fa-info-circle"></i>
                            <span id="availableAdsText">جاري تحميل الإعلانات...</span>
                        </div>
                    </div>
                    
                    <!-- Ad Filters -->
                    <div class="d-flex align-center gap-2 mb-3 flex-wrap">
                        <div style="position: relative; flex: 1; min-width: 200px;">
                            <input type="text" id="adSearch" placeholder="ابحث في الإعلانات..." 
                                   style="padding-right: 40px;">
                            <i class="fas fa-search" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #666;"></i>
                        </div>
                        <select id="adFilter" style="width: auto; min-width: 150px;">
                            <option value="all">جميع الإعلانات</option>
                            <option value="high">أعلى مكافأة</option>
                            <option value="low">أقل مكافأة</option>
                        </select>
                    </div>
                    
                    <!-- Ads Container -->
                    <div id="adsContainer" class="ads-grid">
                        <!-- Ads will be loaded here -->
                    </div>
                    
                    <!-- No Ads Message -->
                    <div id="noAdsMessage" class="empty-state" style="display: none;">
                        <i class="fas fa-ad"></i>
                        <h3 style="color: #666; margin-bottom: 10px;">لا توجد إعلانات متاحة حالياً</h3>
                        <p style="color: #999;">يرجى العودة لاحقًا لمشاهدة إعلانات جديدة</p>
                        <button onclick="loadAds()" class="btn mt-3">
                            <i class="fas fa-sync-alt"></i> تحديث الصفحة
                        </button>
                    </div>
                    
                    <!-- Ads Info -->
                    <div class="divider"></div>
                    <div class="d-flex justify-between align-center flex-wrap gap-2 mt-3">
                        <div style="color: #666; font-size: 0.9rem;">
                            <i class="fas fa-info-circle"></i>
                            سيتم تجديد الإعلانات بعد: <span id="adsRefreshTime">24:00:00</span>
                        </div>
                        <div style="color: #666; font-size: 0.9rem;">
                            <i class="fas fa-clock"></i>
                            الحد الأقصى اليومي: <span id="dailyLimit">10</span> إعلان
                        </div>
                    </div>
                </div>
            </div>

            <!-- Referral Tab -->
            <div id="referralTab" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-share-alt"></i> نظام الإحالة</h2>
                    </div>
                    
                    <!-- Referral Stats -->
                    <div class="grid-3 mb-4">
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-radius: 10px;">
                            <div style="font-size: 2rem; font-weight: bold; color: #667eea;" id="totalReferrals">0</div>
                            <div style="color: #666; font-size: 0.9rem;">إجمالي الإحالات</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(0, 176, 155, 0.1) 0%, rgba(150, 201, 61, 0.1) 100%); border-radius: 10px;">
                            <div style="font-size: 2rem; font-weight: bold; color: #00b09b;" id="referralEarnings">0</div>
                            <div style="color: #666; font-size: 0.9rem;">نقاط الإحالة</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 165, 0, 0.1) 100%); border-radius: 10px;">
                            <div style="font-size: 2rem; font-weight: bold; color: #FFD700;">500</div>
                            <div style="color: #666; font-size: 0.9rem;">نقطة لكل إحالة</div>
                        </div>
                    </div>
                    
                    <!-- Referral Link -->
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-link"></i> رابط الإحالة الخاص بك
                        </h3>
                        <div class="input-group">
                            <input type="text" id="referralLink" readonly class="allow-copy"
                                   style="flex: 1; background: #f8f9fa; font-weight: bold; font-size: 0.95rem;">
                            <button onclick="copyReferralLink()" class="btn btn-warning">
                                <i class="far fa-copy"></i> نسخ
                            </button>
                            <button onclick="shareReferralLink()" class="btn btn-success">
                                <i class="fas fa-share"></i> مشاركة
                            </button>
                        </div>
                        <p style="color: #666; font-size: 0.9rem; margin-top: 8px;">
                            <i class="fas fa-info-circle"></i>
                            سيحصل صديقك على 100 نقطة هدية عند التسجيل باستخدام رابطك
                        </p>
                    </div>
                    
                    <!-- Referral Steps -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #333; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-list-ol"></i> خطوات كسب نقاط الإحالة
                        </h3>
                        <div class="step-wizard">
                            <div class="step active">
                                <div class="step-number">1</div>
                                <div style="color: #333; font-weight: 500;">انشر الرابط</div>
                            </div>
                            <div class="step">
                                <div class="step-number">2</div>
                                <div style="color: #333; font-weight: 500;">يسجل صديقك</div>
                            </div>
                            <div class="step">
                                <div class="step-number">3</div>
                                <div style="color: #333; font-weight: 500;">احصل على 500 نقطة</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Referral History -->
                    <div>
                        <h3 style="color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-history"></i> سجل الإحالات
                        </h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>التاريخ</th>
                                        <th>المستخدم</th>
                                        <th>النقاط</th>
                                        <th>الحالة</th>
                                    </tr>
                                </thead>
                                <tbody id="referralsHistoryBody">
                                    <tr>
                                        <td colspan="4" style="text-align: center; padding: 30px; color: #666;">
                                            <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                                            لا توجد إحالات حتى الآن
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="historyTab" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-history"></i> سجل العمليات</h2>
                        <div class="d-flex gap-1">
                            <button onclick="exportHistory()" class="btn btn-secondary" style="padding: 8px 15px;">
                                <i class="fas fa-download"></i>
                                <span class="hide-on-mobile">تصدير</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- History Tabs -->
                    <div class="tabs" style="margin-bottom: 20px; border: none; padding: 0;">
                        <div class="tab active" onclick="showHistory('clicks')">مشاهدات الإعلانات</div>
                        <div class="tab" onclick="showHistory('withdrawals')">طلبات السحب</div>
                        <div class="tab" onclick="showHistory('earnings')">كسب النقاط</div>
                    </div>
                    
                    <!-- History Content -->
                    <div id="clicksHistory">
                        <div class="d-flex justify-between align-center mb-3">
                            <h4 style="color: #333; margin: 0;">آخر المشاهدات</h4>
                            <div style="color: #666; font-size: 0.9rem;">
                                إجمالي النقاط: <span id="totalClicksPoints">0</span>
                            </div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>التاريخ</th>
                                        <th>الإعلان</th>
                                        <th>النقاط</th>
                                        <th>الحالة</th>
                                    </tr>
                                </thead>
                                <tbody id="clicksHistoryBody">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="withdrawalsHistory" style="display: none;">
                        <div class="d-flex justify-between align-center mb-3">
                            <h4 style="color: #333; margin: 0;">طلبات السحب</h4>
                            <div style="color: #666; font-size: 0.9rem;">
                                إجمالي المسحوب: <span id="totalWithdrawn">0</span> نقطة
                            </div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>التاريخ</th>
                                        <th>المبلغ</th>
                                        <th>رقم الهاتف</th>
                                        <th>الحالة</th>
                                        <th>ملاحظات</th>
                                    </tr>
                                </thead>
                                <tbody id="withdrawalsHistoryBody">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="earningsHistory" style="display: none;">
                        <div class="d-flex justify-between align-center mb-3">
                            <h4 style="color: #333; margin: 0;">كسب النقاط</h4>
                            <div style="color: #666; font-size: 0.9rem;">
                                إجمالي الأرباح: <span id="totalEarnings">0</span> نقطة
                            </div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>التاريخ</th>
                                        <th>المصدر</th>
                                        <th>النقاط</th>
                                        <th>النوع</th>
                                    </tr>
                                </thead>
                                <tbody id="earningsHistoryBody">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Help Tab -->
            <div id="helpTab" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-question-circle"></i> مركز المساعدة</h2>
                    </div>
                    
                    <!-- FAQ -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #333; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-question"></i> الأسئلة الشائعة
                        </h3>
                        
                        <div style="margin-bottom: 15px; background: #f8f9fa; padding: 15px; border-radius: 10px;">
                            <h4 style="color: #667eea; margin-bottom: 8px; cursor: pointer;" onclick="toggleFAQ(1)">
                                <i class="fas fa-chevron-down" style="transition: transform 0.3s;"></i>
                                كيف يمكنني كسب النقاط؟
                            </h4>
                            <div id="faq1" style="display: none; color: #666; padding-right: 20px;">
                                يمكنك كسب النقاط عن طريق:
                                <ul style="margin-top: 8px; padding-right: 20px;">
                                    <li>مشاهدة الإعلانات (5-25 نقطة لكل إعلان)</li>
                                    <li>إحالة الأصدقاء (500 نقطة لكل صديق)</li>
                                    <li>المشاركة اليومية (50 نقطة يومياً)</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px; background: #f8f9fa; padding: 15px; border-radius: 10px;">
                            <h4 style="color: #667eea; margin-bottom: 8px; cursor: pointer;" onclick="toggleFAQ(2)">
                                <i class="fas fa-chevron-down" style="transition: transform 0.3s;"></i>
                                ما هو الحد الأدنى للسحب؟
                            </h4>
                            <div id="faq2" style="display: none; color: #666; padding-right: 20px;">
                                الحد الأدنى للسحب هو 30,000 نقطة (ما يعادل 1 دولار).
                                يمكنك السحب عبر فودافون كاش فقط.
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px; background: #f8f9fa; padding: 15px; border-radius: 10px;">
                            <h4 style="color: #667eea; margin-bottom: 8px; cursor: pointer;" onclick="toggleFAQ(3)">
                                <i class="fas fa-chevron-down" style="transition: transform 0.3s;"></i>
                                كم تستغرق عملية السحب؟
                            </h4>
                            <div id="faq3" style="display: none; color: #666; padding-right: 20px;">
                                تستغرق عملية السحب من 24 إلى 48 ساعة بعد تقديم الطلب.
                                سيتم التواصل معك عبر الواتساب للتحقق.
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px; background: #f8f9fa; padding: 15px; border-radius: 10px;">
                            <h4 style="color: #667eea; margin-bottom: 8px; cursor: pointer;" onclick="toggleFAQ(4)">
                                <i class="fas fa-chevron-down" style="transition: transform 0.3s;"></i>
                                هل يمكنني مشاهدة أكثر من إعلان في نفس الوقت؟
                            </h4>
                            <div id="faq4" style="display: none; color: #666; padding-right: 20px;">
                                لا، يمكنك مشاهدة إعلان واحد فقط في كل مرة.
                                إذا حاولت مشاهدة أكثر من إعلان سيتم حظر حسابك.
                            </div>
                        </div>
                    </div>
                    
                    <!-- Contact Information -->
                    <div>
                        <h3 style="color: #333; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-headset"></i> تواصل معنا
                        </h3>
                        
                        <div class="grid-2" style="gap: 15px; margin-bottom: 20px;">
                            <a href="mailto:bo2584668@gmail.com" class="btn" style="display: flex; flex-direction: column; align-items: center; padding: 20px;">
                                <i class="fas fa-envelope" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <span>البريد الإلكتروني</span>
                                <small style="margin-top: 5px; opacity: 0.8; font-size: 0.85rem;">bo2584668@gmail.com</small>
                            </a>
                            
                            <a href="https://wa.me/201273740256" target="_blank" class="btn btn-success" style="display: flex; flex-direction: column; align-items: center; padding: 20px;">
                                <i class="fab fa-whatsapp" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <span>واتساب</span>
                                <small style="margin-top: 5px; opacity: 0.8; font-size: 0.85rem;">+201273740256</small>
                            </a>
                        </div>
                        
                        <div class="grid-2" style="gap: 15px;">
                            <a href="https://instagram.com/Baraa___offical" target="_blank" class="btn btn-danger" style="display: flex; flex-direction: column; align-items: center; padding: 20px;">
                                <i class="fab fa-instagram" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <span>إنستجرام</span>
                                <small style="margin-top: 5px; opacity: 0.8; font-size: 0.85rem;">Baraa___offical</small>
                            </a>
                            
                            <a href="#" onclick="showReportModal()" class="btn btn-warning" style="display: flex; flex-direction: column; align-items: center; padding: 20px;">
                                <i class="fas fa-flag" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <span>بلاغ عن مشكلة</span>
                                <small style="margin-top: 5px; opacity: 0.8; font-size: 0.85rem;">الإبلاغ عن مشكلة</small>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Terms -->
                    <div class="divider"></div>
                    <div style="margin-top: 20px;">
                        <h4 style="color: #333; margin-bottom: 10px;">شروط الاستخدام</h4>
                        <p style="color: #666; font-size: 0.9rem;">
                            باستخدامك لهذه المنصة فإنك توافق على:
                            <ul style="color: #666; font-size: 0.9rem; padding-right: 20px; margin-top: 10px;">
                                <li>عدم استخدام أي برامج أو أدوات تلقائية</li>
                                <li>عدم إنشاء أكثر من حساب واحد</li>
                                <li>الالتزام بالقوانين المحلية والدولية</li>
                                <li>قبول قرارات الإدارة النهائية</li>
                            </ul>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel (Hidden by default) -->
    <div id="adminPanel" class="admin-panel">
        <div class="container">
            <!-- Admin Header -->
            <div class="header" style="background: linear-gradient(135deg, #2c3e50 0%, #4a235a 100%); color: white;">
                <div class="d-flex align-center gap-2">
                    <i class="fas fa-crown" style="font-size: 2rem; color: #FFD700;"></i>
                    <div>
                        <h1 style="margin: 0; color: white;">لوحة تحكم Advista</h1>
                        <p style="margin: 5px 0 0; opacity: 0.8; font-size: 0.9rem;">لوحة تحكم المدير</p>
                    </div>
                </div>
                
                <div class="user-info">
                    <div class="points-display" style="background: rgba(255,255,255,0.2); color: white;">
                        <i class="fas fa-user-shield"></i>
                        <span>مدير النظام</span>
                    </div>
                    
                    <div class="d-flex align-center gap-1">
                        <button onclick="switchToUserDashboard()" class="btn" style="background: rgba(255,255,255,0.2);">
                            <i class="fas fa-user"></i>
                            <span class="hide-on-mobile">لوحة المستخدم</span>
                        </button>
                        <button onclick="logout()" class="btn btn-danger">
                            <i class="fas fa-sign-out-alt"></i>
                            <span class="hide-on-mobile">خروج</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Admin Stats -->
            <div class="admin-grid">
                <div class="admin-card">
                    <h3><i class="fas fa-users"></i> المستخدمين</h3>
                    <div style="font-size: 2.5rem; font-weight: bold; color: #667eea; margin: 15px 0;" id="adminTotalUsers">0</div>
                    <div class="d-flex justify-between">
                        <span style="color: #666;">نشطون: <span id="adminActiveUsers">0</span></span>
                        <span style="color: #666;">جدد اليوم: <span id="adminNewUsersToday">0</span></span>
                    </div>
                </div>
                
                <div class="admin-card">
                    <h3><i class="fas fa-wallet"></i> طلبات السحب</h3>
                    <div style="font-size: 2.5rem; font-weight: bold; color: #FFD700; margin: 15px 0;" id="adminTotalWithdrawals">0</div>
                    <div class="d-flex justify-between">
                        <span style="color: #666;">بانتظار: <span id="adminPendingWithdrawals">0</span></span>
                        <span style="color: #666;">مكتملة: <span id="adminCompletedWithdrawals">0</span></span>
                    </div>
                </div>
                
                <div class="admin-card">
                    <h3><i class="fas fa-ad"></i> الإعلانات</h3>
                    <div style="font-size: 2.5rem; font-weight: bold; color: #00b09b; margin: 15px 0;" id="adminTotalAds">0</div>
                    <div class="d-flex justify-between">
                        <span style="color: #666;">نشطة: <span id="adminActiveAds">0</span></span>
                        <span style="color: #666;">مشاهدات: <span id="adminTotalViews">0</span></span>
                    </div>
                </div>
                
                <div class="admin-card">
                    <h3><i class="fas fa-chart-pie"></i> الإيرادات</h3>
                    <div style="font-size: 2.5rem; font-weight: bold; color: #FF416C; margin: 15px 0;" id="adminTotalRevenue">$0</div>
                    <div class="d-flex justify-between">
                        <span style="color: #666;">نقاط: <span id="adminTotalPoints">0</span></span>
                        <span style="color: #666;">إحالات: <span id="adminTotalReferrals">0</span></span>
                    </div>
                </div>
            </div>

            <!-- Admin Tabs -->
            <div class="tabs">
                <div class="tab active" onclick="switchAdminTab('dashboard')">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>لوحة التحكم</span>
                </div>
                <div class="tab" onclick="switchAdminTab('users')">
                    <i class="fas fa-users-cog"></i>
                    <span>إدارة المستخدمين</span>
                </div>
                <div class="tab" onclick="switchAdminTab('ads')">
                    <i class="fas fa-ad"></i>
                    <span>إدارة الإعلانات</span>
                </div>
                <div class="tab" onclick="switchAdminTab('withdrawals')">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>طلبات السحب</span>
                </div>
                <div class="tab" onclick="switchAdminTab('settings')">
                    <i class="fas fa-cog"></i>
                    <span>الإعدادات</span>
                </div>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminDashboardTab" class="tab-content">
                <!-- Admin content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- ===================== -->
    <!-- MODALS -->
    <!-- ===================== -->

    <!-- Timer Modal -->
    <div id="timerModal" class="modal">
        <div class="modal-content">
            <h2 style="color: #333; margin-bottom: 15px;">شاهد الإعلان</h2>
            <p id="adDescription" style="color: #666; margin-bottom: 20px;"></p>
            
            <!-- Countdown Bar -->
            <div class="countdown-bar" id="countdownBar"></div>
            
            <div class="timer" id="countdown">30</div>
            
            <p style="color: #FF416C; font-weight: bold; margin-bottom: 25px;">
                <i class="fas fa-exclamation-triangle"></i>
                إذا خرجت قبل انتهاء الوقت ستفقد 5 نقاط
            </p>
            
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button onclick="cancelAd()" class="btn btn-danger">
                    <i class="fas fa-times"></i> إلغاء
                </button>
                <button onclick="completeAd()" class="btn btn-success">
                    <i class="fas fa-check"></i> أكملت المشاهدة
                </button>
            </div>
        </div>
    </div>

    <!-- Captcha Modal -->
    <div id="captchaModal" class="modal">
        <div class="modal-content">
            <h2 style="color: #333; margin-bottom: 15px;">تأكيد المشاهدة</h2>
            <p style="color: #666; margin-bottom: 20px;">أدخل الرقم الذي يظهر في الصورة:</p>
            
            <div style="background: #f0f0f0; padding: 25px; border-radius: 10px; font-size: 2.5rem; letter-spacing: 15px; margin: 25px 0; font-family: monospace; font-weight: bold; user-select: none; position: relative;">
                <span id="captchaText">1234</span>
                <button onclick="refreshCaptcha()" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #666; cursor: pointer;">
                    <i class="fas fa-redo"></i>
                </button>
            </div>
            
            <input type="text" id="captchaInput" placeholder="أدخل الرقم هنا" 
                   style="width: 100%; padding: 15px; border: 2px solid #667eea; border-radius: 10px; font-size: 1.2rem; text-align: center; margin-bottom: 20px;">
            
            <div style="display: flex; gap: 10px;">
                <button onclick="hideCaptchaModal()" class="btn btn-danger" style="flex: 1;">
                    <i class="fas fa-times"></i> إلغاء
                </button>
                <button onclick="verifyCaptcha()" class="btn btn-success" style="flex: 2;">
                    <i class="fas fa-check-circle"></i> تأكيد
                </button>
            </div>
        </div>
    </div>

    <!-- Withdrawal Modal -->
    <div id="withdrawalModal" class="modal">
        <div class="modal-content">
            <h2 style="color: #333; margin-bottom: 20px;">طلب سحب الرصيد</h2>
            
            <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                <h4 style="color: #333; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-info-circle"></i> معلومات السحب
                </h4>
                <ul style="color: #666; text-align: right; list-style: none; padding: 0;">
                    <li style="margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-check-circle" style="color: #00b09b;"></i>
                        الحد الأدنى للسحب: 30,000 نقطة
                    </li>
                    <li style="margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-check-circle" style="color: #00b09b;"></i>
                        30,000 نقطة = 1 دولار
                    </li>
                    <li style="margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-check-circle" style="color: #00b09b;"></i>
                        السحب عبر فودافون كاش فقط
                    </li>
                    <li style="display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-check-circle" style="color: #00b09b;"></i>
                        وقت المعالجة: 24-48 ساعة
                    </li>
                </ul>
            </div>
            
            <div style="margin-bottom: 20px;">
                <div class="d-flex justify-between align-center mb-2">
                    <label style="color: #333; font-weight: bold;">
                        <i class="fas fa-coins"></i> رصيدك الحالي:
                    </label>
                    <span id="modalPoints" style="color: #FFD700; font-weight: bold; font-size: 1.2rem;">0</span>
                </div>
                
                <div class="progress-bar mb-4">
                    <div class="progress-fill" id="withdrawalProgress" style="width: 0%"></div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 500;">المبلغ المراد سحبه (نقاط)</label>
                    <input type="number" id="withdrawAmount" placeholder="أدخل المبلغ بالنقاط" min="30000" 
                           style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 1.1rem;">
                    <div class="d-flex justify-between mt-2">
                        <button onclick="setWithdrawAmount(30000)" class="btn" style="padding: 8px 15px; font-size: 0.9rem;">30,000</button>
                        <button onclick="setWithdrawAmount(60000)" class="btn" style="padding: 8px 15px; font-size: 0.9rem;">60,000</button>
                        <button onclick="setWithdrawAmount(90000)" class="btn" style="padding: 8px 15px; font-size: 0.9rem;">90,000</button>
                        <button onclick="setWithdrawAmount(120000)" class="btn" style="padding: 8px 15px; font-size: 0.9rem;">120,000</button>
                    </div>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 500;">رقم فودافون كاش</label>
                    <input type="text" id="phoneNumber" placeholder="أدخل رقم فودافون كاش (مثال: 01012345678)" 
                           style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 1.1rem;">
                    <p style="color: #666; font-size: 0.9rem; margin-top: 8px;">
                        <i class="fas fa-info-circle"></i>
                        تأكد من صحة الرقم، سيتم التواصل معك عليه عبر الواتساب
                    </p>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <div class="d-flex justify-between align-center mb-2">
                        <span style="color: #333;">المبلغ بالدولار:</span>
                        <span style="color: #667eea; font-weight: bold;" id="withdrawalDollars">$0</span>
                    </div>
                    <div class="d-flex justify-between align-center">
                        <span style="color: #333;">رسوم المعالجة:</span>
                        <span style="color: #666;">مجانية</span>
                    </div>
                </div>
                
                <div class="checkbox-container">
                    <input type="checkbox" id="agreeTerms" checked>
                    <label for="agreeTerms" style="color: #666; font-size: 0.9rem;">
                        أوافق على الشروط والأحكام وأعترف بأن عملية السحب تستغرق 24-48 ساعة
                    </label>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 25px;">
                    <button onclick="hideWithdrawalModal()" class="btn btn-danger" style="flex: 1;">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                    <button onclick="submitWithdrawal()" class="btn btn-success" style="flex: 2;">
                        <i class="fas fa-paper-plane"></i> تقديم طلب السحب
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <h2 style="color: #333; margin-bottom: 20px;">الملف الشخصي</h2>
            
            <div style="text-align: center; margin-bottom: 25px;">
                <div style="width: 100px; height: 100px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                    <i class="fas fa-user" style="font-size: 3rem; color: white;"></i>
                </div>
                <h3 style="color: #333; margin-bottom: 5px;" id="profileName"></h3>
                <p style="color: #666;" id="profileEmail"></p>
            </div>
            
            <div style="margin-bottom: 25px;">
                <div class="d-flex justify-between align-center mb-3">
                    <span style="color: #333; font-weight: 500;">رقم العضو:</span>
                    <span style="color: #667eea; font-weight: bold;" id="profileId"></span>
                </div>
                <div class="d-flex justify-between align-center mb-3">
                    <span style="color: #333; font-weight: 500;">تاريخ التسجيل:</span>
                    <span style="color: #666;" id="profileJoinDate"></span>
                </div>
                <div class="d-flex justify-between align-center mb-3">
                    <span style="color: #333; font-weight: 500;">آخر دخول:</span>
                    <span style="color: #666;" id="profileLastLogin"></span>
                </div>
                <div class="d-flex justify-between align-center">
                    <span style="color: #333; font-weight: 500;">حالة الحساب:</span>
                    <span class="status-badge status-approved" id="profileStatus">نشط</span>
                </div>
            </div>
            
            <div class="divider"></div>
            
            <div style="margin-top: 20px;">
                <h4 style="color: #333; margin-bottom: 15px;">إحصائيات الحساب</h4>
                <div class="grid-2" style="gap: 15px; margin-bottom: 20px;">
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #667eea;" id="profileTotalEarned">0</div>
                        <div style="color: #666; font-size: 0.9rem;">إجمالي الأرباح</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #00b09b;" id="profileTotalWithdrawn">0</div>
                        <div style="color: #666; font-size: 0.9rem;">إجمالي المسحوب</div>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button onclick="hideProfileModal()" class="btn btn-secondary" style="flex: 1;">
                    <i class="fas fa-times"></i> إغلاق
                </button>
                <button onclick="logout()" class="btn btn-danger" style="flex: 1;">
                    <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
                </button>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <h2 style="color: #333; margin-bottom: 20px;">الإبلاغ عن مشكلة</h2>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 500;">نوع المشكلة</label>
                <select id="reportType" style="width: 100%; padding: 12px; margin-bottom: 20px;">
                    <option value="technical">مشكلة فنية</option>
                    <option value="payment">مشكلة في السحب</option>
                    <option value="ad">مشكلة في الإعلان</option>
                    <option value="account">مشكلة في الحساب</option>
                    <option value="other">مشكلة أخرى</option>
                </select>
                
                <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 500;">وصف المشكلة</label>
                <textarea id="reportDescription" placeholder="صف المشكلة بالتفصيل..." rows="4" 
                          style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 1rem; resize: vertical;"></textarea>
                
                <p style="color: #666; font-size: 0.9rem; margin-top: 8px;">
                    <i class="fas fa-info-circle"></i>
                    سيتم الرد على بلاغك في خلال 24 ساعة
                </p>
            </div>
            
            <div style="display: flex; gap: 15px;">
                <button onclick="hideReportModal()" class="btn btn-danger" style="flex: 1;">
                    <i class="fas fa-times"></i> إلغاء
                </button>
                <button onclick="submitReport()" class="btn btn-success" style="flex: 2;">
                    <i class="fas fa-paper-plane"></i> إرسال البلاغ
                </button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <div style="text-align: center;">
                <div style="width: 80px; height: 80px; background: #00b09b; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                    <i class="fas fa-check" style="font-size: 2.5rem; color: white;"></i>
                </div>
                <h2 style="color: #333; margin-bottom: 10px;" id="successTitle"></h2>
                <p style="color: #666; margin-bottom: 25px;" id="successMessage"></p>
                <button onclick="hideSuccessModal()" class="btn btn-success">
                    <i class="fas fa-check"></i> حسناً
                </button>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="modal">
        <div class="modal-content">
            <div style="text-align: center;">
                <div style="width: 80px; height: 80px; background: #FF416C; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                    <i class="fas fa-exclamation" style="font-size: 2.5rem; color: white;"></i>
                </div>
                <h2 style="color: #333; margin-bottom: 10px;" id="errorTitle"></h2>
                <p style="color: #666; margin-bottom: 25px;" id="errorMessage"></p>
                <button onclick="hideErrorModal()" class="btn btn-danger">
                    <i class="fas fa-times"></i> إغلاق
                </button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div style="text-align: center;">
                <div style="width: 80px; height: 80px; background: #FFD700; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                    <i class="fas fa-question" style="font-size: 2.5rem; color: white;"></i>
                </div>
                <h2 style="color: #333; margin-bottom: 10px;" id="confirmTitle"></h2>
                <p style="color: #666; margin-bottom: 25px;" id="confirmMessage"></p>
                <div style="display: flex; gap: 15px;">
                    <button onclick="confirmCancel()" class="btn btn-danger" style="flex: 1;">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                    <button onclick="confirmAction()" class="btn btn-success" style="flex: 1;">
                        <i class="fas fa-check"></i> تأكيد
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notificationModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="d-flex justify-between align-center mb-3">
                <h2 style="color: #333; margin: 0;">الإشعارات</h2>
                <button onclick="markAllAsRead()" class="btn" style="padding: 5px 10px; font-size: 0.9rem;">
                    <i class="fas fa-check-double"></i> تعليم الكل كمقروء
                </button>
            </div>
            
            <div id="notificationsList" style="max-height: 400px; overflow-y: auto;">
                <!-- Notifications will be loaded here -->
            </div>
            
            <div class="divider"></div>
            
            <button onclick="hideNotificationModal()" class="btn" style="width: 100%; margin-top: 15px;">
                <i class="fas fa-times"></i> إغلاق
            </button>
        </div>
    </div>

    <!-- ===================== -->
    <!-- JAVASCRIPT CODE -->
    <!-- ===================== -->
    <script>
        // ===========================================
        // FIREBASE CONFIGURATION
        // ===========================================
        const firebaseConfig = {
            apiKey: "AIzaSyC4fZQ-BTUeHsN9nQtMGmnjJz-NKdcUgkc",
            authDomain: "advista-b64ab.firebaseapp.com",
            projectId: "advista-b64ab",
            storageBucket: "advista-b64ab.firebasestorage.app",
            messagingSenderId: "509713648189",
            appId: "1:509713648189:web:0ccd6ada1f4e07f85d3854",
            measurementId: "G-VG4S1SMKH8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ===========================================
        // GLOBAL VARIABLES
        // ===========================================
        let currentUser = null;
        let currentAd = null;
        let timerInterval = null;
        let timeLeft = 30;
        let currentCaptcha = "";
        let userIP = "";
        let userAgent = "";
        let lastClickTime = 0;
        let ads = [];
        let notifications = [];
        let confirmCallback = null;
        let confirmCancelCallback = null;

        // ===========================================
        // GOOGLE SIGN-IN INITIALIZATION
        // ===========================================
        function initializeGoogleSignIn() {
            if (typeof google === 'undefined') {
                setTimeout(initializeGoogleSignIn, 100);
                return;
            }

            google.accounts.id.initialize({
                client_id: "805966277330-9j5j1nvluj69f8uieog0kk77p0jb46q4.apps.googleusercontent.com",
                callback: handleCredentialResponse,
                auto_select: false,
                cancel_on_tap_outside: true,
                context: "signin"
            });

            google.accounts.id.renderButton(
                document.getElementById("buttonDiv"),
                {
                    theme: "filled_blue",
                    size: "large",
                    text: "signin_with",
                    shape: "rectangular",
                    width: "250",
                    locale: "ar",
                    logo_alignment: "left"
                }
            );

            google.accounts.id.prompt();
        }

        // ===========================================
        // HANDLE GOOGLE LOGIN RESPONSE
        // ===========================================
        async function handleCredentialResponse(response) {
            try {
                showLoading("جاري تسجيل الدخول...");
                const userData = parseJwt(response.credential);
                
                // Get user info
                userIP = await getIP();
                userAgent = navigator.userAgent;
                
                // Create user object
                const user = {
                    uid: userData.sub,
                    email: userData.email,
                    name: userData.name || userData.email.split('@')[0],
                    picture: userData.picture || '',
                    points: 0,
                    totalEarned: 0,
                    totalWithdrawn: 0,
                    dailyStats: {},
                    referralCode: generateReferralCode(),
                    referredBy: getReferralFromURL(),
                    referrals: [],
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString(),
                    lastActivity: new Date().toISOString(),
                    ip: userIP,
                    userAgent: userAgent,
                    isActive: true,
                    isVerified: false,
                    withdrawalRequests: [],
                    notifications: [],
                    settings: {
                        notifications: true,
                        sounds: true,
                        theme: 'light'
                    }
                };

                console.log("Login successful:", user.email);

                // Check if user exists
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (userDoc.exists) {
                    // Update existing user
                    const existingUser = userDoc.data();
                    currentUser = existingUser;
                    
                    await db.collection('users').doc(user.uid).update({
                        lastLogin: new Date().toISOString(),
                        lastActivity: new Date().toISOString(),
                        ip: userIP,
                        userAgent: userAgent
                    });
                    
                    // Check for suspicious activity
                    await checkSuspiciousActivity(user.uid);
                } else {
                    // Create new user
                    await db.collection('users').doc(user.uid).set(user);
                    currentUser = user;
                    
                    // Add welcome notification
                    addNotification(user.uid, 'welcome', 'مرحباً بك في Advista! ابدأ كسب النقاط الآن.');
                    
                    // Add referral bonus if applicable
                    const referralCode = getReferralFromURL();
                    if (referralCode) {
                        await handleReferral(referralCode, user.uid);
                    }
                }

                // Check if admin
                if (user.email === "bo2584668@gmail.com") {
                    showAdminPanel();
                } else {
                    showUserDashboard();
                }

                hideLoading();
                
                // Load user data
                await loadUserData();
                await loadAds();

            } catch (error) {
                console.error("Login error:", error);
                hideLoading();
                showError("حدث خطأ في تسجيل الدخول", error.message);
            }
        }

        // ===========================================
        // JWT DECODE FUNCTION
        // ===========================================
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));

                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error("JWT Parse Error:", error);
                return null;
            }
        }

        // ===========================================
        // USER DASHBOARD FUNCTIONS
        // ===========================================
        async function loadUserData() {
            if (!currentUser) return;

            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    currentUser = userData;
                    
                    // Update UI
                    document.getElementById('userEmail').textContent = userData.email;
                    document.getElementById('userPoints').textContent = formatNumber(userData.points || 0);
                    document.getElementById('totalEarned').textContent = formatNumber(userData.totalEarned || 0) + ' نقطة';
                    document.getElementById('modalPoints').textContent = formatNumber(userData.points || 0);
                    
                    // Update progress bars
                    const points = userData.points || 0;
                    const progress = Math.min((points / 30000) * 100, 100);
                    document.getElementById('withdrawalProgress').style.width = progress + '%';
                    document.getElementById('totalEarnedProgress').style.width = '100%';
                    
                    // Daily earnings
                    const today = getTodayDate();
                    const dailyEarned = userData.dailyStats && userData.dailyStats[today] 
                        ? userData.dailyStats[today].earned 
                        : 0;
                    document.getElementById('dailyEarned').textContent = formatNumber(dailyEarned) + ' نقطة';
                    document.getElementById('dailyEarnedProgress').style.width = Math.min((dailyEarned / 1000) * 100, 100) + '%';
                    
                    // Referrals
                    const referralCount = userData.referrals ? userData.referrals.length : 0;
                    document.getElementById('referralCount').textContent = formatNumber(referralCount) + ' مستخدم';
                    document.getElementById('totalReferrals').textContent = formatNumber(referralCount);
                    document.getElementById('referralEarnings').textContent = formatNumber(referralCount * 500);
                    
                    // Referral link
                    const referralLink = `${window.location.origin}${window.location.pathname}?ref=${userData.referralCode}`;
                    document.getElementById('referralLink').value = referralLink;
                    
                    // Withdrawal amount calculation
                    updateWithdrawalAmount();
                    
                    // Load history
                    await loadHistory();
                    
                    // Load notifications
                    await loadNotifications();
                    
                    // Update last activity
                    updateUserActivity();
                }
            } catch (error) {
                console.error("Error loading user data:", error);
            }
        }

        async function loadAds() {
            try {
                showLoading("جاري تحميل الإعلانات...");
                
                // First, load from Firebase
                const adsSnapshot = await db.collection('ads')
                    .where('isActive', '==', true)
                    .where('budget', '>', 0)
                    .orderBy('reward', 'desc')
                    .limit(50)
                    .get();

                ads = [];
                adsSnapshot.forEach(doc => {
                    ads.push({ id: doc.id, ...doc.data() });
                });

                // If less than 45 ads, load sample ads
                if (ads.length < 45) {
                    const sampleAds = generateSampleAds(45 - ads.length);
                    ads = ads.concat(sampleAds);
                }

                // Filter ads user hasn't watched today
                const today = getTodayDate();
                const watchedAds = currentUser.dailyStats && currentUser.dailyStats[today] 
                    ? currentUser.dailyStats[today].watchedAds || [] 
                    : [];

                let availableAds = ads.filter(ad => !watchedAds.includes(ad.id));
                
                // Apply search filter
                const searchText = document.getElementById('adSearch')?.value.toLowerCase() || '';
                if (searchText) {
                    availableAds = availableAds.filter(ad => 
                        (ad.title || '').toLowerCase().includes(searchText) ||
                        (ad.description || '').toLowerCase().includes(searchText)
                    );
                }
                
                // Apply reward filter
                const filterValue = document.getElementById('adFilter')?.value || 'all';
                if (filterValue === 'high') {
                    availableAds.sort((a, b) => (b.reward || 0) - (a.reward || 0));
                } else if (filterValue === 'low') {
                    availableAds.sort((a, b) => (a.reward || 0) - (b.reward || 0));
                }

                // Update UI
                document.getElementById('adsCount').textContent = formatNumber(availableAds.length) + ' إعلان';
                document.getElementById('availableAdsText').textContent = `${availableAds.length} إعلان متاح`;
                
                const adsContainer = document.getElementById('adsContainer');
                const noAdsMessage = document.getElementById('noAdsMessage');
                
                if (availableAds.length === 0) {
                    adsContainer.innerHTML = '';
                    noAdsMessage.style.display = 'block';
                    hideLoading();
                    return;
                }
                
                noAdsMessage.style.display = 'none';
                adsContainer.innerHTML = '';

                availableAds.forEach((ad, index) => {
                    const adElement = document.createElement('div');
                    adElement.className = 'ad-card hover-lift';
                    adElement.onclick = () => startAd(ad);
                    
                    // Calculate time remaining for cooldown
                    const lastWatched = currentUser.dailyStats?.[today]?.lastAdTime;
                    const cooldown = lastWatched ? (Date.now() - new Date(lastWatched).getTime()) / 1000 : 0;
                    const canWatch = cooldown >= 30 || !lastWatched;
                    
                    adElement.innerHTML = `
                        <div class="ad-title">${ad.title || `إعلان ${index + 1}`}</div>
                        <p style="color: #666; font-size: 0.95rem; margin: 10px 0; line-height: 1.5;">
                            ${ad.description || 'شاهد هذا الإعلان لمدة 30 ثانية لتحصل على النقاط'}
                        </p>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                            <div class="ad-reward">
                                <i class="fas fa-coins"></i>
                                ${ad.reward || 10} نقطة
                            </div>
                            <div style="color: #666; font-size: 0.9rem;">
                                <i class="fas fa-clock"></i> 30 ثانية
                            </div>
                        </div>
                        ${ad.duration ? `
                        <div style="margin-top: 10px; color: #999; font-size: 0.85rem; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-hourglass-half"></i> المدة: ${ad.duration} ثانية
                        </div>
                        ` : ''}
                        <div style="margin-top: 15px; color: #999; font-size: 0.85rem; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-user"></i> ${ad.publisher || 'Advista'}
                        </div>
                        ${!canWatch ? `
                        <div style="margin-top: 10px; padding: 5px 10px; background: rgba(255, 65, 108, 0.1); border-radius: 5px; color: #FF416C; font-size: 0.85rem;">
                            <i class="fas fa-clock"></i> متاح بعد ${Math.max(0, 30 - Math.floor(cooldown))} ثانية
                        </div>
                        ` : ''}
                    `;
                    
                    if (!canWatch) {
                        adElement.style.opacity = '0.6';
                        adElement.style.cursor = 'not-allowed';
                        adElement.onclick = () => showError("الرجاء الانتظار", "يجب الانتظار 30 ثانية بين كل إعلان");
                    }
                    
                    adsContainer.appendChild(adElement);
                });

                hideLoading();
                
                // Start ads refresh timer
                startAdsRefreshTimer();

            } catch (error) {
                console.error("Error loading ads:", error);
                hideLoading();
                showError("حدث خطأ في تحميل الإعلانات", error.message);
            }
        }

        // ===========================================
        // AD VIEWING SYSTEM
        // ===========================================
        function startAd(ad) {
            // Check if user is already watching an ad
            if (currentAd) {
                showError("خطأ", "يجب إنهاء الإعلان الحالي أولاً");
                return;
            }

            // Check cooldown
            const today = getTodayDate();
            const lastWatched = currentUser.dailyStats?.[today]?.lastAdTime;
            const cooldown = lastWatched ? (Date.now() - new Date(lastWatched).getTime()) / 1000 : 0;
            
            if (cooldown < 30 && lastWatched) {
                showError("الرجاء الانتظار", `يجب الانتظار ${Math.ceil(30 - cooldown)} ثانية قبل مشاهدة إعلان جديد`);
                return;
            }

            // Check daily limit
            const adsWatchedToday = currentUser.dailyStats?.[today]?.adsWatched || 0;
            if (adsWatchedToday >= 10) {
                showError("تم الوصول للحد اليومي", "لقد وصلت للحد الأقصى اليومي (10 إعلانات)");
                return;
            }

            // Prevent multiple clicks
            const now = Date.now();
            if (now - lastClickTime < 1000) {
                return;
            }
            lastClickTime = now;

            currentAd = ad;
            timeLeft = 30;
            
            // Show timer modal
            document.getElementById('timerModal').style.display = 'flex';
            document.getElementById('adDescription').textContent = ad.description || 'شاهد هذا الإعلان لمدة 30 ثانية للحصول على النقاط';
            document.getElementById('countdown').textContent = timeLeft;
            
            // Reset and start countdown bar
            document.getElementById('countdownBar').style.animation = 'none';
            setTimeout(() => {
                document.getElementById('countdownBar').style.animation = 'countdown 30s linear';
            }, 10);
            
            // Start countdown
            updateCountdown();
            timerInterval = setInterval(updateCountdown, 1000);
            
            // Prevent user from leaving
            window.addEventListener('beforeunload', handleBeforeUnload);
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            // Track ad start
            trackAdStart(ad.id);
        }

        function updateCountdown() {
            const countdownElement = document.getElementById('countdown');
            countdownElement.textContent = timeLeft;
            
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                showCaptcha();
            } else {
                timeLeft--;
            }
        }

        function cancelAd() {
            clearInterval(timerInterval);
            hideTimerModal();
            
            if (currentUser && currentUser.points >= 5) {
                // Deduct 5 points
                deductPoints(5);
                showError("تم خصم 5 نقاط", "تم خصم 5 نقاط لإلغاء المشاهدة");
            }
            
            resetAdViewing();
        }

        function completeAd() {
            clearInterval(timerInterval);
            showCaptcha();
        }

        function showCaptcha() {
            hideTimerModal();
            document.getElementById('captchaModal').style.display = 'flex';
            
            // Generate random captcha
            generateNewCaptcha();
            document.getElementById('captchaInput').value = '';
            document.getElementById('captchaInput').focus();
        }

        function generateNewCaptcha() {
            currentCaptcha = Math.floor(1000 + Math.random() * 9000).toString();
            document.getElementById('captchaText').textContent = currentCaptcha;
        }

        function refreshCaptcha() {
            generateNewCaptcha();
        }

        async function verifyCaptcha() {
            const userInput = document.getElementById('captchaInput').value.trim();
            
            if (userInput === '') {
                showError("خطأ", "يرجى إدخال الرقم");
                document.getElementById('captchaInput').focus();
                return;
            }
            
            if (userInput === currentCaptcha) {
                // Award points
                const reward = currentAd.reward || 10;
                await addPoints(reward, currentAd.id);
                
                hideCaptchaModal();
                showSuccess("مبروك!", `لقد ربحت ${reward} نقطة`);
                
                // Reload data
                await loadUserData();
                await loadAds();
                
            } else {
                document.getElementById('captchaInput').classList.add('shake');
                setTimeout(() => {
                    document.getElementById('captchaInput').classList.remove('shake');
                }, 500);
                showError("الرقم غير صحيح", "يرجى المحاولة مرة أخرى");
                document.getElementById('captchaInput').value = '';
                document.getElementById('captchaInput').focus();
                generateNewCaptcha();
            }
        }

        // ===========================================
        // POINTS MANAGEMENT
        // ===========================================
        async function addPoints(points, adId) {
            if (!currentUser || !points) return;
            
            const today = getTodayDate();
            const userRef = db.collection('users').doc(currentUser.uid);
            
            try {
                // Update points
                await userRef.update({
                    points: firebase.firestore.FieldValue.increment(points),
                    totalEarned: firebase.firestore.FieldValue.increment(points),
                    lastActivity: new Date().toISOString(),
                    [`dailyStats.${today}.earned`]: firebase.firestore.FieldValue.increment(points),
                    [`dailyStats.${today}.adsWatched`]: firebase.firestore.FieldValue.increment(1),
                    [`dailyStats.${today}.watchedAds`]: firebase.firestore.FieldValue.arrayUnion(adId),
                    [`dailyStats.${today}.lastAdTime`]: new Date().toISOString()
                });
                
                // Update ad budget if it's from Firebase
                if (currentAd.id && !currentAd.external) {
                    const adRef = db.collection('ads').doc(currentAd.id);
                    await adRef.update({
                        budget: firebase.firestore.FieldValue.increment(-points),
                        views: firebase.firestore.FieldValue.increment(1),
                        lastViewed: new Date().toISOString()
                    });
                }
                
                // Record click history
                await db.collection('clicks').add({
                    userId: currentUser.uid,
                    adId: adId,
                    points: points,
                    timestamp: new Date().toISOString(),
                    ip: userIP,
                    userAgent: userAgent
                });
                
                // Add notification
                addNotification(currentUser.uid, 'points', `لقد ربحت ${points} نقطة من مشاهدة إعلان`);
                
                resetAdViewing();
                
            } catch (error) {
                console.error("Error adding points:", error);
                showError("حدث خطأ", "حدث خطأ في إضافة النقاط");
            }
        }

        async function deductPoints(points) {
            if (!currentUser || points <= 0) return;
            
            try {
                const userRef = db.collection('users').doc(currentUser.uid);
                await userRef.update({
                    points: firebase.firestore.FieldValue.increment(-points),
                    lastActivity: new Date().toISOString()
                });
                
                // Record deduction
                await db.collection('deductions').add({
                    userId: currentUser.uid,
                    points: points,
                    reason: 'ad_cancellation',
                    timestamp: new Date().toISOString(),
                    ip: userIP
                });
                
            } catch (error) {
                console.error("Error deducting points:", error);
            }
        }

        // ===========================================
        // WITHDRAWAL SYSTEM
        // ===========================================
        function showWithdrawalModal() {
            if (!currentUser) return;
            
            if (currentUser.points < 30000) {
                showError("نقاط غير كافية", `أنت تحتاج ${formatNumber(30000 - currentUser.points)} نقطة أخرى للسحب. الحد الأدنى 30,000 نقطة.`);
                return;
            }
            
            document.getElementById('withdrawalModal').style.display = 'flex';
            document.getElementById('withdrawAmount').value = currentUser.points >= 30000 ? 30000 : currentUser.points;
            updateWithdrawalAmount();
            document.getElementById('withdrawAmount').focus();
        }

        function hideWithdrawalModal() {
            document.getElementById('withdrawalModal').style.display = 'none';
        }

        function setWithdrawAmount(amount) {
            document.getElementById('withdrawAmount').value = amount;
            updateWithdrawalAmount();
        }

        function updateWithdrawalAmount() {
            const amountInput = document.getElementById('withdrawAmount');
            if (!amountInput) return;
            
            const amount = parseInt(amountInput.value) || 0;
            const dollars = (amount / 30000).toFixed(2);
            document.getElementById('withdrawalDollars').textContent = `$${dollars}`;
            
            // Update progress
            const points = currentUser?.points || 0;
            const progress = Math.min((amount / points) * 100, 100);
            document.getElementById('withdrawalProgress').style.width = progress + '%';
        }

        async function submitWithdrawal() {
            if (!currentUser) return;
            
            const amount = parseInt(document.getElementById('withdrawAmount').value);
            const phone = document.getElementById('phoneNumber').value.trim();
            const agreeTerms = document.getElementById('agreeTerms').checked;
            
            // Validation
            if (!amount || isNaN(amount) || amount < 30000) {
                showError("خطأ", "الحد الأدنى للسحب هو 30,000 نقطة");
                return;
            }
            
            if (amount > currentUser.points) {
                showError("نقاط غير كافية", "نقاطك غير كافية لهذا المبلغ");
                return;
            }
            
            if (!phone || !/^01[0-9]{9}$/.test(phone)) {
                showError("رقم هاتف غير صحيح", "يرجى إدخال رقم فودافون كاش مصري صحيح (11 رقماً)");
                return;
            }
            
            if (!agreeTerms) {
                showError("خطأ", "يجب الموافقة على الشروط والأحكام");
                return;
            }
            
            showLoading("جاري معالجة طلب السحب...");
            
            try {
                // Create withdrawal request
                const withdrawalId = Date.now().toString();
                const withdrawalRequest = {
                    id: withdrawalId,
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    userName: currentUser.name,
                    amount: amount,
                    points: amount,
                    phoneNumber: phone,
                    status: 'pending',
                    requestedAt: new Date().toISOString(),
                    approvedAt: null,
                    completedAt: null,
                    adminNotes: '',
                    ip: userIP,
                    userAgent: userAgent
                };
                
                // Save to database
                await db.collection('withdrawals').doc(withdrawalId).set(withdrawalRequest);
                
                // Update user points and add to withdrawal history
                const userRef = db.collection('users').doc(currentUser.uid);
                await userRef.update({
                    points: firebase.firestore.FieldValue.increment(-amount),
                    totalWithdrawn: firebase.firestore.FieldValue.increment(amount),
                    lastActivity: new Date().toISOString(),
                    withdrawalRequests: firebase.firestore.FieldValue.arrayUnion(withdrawalId)
                });
                
                // Send notification to admin
                await sendWithdrawalNotification(withdrawalRequest);
                
                // Add user notification
                addNotification(currentUser.uid, 'withdrawal', `تم تقديم طلب سحب بقيمة ${formatNumber(amount)} نقطة`);
                
                hideLoading();
                hideWithdrawalModal();
                showSuccess("تم بنجاح!", "تم إرسال طلب السحب بنجاح. سيتم التواصل معك عبر الواتساب خلال 24 ساعة");
                
                // Clear form
                document.getElementById('phoneNumber').value = '';
                
                // Reload user data
                await loadUserData();
                
            } catch (error) {
                hideLoading();
                console.error("Withdrawal error:", error);
                showError("حدث خطأ", "حدث خطأ في طلب السحب. يرجى المحاولة لاحقاً");
            }
        }

        // ===========================================
        // REFERRAL SYSTEM
        // ===========================================
        async function handleReferral(referralCode, newUserId) {
            try {
                // Find user with this referral code
                const usersSnapshot = await db.collection('users')
                    .where('referralCode', '==', referralCode)
                    .limit(1)
                    .get();
                
                if (!usersSnapshot.empty) {
                    const referrerDoc = usersSnapshot.docs[0];
                    const referrerId = referrerDoc.id;
                    
                    // Add referral bonus to referrer
                    const referrerRef = db.collection('users').doc(referrerId);
                    await referrerRef.update({
                        points: firebase.firestore.FieldValue.increment(500),
                        totalEarned: firebase.firestore.FieldValue.increment(500),
                        lastActivity: new Date().toISOString(),
                        referrals: firebase.firestore.FieldValue.arrayUnion(newUserId)
                    });
                    
                    // Add bonus to new user
                    const newUserRef = db.collection('users').doc(newUserId);
                    await newUserRef.update({
                        points: firebase.firestore.FieldValue.increment(100),
                        totalEarned: firebase.firestore.FieldValue.increment(100)
                    });
                    
                    // Record referral
                    await db.collection('referrals').add({
                        referrerId: referrerId,
                        referredId: newUserId,
                        bonus: 500,
                        newUserBonus: 100,
                        timestamp: new Date().toISOString()
                    });
                    
                    // Add notifications
                    addNotification(referrerId, 'referral', `لقد ربحت 500 نقطة من إحالة جديدة!`);
                    addNotification(newUserId, 'referral', `لقد ربحت 100 نقطة هدية للتسجيل!`);
                    
                    console.log("Referral bonus added for:", referrerId);
                }
            } catch (error) {
                console.error("Error handling referral:", error);
            }
        }

        function copyReferralLink() {
            const linkInput = document.getElementById('referralLink');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999);
            
            try {
                navigator.clipboard.writeText(linkInput.value);
                showSuccess("تم النسخ", "تم نسخ رابط الإحالة بنجاح");
            } catch (err) {
                document.execCommand('copy');
                showSuccess("تم النسخ", "تم نسخ الرابط");
            }
        }

        function shareReferralLink() {
            const link = document.getElementById('referralLink').value;
            const text = `انضم إلى Advista واكسب المال من مشاهدة الإعلانات! سجل الآن باستخدام رابطي واحصل على 100 نقطة هدية: ${link}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Advista - كسب المال من مشاهدة الإعلانات',
                    text: text,
                    url: link
                });
            } else {
                // Fallback for browsers that don't support Web Share API
                window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
            }
        }

        // ===========================================
        // HISTORY SYSTEM
        // ===========================================
        async function loadHistory() {
            if (!currentUser) return;
            
            try {
                // Load clicks history
                const clicksSnapshot = await db.collection('clicks')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('timestamp', 'desc')
                    .limit(20)
                    .get();
                
                const clicksHistoryBody = document.getElementById('clicksHistoryBody');
                let totalClicksPoints = 0;
                
                if (clicksSnapshot.empty) {
                    clicksHistoryBody.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 30px; color: #666;">
                                <i class="fas fa-history" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                                لا توجد عمليات سابقة
                            </td>
                        </tr>
                    `;
                } else {
                    clicksHistoryBody.innerHTML = '';
                    clicksSnapshot.forEach(doc => {
                        const click = doc.data();
                        totalClicksPoints += click.points || 0;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${formatDate(click.timestamp)}</td>
                            <td>${click.adId ? `إعلان ${click.adId.substring(0, 8)}` : 'غير معروف'}</td>
                            <td><span style="color: #00b09b; font-weight: bold;">+${click.points || 0}</span></td>
                            <td><span class="status-badge status-approved">مكتمل</span></td>
                        `;
                        clicksHistoryBody.appendChild(row);
                    });
                }
                
                document.getElementById('totalClicksPoints').textContent = formatNumber(totalClicksPoints);
                
                // Load withdrawals history
                const withdrawalsSnapshot = await db.collection('withdrawals')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('requestedAt', 'desc')
                    .limit(10)
                    .get();
                
                const withdrawalsHistoryBody = document.getElementById('withdrawalsHistoryBody');
                let totalWithdrawn = 0;
                
                if (withdrawalsSnapshot.empty) {
                    withdrawalsHistoryBody.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 30px; color: #666;">
                                <i class="fas fa-wallet" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                                لا توجد طلبات سحب سابقة
                            </td>
                        </tr>
                    `;
                } else {
                    withdrawalsHistoryBody.innerHTML = '';
                    withdrawalsSnapshot.forEach(doc => {
                        const withdrawal = doc.data();
                        if (withdrawal.status === 'approved') {
                            totalWithdrawn += withdrawal.points || 0;
                        }
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${formatDate(withdrawal.requestedAt)}</td>
                            <td><span style="color: #FFD700; font-weight: bold;">${formatNumber(withdrawal.points)}</span></td>
                            <td>${withdrawal.phoneNumber || 'غير متوفر'}</td>
                            <td><span class="status-badge status-${withdrawal.status}">${getStatusText(withdrawal.status)}</span></td>
                            <td>${withdrawal.adminNotes || '-'}</td>
                        `;
                        withdrawalsHistoryBody.appendChild(row);
                    });
                }
                
                document.getElementById('totalWithdrawn').textContent = formatNumber(totalWithdrawn);
                
                // Load referrals history
                const referralsSnapshot = await db.collection('referrals')
                    .where('referrerId', '==', currentUser.uid)
                    .orderBy('timestamp', 'desc')
                    .limit(10)
                    .get();
                
                const referralsHistoryBody = document.getElementById('referralsHistoryBody');
                
                if (referralsSnapshot.empty) {
                    referralsHistoryBody.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 30px; color: #666;">
                                <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                                لا توجد إحالات حتى الآن
                            </td>
                        </tr>
                    `;
                } else {
                    referralsHistoryBody.innerHTML = '';
                    referralsSnapshot.forEach(async (doc) => {
                        const referral = doc.data();
                        
                        // Get referred user info
                        const userDoc = await db.collection('users').doc(referral.referredId).get();
                        const userData = userDoc.data();
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${formatDate(referral.timestamp)}</td>
                            <td>${userData?.email || 'مستخدم محذوف'}</td>
                            <td><span style="color: #00b09b; font-weight: bold;">+${referral.bonus || 0}</span></td>
                            <td><span class="status-badge status-approved">مكتمل</span></td>
                        `;
                        referralsHistoryBody.appendChild(row);
                    });
                }
                
            } catch (error) {
                console.error("Error loading history:", error);
            }
        }

        function showHistory(type) {
            // Hide all history sections
            document.getElementById('clicksHistory').style.display = 'none';
            document.getElementById('withdrawalsHistory').style.display = 'none';
            document.getElementById('earningsHistory').style.display = 'none';
            
            // Remove active class from all tabs
            document.querySelectorAll('#historyTab .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected history
            document.getElementById(type + 'History').style.display = 'block';
            
            // Add active class to selected tab
            event.target.classList.add('active');
        }

        function exportHistory() {
            // This would export history as CSV
            showSuccess("قريباً", "ستتوفر ميزة تصدير البيانات قريباً");
        }

        // ===========================================
        // NOTIFICATION SYSTEM
        // ===========================================
        async function loadNotifications() {
            if (!currentUser) return;
            
            try {
                // Load notifications from user document
                const notifications = currentUser.notifications || [];
                
                // Update badge
                const unreadCount = notifications.filter(n => !n.read).length;
                const badge = document.getElementById('notificationBadge');
                if (unreadCount > 0) {
                    badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
                
            } catch (error) {
                console.error("Error loading notifications:", error);
            }
        }

        async function addNotification(userId, type, message) {
            try {
                const notification = {
                    id: Date.now().toString(),
                    type: type,
                    message: message,
                    timestamp: new Date().toISOString(),
                    read: false
                };
                
                const userRef = db.collection('users').doc(userId);
                await userRef.update({
                    notifications: firebase.firestore.FieldValue.arrayUnion(notification),
                    lastActivity: new Date().toISOString()
                });
                
            } catch (error) {
                console.error("Error adding notification:", error);
            }
        }

        function showNotifications() {
            if (!currentUser) return;
            
            const notifications = currentUser.notifications || [];
            const notificationsList = document.getElementById('notificationsList');
            
            if (notifications.length === 0) {
                notificationsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-bell-slash" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p>لا توجد إشعارات</p>
                    </div>
                `;
            } else {
                notificationsList.innerHTML = '';
                notifications.slice().reverse().forEach(notification => {
                    const notificationElement = document.createElement('div');
                    notificationElement.className = `d-flex align-center gap-3 p-3 ${!notification.read ? 'bg-light' : ''}`;
                    notificationElement.style.borderBottom = '1px solid #eee';
                    notificationElement.style.cursor = 'pointer';
                    
                    let icon = 'fas fa-bell';
                    let color = '#667eea';
                    
                    switch(notification.type) {
                        case 'welcome': icon = 'fas fa-hand-wave'; color = '#00b09b'; break;
                        case 'points': icon = 'fas fa-coins'; color = '#FFD700'; break;
                        case 'withdrawal': icon = 'fas fa-wallet'; color = '#667eea'; break;
                        case 'referral': icon = 'fas fa-users'; color = '#FF416C'; break;
                        case 'warning': icon = 'fas fa-exclamation-triangle'; color = '#FFA500'; break;
                    }
                    
                    notificationElement.innerHTML = `
                        <div style="width: 40px; height: 40px; background: ${color}; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i class="${icon}" style="color: white;"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500; color: #333;">${notification.message}</div>
                            <div style="color: #666; font-size: 0.85rem;">${formatDate(notification.timestamp)}</div>
                        </div>
                        ${!notification.read ? '<div style="width: 10px; height: 10px; background: #FF416C; border-radius: 50%;"></div>' : ''}
                    `;
                    
                    notificationsList.appendChild(notificationElement);
                });
            }
            
            document.getElementById('notificationModal').style.display = 'flex';
        }

        function hideNotificationModal() {
            document.getElementById('notificationModal').style.display = 'none';
        }

        async function markAllAsRead() {
            if (!currentUser) return;
            
            try {
                const userRef = db.collection('users').doc(currentUser.uid);
                const updatedNotifications = (currentUser.notifications || []).map(n => ({ ...n, read: true }));
                
                await userRef.update({
                    notifications: updatedNotifications,
                    lastActivity: new Date().toISOString()
                });
                
                // Update local user data
                currentUser.notifications = updatedNotifications;
                
                // Update UI
                document.getElementById('notificationBadge').style.display = 'none';
                showNotifications();
                
            } catch (error) {
                console.error("Error marking notifications as read:", error);
            }
        }

        // ===========================================
        // ADMIN FUNCTIONS
        // ===========================================
        function showAdminPanel() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('userDashboard').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadAdminDashboard();
        }

        function switchToUserDashboard() {
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('userDashboard').style.display = 'block';
        }

        async function loadAdminDashboard() {
            try {
                // Load stats
                const usersSnapshot = await db.collection('users').get();
                const withdrawalsSnapshot = await db.collection('withdrawals').get();
                const adsSnapshot = await db.collection('ads').get();
                const clicksSnapshot = await db.collection('clicks').get();
                
                const totalUsers = usersSnapshot.size;
                const activeUsers = usersSnapshot.docs.filter(doc => doc.data().isActive).length;
                const newUsersToday = usersSnapshot.docs.filter(doc => {
                    const userDate = new Date(doc.data().createdAt);
                    const today = new Date();
                    return userDate.toDateString() === today.toDateString();
                }).length;
                
                const totalWithdrawals = withdrawalsSnapshot.size;
                const pendingWithdrawals = withdrawalsSnapshot.docs.filter(doc => doc.data().status === 'pending').length;
                const completedWithdrawals = withdrawalsSnapshot.docs.filter(doc => doc.data().status === 'approved').length;
                
                const totalAds = adsSnapshot.size;
                const activeAds = adsSnapshot.docs.filter(doc => doc.data().isActive).length;
                const totalViews = clicksSnapshot.size;
                
                // Calculate revenue (1 USD per 30,000 points)
                const totalWithdrawnPoints = withdrawalsSnapshot.docs
                    .filter(doc => doc.data().status === 'approved')
                    .reduce((sum, doc) => sum + (doc.data().points || 0), 0);
                const totalRevenue = (totalWithdrawnPoints / 30000).toFixed(2);
                
                // Calculate total points in system
                const totalPoints = usersSnapshot.docs.reduce((sum, doc) => sum + (doc.data().points || 0), 0);
                
                // Calculate total referrals
                const totalReferrals = usersSnapshot.docs.reduce((sum, doc) => {
                    const referrals = doc.data().referrals || [];
                    return sum + referrals.length;
                }, 0);
                
                // Update UI
                document.getElementById('adminTotalUsers').textContent = formatNumber(totalUsers);
                document.getElementById('adminActiveUsers').textContent = formatNumber(activeUsers);
                document.getElementById('adminNewUsersToday').textContent = formatNumber(newUsersToday);
                document.getElementById('adminTotalWithdrawals').textContent = formatNumber(totalWithdrawals);
                document.getElementById('adminPendingWithdrawals').textContent = formatNumber(pendingWithdrawals);
                document.getElementById('adminCompletedWithdrawals').textContent = formatNumber(completedWithdrawals);
                document.getElementById('adminTotalAds').textContent = formatNumber(totalAds);
                document.getElementById('adminActiveAds').textContent = formatNumber(activeAds);
                document.getElementById('adminTotalViews').textContent = formatNumber(totalViews);
                document.getElementById('adminTotalRevenue').textContent = `$${totalRevenue}`;
                document.getElementById('adminTotalPoints').textContent = formatNumber(totalPoints);
                document.getElementById('adminTotalReferrals').textContent = formatNumber(totalReferrals);
                
            } catch (error) {
                console.error("Error loading admin dashboard:", error);
            }
        }

        function switchAdminTab(tabName) {
            // This would switch between admin tabs
            showSuccess("قريباً", `سيتم تحميل ${tabName} قريباً`);
        }

        // ===========================================
        // UTILITY FUNCTIONS
        // ===========================================
        function showAlert(message, type = "success", duration = 5000) {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            
            const alertDiv = document.createElement('div');
            alertDiv.id = alertId;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                ${message}
                <button class="alert-close" onclick="document.getElementById('${alertId}').remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            alertContainer.appendChild(alertDiv);
            
            // Auto remove after duration
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) alert.remove();
            }, duration);
        }

        function showSuccess(title, message) {
            document.getElementById('successTitle').textContent = title;
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successModal').style.display = 'flex';
        }

        function hideSuccessModal() {
            document.getElementById('successModal').style.display = 'none';
        }

        function showError(title, message) {
            document.getElementById('errorTitle').textContent = title;
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorModal').style.display = 'flex';
        }

        function hideErrorModal() {
            document.getElementById('errorModal').style.display = 'none';
        }

        function showConfirm(title, message, onConfirm, onCancel = null) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            confirmCallback = onConfirm;
            confirmCancelCallback = onCancel;
            document.getElementById('confirmModal').style.display = 'flex';
        }

        function confirmAction() {
            if (confirmCallback) confirmCallback();
            hideConfirmModal();
        }

        function confirmCancel() {
            if (confirmCancelCallback) confirmCancelCallback();
            hideConfirmModal();
        }

        function hideConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
            confirmCallback = null;
            confirmCancelCallback = null;
        }

        function showLoading(message = "جاري التحميل...") {
            document.getElementById('loadingText').textContent = message;
            document.getElementById('loading').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function hideTimerModal() {
            document.getElementById('timerModal').style.display = 'none';
        }

        function hideCaptchaModal() {
            document.getElementById('captchaModal').style.display = 'none';
        }

        function showProfileModal() {
            if (!currentUser) return;
            
            document.getElementById('profileName').textContent = currentUser.name;
            document.getElementById('profileEmail').textContent = currentUser.email;
            document.getElementById('profileId').textContent = currentUser.uid.substring(0, 8) + '...';
            document.getElementById('profileJoinDate').textContent = formatDate(currentUser.createdAt);
            document.getElementById('profileLastLogin').textContent = formatDate(currentUser.lastLogin);
            document.getElementById('profileTotalEarned').textContent = formatNumber(currentUser.totalEarned || 0);
            document.getElementById('profileTotalWithdrawn').textContent = formatNumber(currentUser.totalWithdrawn || 0);
            
            document.getElementById('profileModal').style.display = 'flex';
        }

        function hideProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }

        function showReportModal() {
            document.getElementById('reportModal').style.display = 'flex';
        }

        function hideReportModal() {
            document.getElementById('reportModal').style.display = 'none';
        }

        async function submitReport() {
            const type = document.getElementById('reportType').value;
            const description = document.getElementById('reportDescription').value.trim();
            
            if (!description) {
                showError("خطأ", "يرجى إدخال وصف المشكلة");
                return;
            }
            
            showLoading("جاري إرسال البلاغ...");
            
            try {
                const report = {
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    type: type,
                    description: description,
                    timestamp: new Date().toISOString(),
                    status: 'pending',
                    ip: userIP,
                    userAgent: userAgent
                };
                
                await db.collection('reports').add(report);
                
                hideLoading();
                hideReportModal();
                showSuccess("تم الإرسال", "تم إرسال بلاغك بنجاح. سيتم الرد عليك خلال 24 ساعة");
                
                // Clear form
                document.getElementById('reportDescription').value = '';
                
            } catch (error) {
                hideLoading();
                console.error("Error submitting report:", error);
                showError("حدث خطأ", "حدث خطأ في إرسال البلاغ");
            }
        }

        function showUserDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('userDashboard').style.display = 'block';
        }

        function logout() {
            google.accounts.id.disableAutoSelect();
            currentUser = null;
            document.getElementById('userDashboard').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
        }

        function getTodayDate() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
        }

        function generateReferralCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function getReferralFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('ref');
        }

        async function getIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'unknown';
            }
        }

        function resetAdViewing() {
            currentAd = null;
            clearInterval(timerInterval);
            window.removeEventListener('beforeunload', handleBeforeUnload);
            document.removeEventListener('visibilitychange', handleVisibilityChange);
        }

        function handleBeforeUnload(e) {
            if (currentAd) {
                e.preventDefault();
                e.returnValue = 'أنت تشاهد إعلانًا حاليًا. إذا خرجت ستفقد 5 نقاط.';
                return e.returnValue;
            }
        }

        function handleVisibilityChange() {
            if (document.hidden && currentAd) {
                cancelAd();
                showError("تم اكتشاف تغيير النافذة", "تم إلغاء الإعلان بسبب تغيير النافذة");
            }
        }

        async function sendWithdrawalNotification(withdrawal) {
            // In a real app, send email/WhatsApp to admin
            console.log("Withdrawal notification:", withdrawal);
            
            const adminEmail = 'bo2584668@gmail.com';
            const subject = `طلب سحب جديد - ${withdrawal.amount} نقطة`;
            const body = `
                طلب سحب جديد:
                
                المستخدم: ${withdrawal.userEmail}
                الاسم: ${withdrawal.userName}
                المبلغ: ${withdrawal.amount} نقطة (${(withdrawal.amount/30000).toFixed(2)} دولار)
                رقم الهاتف: ${withdrawal.phoneNumber}
                الوقت: ${new Date(withdrawal.requestedAt).toLocaleString('ar-EG')}
                IP: ${withdrawal.ip}
                
                رابط لوحة التحكم: ${window.location.origin}/admin.html
            `;
            
            console.log(`Email to ${adminEmail}: ${subject}\n${body}`);
            
            // Send WhatsApp message (simulated)
            const whatsappMessage = `طلب سحب جديد%0A%0Aالمستخدم: ${withdrawal.userEmail}%0Aالمبلغ: ${withdrawal.amount} نقطة%0Aرقم الهاتف: ${withdrawal.phoneNumber}%0Aالوقت: ${new Date(withdrawal.requestedAt).toLocaleString('ar-EG')}`;
            console.log(`WhatsApp: https://wa.me/201273740256?text=${whatsappMessage}`);
        }

        function generateSampleAds(count) {
            const adTitles = [
                "موقع تسوق إلكتروني",
                "تطبيق توصيل طعام",
                "خدمة تدفق فيديو",
                "لعبة الجوال الجديدة",
                "منصة تعليمية",
                "تطبيق موسيقى",
                "خدمة حجز سفر",
                "تطبيق لياقة بدنية",
                "منصة عمل حر",
                "متجر إلكتروني",
                "بنك رقمي",
                "تطبيق مراسلة",
                "منصة فيديوهات",
                "تطبيق تصوير",
                "خدمة توصيل"
            ];
            
            const adDescriptions = [
                "اكتشف أفضل العروض والتخفيضات الحصرية",
                "اطلب طعامك المفضل بخصم 20% لفترة محدودة",
                "اشترك الآن ومشاهدة بدون إعلانات لمدة شهر",
                "اللعبة الأكثر شهرة هذا الشهر، حمّلها الآن",
                "تعلم مهارات جديدة مجانًا مع خبراء المجال",
                "استمع لأحدث الأغاني بدون إعلانات لمدة أسبوع",
                "احجز رحلتك القادمة بأسعار مميزة وخصومات",
                "ابدأ رحلة اللياقة مع مدرب شخصي مجاني",
                "احصل على مشاريع مناسبة لمهاراتك ووقتك",
                "تسوق أحدث المنتجات بأسعار منافسة وجودة عالية",
                "افتح حسابك الرقمي واحصل على مكافأة",
                "تواصل مع أصدقائك مجانًا بدون حدود",
                "شاهد أفضل المحتوى العربي حصريًا",
                "التقط صورًا رائعة مع فلاتر احترافية",
                "احصل على توصيل مجاني لطلباتك الأولى"
            ];
            
            const publishers = [
                "Amazon",
                "Uber Eats",
                "Netflix",
                "Supercell",
                "Coursera",
                "Spotify",
                "Booking.com",
                "Fitbit",
                "Upwork",
                "AliExpress",
                "PayPal",
                "Telegram",
                "YouTube",
                "Snapchat",
                "Careem"
            ];
            
            const ads = [];
            for (let i = 0; i < count; i++) {
                ads.push({
                    id: 'sample_' + Date.now() + '_' + i,
                    title: adTitles[Math.floor(Math.random() * adTitles.length)],
                    description: adDescriptions[Math.floor(Math.random() * adDescriptions.length)],
                    reward: [5, 10, 15, 20, 25][Math.floor(Math.random() * 5)],
                    duration: 30,
                    publisher: publishers[Math.floor(Math.random() * publishers.length)],
                    budget: 10000,
                    isActive: true,
                    external: true,
                    category: ['shopping', 'food', 'entertainment', 'games', 'education'][Math.floor(Math.random() * 5)]
                });
            }
            return ads;
        }

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('#mainTabs .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').style.display = 'block';
            
            // Add active class to selected tab
            event.target.classList.add('active');
            
            // Save tab preference
            localStorage.setItem('lastTab', tabName);
        }

        function toggleFAQ(id) {
            const faqContent = document.getElementById('faq' + id);
            const icon = event.currentTarget.querySelector('i');
            
            if (faqContent.style.display === 'block') {
                faqContent.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            } else {
                faqContent.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            
            // If less than 24 hours, show relative time
            if (diff < 24 * 60 * 60 * 1000) {
                const hours = Math.floor(diff / (60 * 60 * 1000));
                const minutes = Math.floor((diff % (60 * 60 * 1000)) / (60 * 1000));
                
                if (hours > 0) {
                    return `منذ ${hours} ساعة`;
                } else if (minutes > 0) {
                    return `منذ ${minutes} دقيقة`;
                } else {
                    return "الآن";
                }
            }
            
            // Otherwise show full date
            return date.toLocaleString('ar-EG', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getStatusColor(status) {
            switch(status) {
                case 'pending': return 'pending';
                case 'approved': return 'approved';
                case 'rejected': return 'rejected';
                default: return 'pending';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'pending': return 'قيد الانتظار';
                case 'approved': return 'تم الموافقة';
                case 'rejected': return 'مرفوض';
                default: return status;
            }
        }

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function startAdsRefreshTimer() {
            // Calculate time until midnight
            const now = new Date();
            const midnight = new Date();
            midnight.setHours(24, 0, 0, 0);
            const diff = midnight - now;
            
            // Update timer display
            const timerElement = document.getElementById('adsRefreshTime');
            if (timerElement) {
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                timerElement.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
            
            // Update every second
            setTimeout(startAdsRefreshTimer, 1000);
        }

        async function checkSuspiciousActivity(userId) {
            try {
                // Check for multiple accounts from same IP
                const userSnapshot = await db.collection('users')
                    .where('ip', '==', userIP)
                    .get();
                
                if (userSnapshot.size > 3) {
                    // More than 3 accounts from same IP
                    await addNotification(userId, 'warning', 'تم اكتشاف نشاط مشبوه. يرجى التأكد من عدم إنشاء حسابات متعددة.');
                    
                    // Log suspicious activity
                    await db.collection('suspicious_activity').add({
                        userId: userId,
                        ip: userIP,
                        type: 'multiple_accounts',
                        count: userSnapshot.size,
                        timestamp: new Date().toISOString()
                    });
                }
                
            } catch (error) {
                console.error("Error checking suspicious activity:", error);
            }
        }

        async function updateUserActivity() {
            if (!currentUser) return;
            
            try {
                const userRef = db.collection('users').doc(currentUser.uid);
                await userRef.update({
                    lastActivity: new Date().toISOString()
                });
            } catch (error) {
                console.error("Error updating user activity:", error);
            }
        }

        async function trackAdStart(adId) {
            try {
                await db.collection('ad_starts').add({
                    userId: currentUser.uid,
                    adId: adId,
                    timestamp: new Date().toISOString(),
                    ip: userIP,
                    userAgent: userAgent
                });
            } catch (error) {
                console.error("Error tracking ad start:", error);
            }
        }

        function showPointsDetails() {
            if (!currentUser) return;
            
            const points = currentUser.points || 0;
            const needed = Math.max(0, 30000 - points);
            const progress = Math.min((points / 30000) * 100, 100);
            
            showConfirm(
                "تفاصيل النقاط",
                `رصيدك الحالي: ${formatNumber(points)} نقطة<br>
                 النقاط المتبقية للسحب: ${formatNumber(needed)} نقطة<br>
                 التقدم: ${progress.toFixed(1)}%<br><br>
                 <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%"></div>
                 </div>`,
                () => {}
            );
        }

        // ===========================================
        // SEARCH AND FILTER FUNCTIONS
        // ===========================================
        function setupSearchAndFilter() {
            const adSearch = document.getElementById('adSearch');
            const adFilter = document.getElementById('adFilter');
            
            if (adSearch) {
                adSearch.addEventListener('input', () => {
                    clearTimeout(window.searchTimeout);
                    window.searchTimeout = setTimeout(() => loadAds(), 500);
                });
            }
            
            if (adFilter) {
                adFilter.addEventListener('change', () => {
                    loadAds();
                });
            }
        }

        // ===========================================
        // INITIALIZE APP
        // ===========================================
        window.onload = function() {
            initializeGoogleSignIn();
            setupSearchAndFilter();
            
            // Add event listeners for withdrawal amount updates
            const withdrawAmountInput = document.getElementById('withdrawAmount');
            if (withdrawAmountInput) {
                withdrawAmountInput.addEventListener('input', updateWithdrawalAmount);
            }
            
            // Add copy protection
            document.addEventListener('copy', function(e) {
                if (!e.target.classList.contains('allow-copy')) {
                    e.preventDefault();
                    showError("ممنوع النسخ", "لا يمكن نسخ النص من هذا الموقع");
                }
            });
            
            // Disable right click
            document.addEventListener('contextmenu', function(e) {
                if (!e.target.classList.contains('allow-copy')) {
                    e.preventDefault();
                    return false;
                }
            });
            
            // Prevent zoom
            document.addEventListener('wheel', function(e) {
                if (e.ctrlKey) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            // Prevent keyboard zoom
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && (e.key === '+' || e.key === '-' || e.key === '0')) {
                    e.preventDefault();
                }
            });
            
            // Prevent text selection
            document.addEventListener('selectstart', function(e) {
                if (!e.target.classList.contains('allow-copy')) {
                    e.preventDefault();
                    return false;
                }
            });
            
            // Hide modals when clicking outside
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
            
            // Load last active tab
            const lastTab = localStorage.getItem('lastTab') || 'ads';
            if (document.getElementById(lastTab + 'Tab')) {
                switchTab(lastTab);
            }
            
            // Update stats
            updateStats();
        };

        async function updateStats() {
            try {
                // Simulate stats for demo
                document.getElementById('totalUsersStat').textContent = "10,000+";
                document.getElementById('totalPaidStat').textContent = "$50,000+";
                
                // In real app, you would fetch these from Firebase
                // const statsSnapshot = await db.collection('stats').doc('global').get();
                // if (statsSnapshot.exists) {
                //     const stats = statsSnapshot.data();
                //     document.getElementById('totalUsersStat').textContent = formatNumber(stats.totalUsers) + '+';
                //     document.getElementById('totalPaidStat').textContent = '$' + formatNumber(stats.totalPaid) + '+';
                // }
                
            } catch (error) {
                console.error("Error updating stats:", error);
            }
        }

        // ===========================================
        // ADDITIONAL SECURITY MEASURES
        // ===========================================
        // Detect if user tries to open multiple tabs/windows
        window.addEventListener('storage', function(e) {
            if (e.key === 'advista_active_session' && e.newValue) {
                showError("تم اكتشاف جلسة أخرى", "لا يمكن فتح أكثر من نافذة واحدة");
                setTimeout(() => {
                    window.location.href = 'about:blank';
                }, 2000);
            }
        });

        // Store that user is active
        function setSessionActive(active) {
            if (active) {
                localStorage.setItem('advista_active_session', 'true');
            } else {
                localStorage.removeItem('advista_active_session');
            }
        }

        // Detect device changes
        window.addEventListener('resize', function() {
            if (currentUser && currentAd) {
                cancelAd();
                showError("تم اكتشاف تغيير في الحجم", "تم إلغاء الإعلان بسبب تغيير حجم النافذة");
            }
        });

        // ===========================================
        // PROGRESSIVE WEB APP FEATURES
        // ===========================================
        // Check if browser supports service workers
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js').then(function(registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }

        // Check for updates
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            // You can show an install button here
        });

        // ===========================================
        // OFFLINE DETECTION
        // ===========================================
        window.addEventListener('online', function() {
            showSuccess("تم استعادة الاتصال", "أنت متصل بالإنترنت الآن");
        });

        window.addEventListener('offline', function() {
            showError("فقد الاتصال", "أنت غير متصل بالإنترنت. يرجى التحقق من اتصالك");
        });

        // ===========================================
        // PERFORMANCE MONITORING
        // ===========================================
        window.addEventListener('load', function() {
            // Log page load performance
            const perfData = window.performance.timing;
            const pageLoadTime = perfData.loadEventEnd - perfData.navigationStart;
            console.log(`Page loaded in ${pageLoadTime}ms`);
            
            // Send to analytics if needed
            if (currentUser && pageLoadTime > 3000) {
                console.warn('Slow page load detected');
            }
        });

        // ===========================================
        // ERROR HANDLING
        // ===========================================
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Error: ' + msg + '\nURL: ' + url + '\nLine: ' + lineNo + '\nColumn: ' + columnNo + '\nError object: ' + error);
            
            // Don't show error to user for minor errors
            if (msg.includes('Script error')) {
                return false;
            }
            
            return true;
        };

        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection: ' + event.reason);
        });

        // ===========================================
        // ACCESSIBILITY IMPROVEMENTS
        // ===========================================
        // Add keyboard navigation
        document.addEventListener('keydown', function(e) {
            // Escape key closes modals
            if (e.key === 'Escape') {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (modal.style.display === 'flex') {
                        modal.style.display = 'none';
                    }
                });
            }
            
            // Enter key on ad search triggers search
            if (e.key === 'Enter' && e.target.id === 'adSearch') {
                loadAds();
            }
            
            // Space key on ad cards triggers click
            if (e.key === ' ' && e.target.classList.contains('ad-card')) {
                e.preventDefault();
                e.target.click();
            }
        });

        // Focus management for modals
        const modalObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                    const modal = mutation.target;
                    if (modal.style.display === 'flex') {
                        // Focus on first input in modal
                        const firstInput = modal.querySelector('input, button');
                        if (firstInput) {
                            setTimeout(() => firstInput.focus(), 100);
                        }
                    }
                }
            });
        });

        // Observe all modals
        document.querySelectorAll('.modal').forEach(modal => {
            modalObserver.observe(modal, { attributes: true });
        });

        // ===========================================
        // FINAL INITIALIZATION
        // ===========================================
        console.log('Advista Platform Loaded Successfully');
        console.log('Firebase Initialized:', firebase.app().name);
        console.log('User Agent:', navigator.userAgent);
        console.log('Screen Size:', window.innerWidth + 'x' + window.innerHeight);
        console.log('Platform:', navigator.platform);
        console.log('Language:', navigator.language);
        
        // Set session as active
        setSessionActive(true);
        
        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            setSessionActive(false);
            if (currentUser) {
                updateUserActivity();
            }
        });
    </script>
</body>
                            </html>
