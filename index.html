<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ادفيستا - ربح المال من مشاهدة الإعلانات</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        /* جميع الأنماط السابقة كما هي */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a237e 0%, #311b92 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
            position: relative;
            -webkit-text-size-adjust: 100%;
            touch-action: pan-y;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            min-height: 90vh;
        }
        
        .header {
            background: linear-gradient(90deg, #0d47a1 0%, #311b92 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 2.5rem;
            color: #ffd600;
        }
        
        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .logo span {
            color: #ffd600;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .points {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 50px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .points i {
            color: #ffd600;
        }
        
        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 3px solid #ffd600;
            object-fit: cover;
        }
        
        .logout-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .main-content {
            display: flex;
            min-height: 70vh;
        }
        
        .sidebar {
            width: 250px;
            background-color: #f5f5f5;
            padding: 20px 0;
            border-left: 1px solid #e0e0e0;
        }
        
        .nav-menu {
            list-style: none;
        }
        
        .nav-menu li {
            margin-bottom: 5px;
        }
        
        .nav-menu a {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            color: #333;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
            border-right: 4px solid transparent;
        }
        
        .nav-menu a:hover, .nav-menu a.active {
            background-color: #e3f2fd;
            border-right: 4px solid #0d47a1;
            color: #0d47a1;
        }
        
        .nav-menu i {
            width: 20px;
            text-align: center;
        }
        
        .content-area {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            max-height: 70vh;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-title {
            font-size: 1.8rem;
            color: #0d47a1;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Login Page Styles */
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
            padding: 20px;
            text-align: center;
        }
        
        .login-box {
            background-color: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
        }
        
        .login-box h2 {
            color: #0d47a1;
            margin-bottom: 10px;
        }
        
        .login-box p {
            color: #666;
            margin-bottom: 30px;
        }
        
        .google-login-btn {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 20px auto;
            width: 100%;
            max-width: 300px;
            transition: all 0.3s;
        }
        
        .google-login-btn:hover {
            background-color: #3367D6;
            transform: translateY(-2px);
        }
        
        .google-login-btn i {
            font-size: 1.5rem;
        }
        
        .login-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }
        
        .feature {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .feature i {
            font-size: 2rem;
            color: #0d47a1;
            margin-bottom: 10px;
        }
        
        /* باقي الأنماط تبقى كما هي... */
        
        /* إضافة الأنماط السابقة جميعها هنا */
        /* ... جميع الأنماط السابقة من الكود الأول ... */
        
        /* سأضيف الأنماط الهامة فقط للتنسيق */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #0d47a1 0%, #311b92 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(13, 71, 161, 0.2);
        }
        
        .ads-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .ad-card {
            background-color: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
                border-radius: 10px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                border-left: none;
                border-bottom: 1px solid #e0e0e0;
            }
            
            .nav-menu {
                display: flex;
                overflow-x: auto;
                padding-bottom: 10px;
            }
            
            .ads-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header" id="header" style="display: none;">
            <div class="logo">
                <i class="fas fa-ad"></i>
                <h1>ادفيستا <span>Advista</span></h1>
            </div>
            <div class="user-info" id="userInfo">
                <div class="points">
                    <i class="fas fa-coins"></i>
                    <span id="userPoints">0</span> نقطة
                </div>
                <img id="userAvatar" class="user-avatar" src="" alt="صورة المستخدم">
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
                </button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content" id="mainContent" style="display: none;">
            <!-- Sidebar Navigation -->
            <div class="sidebar">
                <ul class="nav-menu">
                    <li><a href="#" onclick="showSection('dashboard')" class="active" id="navDashboard"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</a></li>
                    <li><a href="#" onclick="showSection('ads')" id="navAds"><i class="fas fa-ad"></i> تصفح الإعلانات</a></li>
                    <li><a href="#" onclick="showSection('referral')" id="navReferral"><i class="fas fa-user-friends"></i> نظام الإحالات</a></li>
                    <li><a href="#" onclick="showSection('withdrawal')" id="navWithdrawal"><i class="fas fa-money-bill-wave"></i> السحب</a></li>
                    <li><a href="#" onclick="showSection('admin')" id="navAdmin" style="display: none;"><i class="fas fa-user-shield"></i> لوحة الأدمن</a></li>
                </ul>
            </div>
            
            <!-- Content Area -->
            <div class="content-area">
                <!-- Dashboard Section -->
                <div class="section active" id="dashboardSection">
                    <h2 class="section-title"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</h2>
                    
                    <div class="stats-cards">
                        <div class="stat-card">
                            <i class="fas fa-coins"></i>
                            <h3>رصيدك الحالي</h3>
                            <div class="value" id="currentBalance">0 نقطة</div>
                            <div class="subtext">$<span id="balanceDollars">0.00</span> دولار</div>
                        </div>
                        
                        <div class="stat-card">
                            <i class="fas fa-chart-line"></i>
                            <h3>أرباح اليوم</h3>
                            <div class="value" id="todayEarnings">0 نقطة</div>
                            <div class="subtext">من <span id="todayAds">0</span> إعلان</div>
                        </div>
                        
                        <div class="stat-card">
                            <i class="fas fa-trophy"></i>
                            <h3>إجمالي الأرباح</h3>
                            <div class="value" id="totalEarnings">0 نقطة</div>
                            <div class="subtext">$<span id="totalDollars">0.00</span> دولار</div>
                        </div>
                        
                        <div class="stat-card">
                            <i class="fas fa-users"></i>
                            <h3>الإحالات</h3>
                            <div class="value" id="referralCount">0</div>
                            <div class="subtext">ربحت منهم <span id="referralEarnings">0</span> نقطة</div>
                        </div>
                    </div>
                </div>
                
                <!-- Ads Section -->
                <div class="section" id="adsSection">
                    <h2 class="section-title"><i class="fas fa-ad"></i> تصفح الإعلانات</h2>
                    
                    <div id="adsContainer" class="ads-grid">
                        <!-- الإعلانات ستظهر هنا -->
                        <div class="ad-card">
                            <div class="ad-header">
                                <div class="ad-title">إعلان تجريبي 1</div>
                                <div class="ad-points">10 نقاط</div>
                            </div>
                            <div class="ad-body">
                                <p class="ad-description">شاهد هذا الإعلان التجريبي لمدة 30 ثانية لتربح 10 نقاط</p>
                                <div style="color: #666; font-size: 0.9rem; margin-bottom: 15px;">
                                    <i class="far fa-clock"></i> 30 ثانية
                                </div>
                                <button class="ad-btn" onclick="viewAd('ad1')">
                                    <i class="fas fa-play"></i> مشاهدة الإعلان
                                </button>
                            </div>
                        </div>
                        
                        <div class="ad-card">
                            <div class="ad-header">
                                <div class="ad-title">إعلان تجريبي 2</div>
                                <div class="ad-points">15 نقاط</div>
                            </div>
                            <div class="ad-body">
                                <p class="ad-description">شاهد هذا الإعلان التجريبي لمدة 45 ثانية لتربح 15 نقطة</p>
                                <div style="color: #666; font-size: 0.9rem; margin-bottom: 15px;">
                                    <i class="far fa-clock"></i> 45 ثانية
                                </div>
                                <button class="ad-btn" onclick="viewAd('ad2')">
                                    <i class="fas fa-play"></i> مشاهدة الإعلان
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- مؤقت الإعلان -->
                    <div id="adTimerModal" style="display: none; margin-top: 30px;">
                        <div class="ad-card" style="max-width: 500px; margin: 0 auto;">
                            <div class="ad-header">
                                <div class="ad-title" id="adModalTitle">إعلان</div>
                                <div class="ad-points" id="adModalPoints">0 نقطة</div>
                            </div>
                            <div class="ad-body">
                                <p id="adModalDescription" class="ad-description">وصف الإعلان</p>
                                
                                <div class="ad-timer">
                                    <div class="timer-display" id="timerDisplay">30</div>
                                    <div class="timer-text" id="timerText">ثانية متبقية</div>
                                </div>
                                
                                <p style="color: #f44336; text-align: center; margin: 15px 0; font-weight: bold;">
                                    <i class="fas fa-exclamation-triangle"></i> إذا خرجت قبل انتهاء العداد سيتم خصم 5 نقاط!
                                </p>
                                
                                <button class="ad-btn" onclick="startAdTimer()" id="startTimerBtn">
                                    <i class="fas fa-play"></i> بدء مشاهدة الإعلان
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Referral Section -->
                <div class="section" id="referralSection">
                    <h2 class="section-title"><i class="fas fa-user-friends"></i> نظام الإحالات</h2>
                    
                    <div class="referral-box">
                        <h3>اربح 10% من أرباح كل شخص تدعوه!</h3>
                        <p>شارك رابط الإحالة الخاص بك واربح نقاط من كل إعلان يشاهده أصدقائك.</p>
                        
                        <div class="referral-link selectable-text" id="referralLink">
                            https://advista.com/ref?code=loading...
                        </div>
                        
                        <button class="copy-btn" onclick="copyReferralLink()">
                            <i class="far fa-copy"></i> نسخ رابط الإحالة
                        </button>
                    </div>
                </div>
                
                <!-- Withdrawal Section -->
                <div class="section" id="withdrawalSection">
                    <h2 class="section-title"><i class="fas fa-money-bill-wave"></i> طلبات السحب</h2>
                    
                    <div class="withdrawal-info">
                        <h3><i class="fas fa-info-circle"></i> معلومات السحب</h3>
                        <ul>
                            <li>الحد الأدنى للسحب: <strong>30,000 نقطة</strong> ($1 دولار)</li>
                            <li>عمولة السحب: <strong>0%</strong> (لا توجد عمولة)</li>
                            <li>طريقة السحب: <strong>فودافون كاش</strong> فقط</li>
                            <li>مدة المعالجة: <strong>24-48 ساعة</strong> بعد الموافقة</li>
                        </ul>
                    </div>
                    
                    <div class="withdrawal-form">
                        <div class="form-group">
                            <label for="withdrawalAmount"><i class="fas fa-coins"></i> عدد النقاط المراد سحبها</label>
                            <input type="number" class="form-control" id="withdrawalAmount" min="30000" placeholder="أدخل عدد النقاط (الحد الأدنى 30,000)">
                        </div>
                        
                        <div class="form-group">
                            <label for="vodafoneNumber"><i class="fas fa-mobile-alt"></i> رقم فودافون كاش</label>
                            <input type="text" class="form-control" id="vodafoneNumber" placeholder="أدخل رقم فودافون كاش">
                        </div>
                        
                        <button class="submit-btn" onclick="submitWithdrawal()">
                            <i class="fas fa-paper-plane"></i> إرسال طلب السحب
                        </button>
                    </div>
                </div>
                
                <!-- Admin Section -->
                <div class="section" id="adminSection" style="display: none;">
                    <h2 class="section-title"><i class="fas fa-user-shield"></i> لوحة الأدمن</h2>
                    <div style="padding: 20px; background: #f5f5f5; border-radius: 10px;">
                        <h3>مرحباً يا أدمن!</h3>
                        <p>هذه لوحة التحكم الإدارية. يمكنك إضافة إعلانات جديدة وعرض طلبات السحب.</p>
                        <button class="ad-btn" onclick="addSampleAd()" style="margin-top: 15px;">
                            <i class="fas fa-plus"></i> إضافة إعلان تجريبي
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Login Section -->
        <div class="login-container" id="loginSection">
            <div class="login-box">
                <h2>مرحباً بك في <span style="color: #0d47a1;">ادفيستا</span></h2>
                <p>موقع ربح الأموال من مشاهدة الإعلانات</p>
                
                <button class="google-login-btn" onclick="signInWithGoogle()">
                    <i class="fab fa-google"></i>
                    تسجيل الدخول باستخدام جوجل
                </button>
                
                <div style="margin-top: 30px; color: #666;">
                    <p><i class="fas fa-check-circle" style="color: #4caf50;"></i> سجل الدخول باستخدام حساب جوجل للبدء</p>
                </div>
            </div>
            
            <div class="login-features">
                <div class="feature">
                    <i class="fas fa-ad"></i>
                    <h3>شاهد الإعلانات</h3>
                    <p>اربح النقاط بمشاهدة الإعلانات</p>
                </div>
                
                <div class="feature">
                    <i class="fas fa-user-friends"></i>
                    <h3>دعوة الأصدقاء</h3>
                    <p>اربح 10% من أرباح أحالتك</p>
                </div>
                
                <div class="feature">
                    <i class="fas fa-money-bill-wave"></i>
                    <h3>السحب السريع</h3>
                    <p>اسحب أرباحك عبر فودافون كاش</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC4fZQ-BTUeHsN9nQtMGmnjJz-NKdcUgkc",
            authDomain: "advista-b64ab.firebaseapp.com",
            projectId: "advista-b64ab",
            storageBucket: "advista-b64ab.firebasestorage.app",
            messagingSenderId: "509713648189",
            appId: "1:509713648189:web:0ccd6ada1f4e07f85d3854",
            measurementId: "G-VG4S1SMKH8"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Global Variables
        let currentUser = null;
        let userData = null;
        let adTimer = null;
        let adTimeLeft = 30;
        let adTimerStarted = false;
        
        // Google Sign-In Function
        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.addScope('profile');
            provider.addScope('email');
            
            auth.signInWithPopup(provider)
                .then((result) => {
                    // User signed in successfully
                    const user = result.user;
                    console.log("تم تسجيل الدخول بنجاح:", user.email);
                    
                    // Check if user is admin
                    if (user.email === 'bo2584668@gmail.com') {
                        console.log("مرحباً أيها المسؤول!");
                    }
                    
                    // Handle user data
                    handleUserLogin(user);
                })
                .catch((error) => {
                    console.error("خطأ في تسجيل الدخول:", error);
                    alert("حدث خطأ أثناء تسجيل الدخول: " + error.message);
                });
        }
        
        // Handle User Login
        async function handleUserLogin(user) {
            try {
                // Check if user exists in Firestore
                const userDoc = await db.collection("users").doc(user.uid).get();
                
                if (!userDoc.exists) {
                    // Create new user
                    const newUser = {
                        uid: user.uid,
                        name: user.displayName,
                        email: user.email,
                        avatar: user.photoURL,
                        points: 100, // نقاط هدايا للمستخدم الجديد
                        totalEarned: 100,
                        todayEarnings: 0,
                        todayAds: 0,
                        referralCode: generateReferralCode(),
                        referralCount: 0,
                        referralEarnings: 0,
                        membership: "free",
                        createdAt: new Date().toISOString(),
                        lastLogin: new Date().toISOString()
                    };
                    
                    await db.collection("users").doc(user.uid).set(newUser);
                    userData = newUser;
                    
                    showNotification("مرحباً بك! لقد حصلت على 100 نقطة هدية!", "success");
                } else {
                    userData = userDoc.data();
                    
                    // Update last login
                    await db.collection("users").doc(user.uid).update({
                        lastLogin: new Date().toISOString()
                    });
                }
                
                currentUser = user;
                initializeApp();
                
            } catch (error) {
                console.error("خطأ في حفظ بيانات المستخدم:", error);
            }
        }
        
        // Generate Referral Code
        function generateReferralCode() {
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
            let code = "";
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        // Initialize App After Login
        function initializeApp() {
            // Hide login section, show main content
            document.getElementById("loginSection").style.display = "none";
            document.getElementById("mainContent").style.display = "flex";
            document.getElementById("header").style.display = "flex";
            
            // Check if user is admin
            if (currentUser.email === "bo2584668@gmail.com") {
                document.getElementById("navAdmin").style.display = "block";
                document.getElementById("adminSection").style.display = "block";
            }
            
            // Load user data
            loadUserData();
        }
        
        // Load User Data
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                const userDoc = await db.collection("users").doc(currentUser.uid).get();
                if (userDoc.exists) {
                    userData = userDoc.data();
                    
                    // Update UI
                    document.getElementById("userPoints").textContent = userData.points;
                    document.getElementById("userAvatar").src = userData.avatar || "https://ui-avatars.com/api/?name=" + encodeURIComponent(userData.name) + "&background=0d47a1&color=fff";
                    
                    // Dashboard stats
                    document.getElementById("currentBalance").textContent = userData.points + " نقطة";
                    document.getElementById("balanceDollars").textContent = (userData.points / 30000).toFixed(2);
                    
                    document.getElementById("todayEarnings").textContent = (userData.todayEarnings || 0) + " نقطة";
                    document.getElementById("todayAds").textContent = userData.todayAds || 0;
                    
                    document.getElementById("totalEarnings").textContent = userData.totalEarned + " نقطة";
                    document.getElementById("totalDollars").textContent = (userData.totalEarned / 30000).toFixed(2);
                    
                    document.getElementById("referralCount").textContent = userData.referralCount || 0;
                    document.getElementById("referralEarnings").textContent = userData.referralEarnings || 0;
                    
                    // Referral section
                    document.getElementById("referralLink").textContent = window.location.origin + "?ref=" + userData.referralCode;
                }
            } catch (error) {
                console.error("Error loading user data:", error);
            }
        }
        
        // Show Section
        function showSection(sectionId) {
            // Hide all sections
            const sections = document.querySelectorAll(".section");
            sections.forEach(section => {
                section.classList.remove("active");
            });
            
            // Remove active class from all nav items
            const navItems = document.querySelectorAll(".nav-menu a");
            navItems.forEach(item => {
                item.classList.remove("active");
            });
            
            // Show selected section
            document.getElementById(sectionId + "Section").classList.add("active");
            
            // Activate corresponding nav item
            document.getElementById("nav" + sectionId.charAt(0).toUpperCase() + sectionId.slice(1)).classList.add("active");
        }
        
        // View Ad
        function viewAd(adId) {
            let adTitle, adPoints, adDescription;
            
            if (adId === 'ad1') {
                adTitle = "إعلان تجريبي 1";
                adPoints = "10";
                adDescription = "شاهد هذا الإعلان التجريبي لمدة 30 ثانية لتربح 10 نقاط";
                adTimeLeft = 30;
            } else {
                adTitle = "إعلان تجريبي 2";
                adPoints = "15";
                adDescription = "شاهد هذا الإعلان التجريبي لمدة 45 ثانية لتربح 15 نقطة";
                adTimeLeft = 45;
            }
            
            // Show ad timer modal
            document.getElementById("adTimerModal").style.display = "block";
            document.getElementById("adModalTitle").textContent = adTitle;
            document.getElementById("adModalPoints").textContent = adPoints + " نقطة";
            document.getElementById("adModalDescription").textContent = adDescription;
            document.getElementById("timerDisplay").textContent = adTimeLeft;
            document.getElementById("timerText").textContent = "ثانية متبقية";
            
            // Scroll to timer
            document.getElementById("adTimerModal").scrollIntoView({ behavior: 'smooth' });
        }
        
        // Start Ad Timer
        function startAdTimer() {
            if (adTimerStarted) return;
            
            adTimerStarted = true;
            const startBtn = document.getElementById("startTimerBtn");
            startBtn.disabled = true;
            startBtn.innerHTML = '<i class="fas fa-play"></i> جاري العرض...';
            
            // Start countdown
            adTimer = setInterval(() => {
                adTimeLeft--;
                document.getElementById("timerDisplay").textContent = adTimeLeft;
                
                if (adTimeLeft <= 0) {
                    clearInterval(adTimer);
                    completeAdView();
                }
            }, 1000);
        }
        
        // Complete Ad View
        async function completeAdView() {
            document.getElementById("timerText").textContent = "تم انتهاء الوقت!";
            
            try {
                // Award points (10 points for demo)
                const pointsEarned = 10;
                
                await db.collection("users").doc(currentUser.uid).update({
                    points: firebase.firestore.FieldValue.increment(pointsEarned),
                    totalEarned: firebase.firestore.FieldValue.increment(pointsEarned),
                    todayEarnings: firebase.firestore.FieldValue.increment(pointsEarned),
                    todayAds: firebase.firestore.FieldValue.increment(1)
                });
                
                showNotification(`مبروك! لقد ربحت ${pointsEarned} نقطة!`, "success");
                
                // Reset and go back to ads
                setTimeout(() => {
                    document.getElementById("adTimerModal").style.display = "none";
                    adTimerStarted = false;
                    adTimeLeft = 30;
                    loadUserData();
                }, 2000);
                
            } catch (error) {
                console.error("Error awarding points:", error);
                showNotification("حدث خطأ أثناء معالجة النقاط", "error");
            }
        }
        
        // Handle page visibility change (user leaving the page)
        document.addEventListener("visibilitychange", function() {
            if (adTimerStarted && document.hidden && adTimeLeft > 0) {
                // User left the page during ad view
                deductPointsForLeaving();
            }
        });
        
        // Deduct points for leaving ad early
        async function deductPointsForLeaving() {
            if (!adTimerStarted || adTimeLeft <= 0) return;
            
            try {
                await db.collection("users").doc(currentUser.uid).update({
                    points: firebase.firestore.FieldValue.increment(-5)
                });
                
                showNotification("تم خصم 5 نقاط لمغادرتك الإعلان قبل انتهاء الوقت!", "warning");
                
                // Reset ad view
                clearInterval(adTimer);
                document.getElementById("adTimerModal").style.display = "none";
                adTimerStarted = false;
                adTimeLeft = 30;
                loadUserData();
                
            } catch (error) {
                console.error("Error deducting points:", error);
            }
        }
        
        // Copy Referral Link
        function copyReferralLink() {
            const link = document.getElementById("referralLink").textContent;
            navigator.clipboard.writeText(link).then(() => {
                showNotification("تم نسخ رابط الإحالة بنجاح!", "success");
            });
        }
        
        // Submit Withdrawal Request
        async function submitWithdrawal() {
            const points = parseInt(document.getElementById("withdrawalAmount").value);
            const vodafoneNumber = document.getElementById("vodafoneNumber").value;
            
            if (!points || points < 30000) {
                showNotification("الحد الأدنى للسحب هو 30,000 نقطة", "error");
                return;
            }
            
            if (!vodafoneNumber) {
                showNotification("يرجى إدخال رقم فودافون كاش", "error");
                return;
            }
            
            if (points > userData.points) {
                showNotification("ليس لديك نقاط كافية للسحب", "error");
                return;
            }
            
            try {
                // In real app, you would save this to Firebase
                // For demo, we'll just show a message
                showNotification("تم إرسال طلب السحب بنجاح! سيتم مراجعته من قبل الأدمن.", "success");
                
                // Reset form
                document.getElementById("withdrawalAmount").value = "";
                document.getElementById("vodafoneNumber").value = "";
                
                // In real app: send WhatsApp message to admin
                const message = `طلب سحب جديد من ${userData.name} (${userData.email})\nالنقاط: ${points}\nالمبلغ: $${(points/30000).toFixed(2)}\nرقم فودافون: ${vodafoneNumber}`;
                
                console.log("رسالة للأدمن على الواتساب:", message);
                
            } catch (error) {
                console.error("Error submitting withdrawal:", error);
                showNotification("حدث خطأ أثناء إرسال طلب السحب", "error");
            }
        }
        
        // Add Sample Ad (Admin Function)
        function addSampleAd() {
            showNotification("تم إضافة إعلان تجريبي جديد!", "success");
        }
        
        // Show Notification
        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement("div");
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 10px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
                animation: slideIn 0.5s, fadeOut 0.5s 2.5s forwards;
            `;
            
            if (type === "success") {
                notification.style.backgroundColor = "#4caf50";
            } else if (type === "error") {
                notification.style.backgroundColor = "#f44336";
            } else if (type === "warning") {
                notification.style.backgroundColor = "#ff9800";
            } else {
                notification.style.backgroundColor = "#2196f3";
            }
            
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Logout
        function logout() {
            if (confirm("هل أنت متأكد من تسجيل الخروج؟")) {
                auth.signOut().then(() => {
                    // Hide main content, show login
                    document.getElementById("mainContent").style.display = "none";
                    document.getElementById("header").style.display = "none";
                    document.getElementById("loginSection").style.display = "flex";
                    
                    // Reset user data
                    currentUser = null;
                    userData = null;
                    
                    showNotification("تم تسجيل الخروج بنجاح", "success");
                });
            }
        }
        
        // Check if user is already logged in
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                handleUserLogin(user);
            }
        });
        
        // Prevent zoom on mobile
        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });
        
        // Initialize when page loads
        window.onload = function() {
            // Check if user is already logged in
            // This is handled by onAuthStateChanged above
        };
    </script>
</body>
</html>
