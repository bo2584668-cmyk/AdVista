<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Advista - كسب المال من مشاهدة الإعلانات</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Google Sign-In -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Segoe UI', 'Cairo', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            touch-action: manipulation;
            overflow-x: hidden;
            color: #333;
            line-height: 1.6;
        }
        
        /* Disable Zoom and Selection */
        body.no-zoom {
            touch-action: pan-x pan-y;
            max-zoom: 1;
            min-zoom: 1;
        }
        
        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }
        
        /* Login Screen */
        #loginScreen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px 30px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            max-width: 450px;
            width: 100%;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .logo {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .logo-icon {
            font-size: 4rem;
            color: #667eea;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .logo h1 {
            color: #667eea;
            font-size: 2.5rem;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .points-display {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            padding: 10px 20px;
            border-radius: 50px;
            color: #333;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 3px 10px rgba(255, 165, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.3s ease;
        }
        
        .points-display:hover {
            transform: scale(1.05);
        }
        
        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            animation: fadeInUp 0.5s ease;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }
        
        .card-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            background: white;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .stat-item:hover {
            transform: translateY(-3px);
        }
        
        .stat-item h3 {
            color: #666;
            font-size: 0.95rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
        }
        
        /* Ads Grid */
        .ads-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .ad-card {
            background: white;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .ad-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        
        .ad-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
        }
        
        .ad-title {
            font-weight: bold;
            color: #333;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        
        .ad-reward {
            color: #FFD700;
            font-weight: bold;
            background: rgba(255, 215, 0, 0.1);
            padding: 6px 12px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.95rem;
        }
        
        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-50px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .timer {
            font-size: 3.5rem;
            font-weight: bold;
            color: #667eea;
            margin: 25px 0;
            font-family: 'Courier New', monospace;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Buttons */
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:hover::after {
            width: 300px;
            height: 300px;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn:active {
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #FF416C, #FF4B2B);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #00b09b, #96c93d);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #FFD700, #FFA500);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
        }
        
        /* Inputs */
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
            background: white;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        /* Loading */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            flex-direction: column;
            gap: 20px;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        /* Alert Messages */
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            animation: slideInRight 0.3s ease;
            position: relative;
            padding-right: 40px;
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .alert-close {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 10px 10px 0 0;
            background: #f5f5f5;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .tab:hover {
            background: #e9ecef;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }
        
        .tab-content {
            animation: fadeIn 0.3s ease;
        }
        
        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 600px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
        }
        
        th {
            background: #667eea;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        
        tbody tr {
            transition: background 0.3s ease;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        tbody tr:last-child td {
            border-bottom: none;
        }
        
        /* Status Badges */
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            display: inline-block;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-approved {
            background: #d4edda;
            color: #155724;
        }
        
        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        
        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background: #333;
            color: white;
            text-align: center;
            padding: 10px;
            border-radius: 6px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9rem;
            font-weight: normal;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            background: #667eea;
            color: white;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-right: 5px;
        }
        
        /* Admin Panel */
        .admin-panel {
            display: none;
        }
        
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .admin-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .admin-card:hover {
            transform: translateY(-5px);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                flex-direction: column;
                text-align: center;
                padding: 15px;
            }
            
            .user-info {
                justify-content: center;
                width: 100%;
            }
            
            .ads-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                padding: 20px;
                width: 95%;
            }
            
            .timer {
                font-size: 2.5rem;
            }
            
            .login-card {
                padding: 25px 20px;
            }
            
            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
                padding-bottom: 5px;
            }
            
            .tab {
                white-space: nowrap;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        @media (max-width: 480px) {
            .logo h1 {
                font-size: 2rem;
            }
            
            .logo-icon {
                font-size: 3rem;
            }
            
            .card-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .points-display {
                font-size: 1rem;
                padding: 8px 15px;
            }
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }
        
        /* Selection (only for allowed elements) */
        ::selection {
            background: rgba(102, 126, 234, 0.3);
            color: #333;
        }
        
        /* Custom Checkbox */
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            cursor: pointer;
        }
        
        .checkbox-container input[type="checkbox"] {
            width: auto;
            transform: scale(1.2);
        }
        
        /* Divider */
        .divider {
            height: 1px;
            background: linear-gradient(to right, transparent, #e0e0e0, transparent);
            margin: 20px 0;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #ddd;
        }
        
        /* Notification Bell */
        .notification-bell {
            position: relative;
            cursor: pointer;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #FF416C;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Gradient Text */
        .gradient-text {
            background: linear-gradient(45deg, #667eea, #FF416C);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>
<body class="no-zoom" oncontextmenu="return false;" onselectstart="return false;" ondragstart="return false;">
    <!-- Loading Overlay -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">جاري تحميل التطبيق...</div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-card">
            <div class="logo">
                <i class="fas fa-gem logo-icon float"></i>
                <h1 class="gradient-text">Advista</h1>
                <p style="color: #666; font-size: 1.1rem; max-width: 300px; margin: 0 auto;">منصة كسب المال من مشاهدة الإعلانات</p>
            </div>
            
            <div style="margin: 30px 0;">
                <h2 style="color: #333; margin-bottom: 10px;">سجل الدخول لتبدأ الربح</h2>
                <p style="color: #666; margin-bottom: 25px;">سجل دخولك باستخدام حساب جوجل للبدء في كسب النقاط</p>
                
                <div id="googleSignInButton" style="margin: 25px 0; min-height: 50px;">
                    <div id="buttonDiv"></div>
                </div>
                
                <div id="loginError" style="color: #FF416C; margin: 15px 0; display: none; padding: 10px; background: rgba(255, 65, 108, 0.1); border-radius: 8px;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="loginErrorText"></span>
                </div>
                
                <div style="color: #666; font-size: 0.9rem; margin-top: 20px;">
                    <p>بالتسجيل فإنك توافق على <a href="#" style="color: #667eea;">شروط الاستخدام</a> و <a href="#" style="color: #667eea;">سياسة الخصوصية</a></p>
                </div>
            </div>
            
            <!-- Stats Info -->
            <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); padding: 20px; border-radius: 10px; margin-top: 30px;">
                <h3 style="color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; justify-content: center;">
                    <i class="fas fa-chart-line"></i> إحصائيات المنصة
                </h3>
                <div class="grid-2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.8rem; font-weight: bold; color: #667eea;" id="totalUsersStat">10,000+</div>
                        <div style="color: #666; font-size: 0.9rem;">مستخدم نشط</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.8rem; font-weight: bold; color: #00b09b;" id="totalPaidStat">$50,000+</div>
                        <div style="color: #666; font-size: 0.9rem;">إجمالي المدفوعات</div>
                    </div>
                </div>
            </div>
            
            <!-- Features -->
            <div style="margin-top: 30px;">
                <div class="grid-2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div style="text-align: center; padding: 15px; background: rgba(0, 176, 155, 0.1); border-radius: 10px;">
                        <i class="fas fa-bolt" style="color: #00b09b; font-size: 1.5rem; margin-bottom: 8px;"></i>
                        <div style="font-weight: bold; color: #333;">سحب سريع</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: rgba(255, 215, 0, 0.1); border-radius: 10px;">
                        <i class="fas fa-users" style="color: #FFD700; font-size: 1.5rem; margin-bottom: 8px;"></i>
                        <div style="font-weight: bold; color: #333;">نظام إحالة</div>
                    </div>
                </div>
                
                <div class="grid-2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: rgba(255, 65, 108, 0.1); border-radius: 10px;">
                        <i class="fas fa-shield-alt" style="color: #FF416C; font-size: 1.5rem; margin-bottom: 8px;"></i>
                        <div style="font-weight: bold; color: #333;">آمن</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 10px;">
                        <i class="fas fa-headset" style="color: #667eea; font-size: 1.5rem; margin-bottom: 8px;"></i>
                        <div style="font-weight: bold; color: #333;">دعم فني</div>
                    </div>
                </div>
            </div>
            
            <!-- Footer Info -->
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                <p style="color: #999; font-size: 0.85rem; text-align: center;">
                    <i class="fas fa-lock"></i> معلوماتك محمية ولا يتم مشاركتها مع أي طرف ثالث
                </p>
            </div>
        </div>
    </div>

    <!-- User Dashboard (Hidden by default) -->
    <div id="userDashboard" style="display: none;">
        <!-- Floating Action Button -->
        <div class="fab no-print" onclick="showWithdrawalModal()" title="طلب سحب" style="position: fixed; bottom: 20px; left: 20px; width: 60px; height: 60px; background: linear-gradient(45deg, #667eea, #764ba2); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); z-index: 100; transition: all 0.3s ease;">
            <i class="fas fa-wallet"></i>
        </div>

        <div class="container">
            <!-- Alert Messages -->
            <div id="mainAlert" class="alert" style="display: none;"></div>
            
            <!-- Header -->
            <div class="header">
                <div class="d-flex align-center gap-2" style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-gem" style="font-size: 2rem; color: #667eea;"></i>
                    <div>
                        <h1 style="margin: 0; color: #667eea; font-size: 1.5rem;">Advista</h1>
                        <p style="margin: 5px 0 0; color: #666; font-size: 0.9rem;" id="userEmail"></p>
                    </div>
                </div>
                
                <div class="user-info">
                    <div class="points-display tooltip" onclick="showPointsDetails()">
                        <i class="fas fa-coins"></i>
                        <span id="userPoints">0</span> نقطة
                    </div>
                    
                    <div class="d-flex align-center gap-1" style="display: flex; align-items: center; gap: 5px;">
                        <button onclick="logout()" class="btn btn-danger" style="padding: 8px 15px;">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>خروج</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-item">
                    <h3><i class="fas fa-chart-line"></i> إجمالي الأرباح</h3>
                    <div class="stat-value" id="totalEarned">0 نقطة</div>
                    <div class="progress-bar mt-2">
                        <div class="progress-fill" id="totalEarnedProgress" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="stat-item">
                    <h3><i class="fas fa-calendar-day"></i> أرباح اليوم</h3>
                    <div class="stat-value" id="dailyEarned">0 نقطة</div>
                    <div class="progress-bar mt-2">
                        <div class="progress-fill" id="dailyEarnedProgress" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="stat-item">
                    <h3><i class="fas fa-users"></i> الإحالات</h3>
                    <div class="stat-value" id="referralCount">0 مستخدم</div>
                    <div class="d-flex align-center gap-1 mt-2" style="display: flex; align-items: center; gap: 5px;">
                        <span style="color: #666; font-size: 0.9rem;">+500 نقطة لكل إحالة</span>
                    </div>
                </div>
                
                <div class="stat-item">
                    <h3><i class="fas fa-ad"></i> الإعلانات المتاحة</h3>
                    <div class="stat-value" id="adsCount">0 إعلان</div>
                    <div class="d-flex align-center gap-1 mt-2" style="display: flex; align-items: center; gap: 5px;">
                        <span style="color: #666; font-size: 0.9rem;">30 ثانية لكل إعلان</span>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs" id="mainTabs">
                <div class="tab active" onclick="switchTab('ads')">
                    <i class="fas fa-ad"></i>
                    <span>الإعلانات</span>
                </div>
                <div class="tab" onclick="switchTab('referral')">
                    <i class="fas fa-share-alt"></i>
                    <span>نظام الإحالة</span>
                </div>
                <div class="tab" onclick="switchTab('history')">
                    <i class="fas fa-history"></i>
                    <span>سجل العمليات</span>
                </div>
                <div class="tab" onclick="switchTab('help')">
                    <i class="fas fa-question-circle"></i>
                    <span>المساعدة</span>
                </div>
            </div>

            <!-- Ads Tab -->
            <div id="adsTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-ad"></i> الإعلانات المتاحة للمشاهدة</h2>
                        <div style="color: #666; font-size: 0.9rem;">
                            <i class="fas fa-info-circle"></i>
                            <span id="availableAdsText">جاري تحميل الإعلانات...</span>
                        </div>
                    </div>
                    
                    <!-- Ads Container -->
                    <div id="adsContainer" class="ads-grid">
                        <!-- Ads will be loaded here -->
                    </div>
                    
                    <!-- No Ads Message -->
                    <div id="noAdsMessage" class="empty-state" style="display: none;">
                        <i class="fas fa-ad"></i>
                        <h3 style="color: #666; margin-bottom: 10px;">لا توجد إعلانات متاحة حالياً</h3>
                        <p style="color: #999;">يرجى العودة لاحقًا لمشاهدة إعلانات جديدة</p>
                        <button onclick="loadAds()" class="btn mt-3">
                            <i class="fas fa-sync-alt"></i> تحديث الصفحة
                        </button>
                    </div>
                    
                    <!-- Ads Info -->
                    <div class="divider"></div>
                    <div class="d-flex justify-between align-center flex-wrap gap-2 mt-3" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-top: 15px;">
                        <div style="color: #666; font-size: 0.9rem;">
                            <i class="fas fa-info-circle"></i>
                            سيتم تجديد الإعلانات كل 24 ساعة
                        </div>
                        <div style="color: #666; font-size: 0.9rem;">
                            <i class="fas fa-clock"></i>
                            الحد الأقصى اليومي: <span id="dailyLimit">10</span> إعلان
                        </div>
                    </div>
                </div>
            </div>

            <!-- Referral Tab -->
            <div id="referralTab" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-share-alt"></i> نظام الإحالة</h2>
                    </div>
                    
                    <!-- Referral Stats -->
                    <div class="grid-3 mb-4" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-radius: 10px;">
                            <div style="font-size: 2rem; font-weight: bold; color: #667eea;" id="totalReferrals">0</div>
                            <div style="color: #666; font-size: 0.9rem;">إجمالي الإحالات</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(0, 176, 155, 0.1) 0%, rgba(150, 201, 61, 0.1) 100%); border-radius: 10px;">
                            <div style="font-size: 2rem; font-weight: bold; color: #00b09b;" id="referralEarnings">0</div>
                            <div style="color: #666; font-size: 0.9rem;">نقاط الإحالة</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 165, 0, 0.1) 100%); border-radius: 10px;">
                            <div style="font-size: 2rem; font-weight: bold; color: #FFD700;">500</div>
                            <div style="color: #666; font-size: 0.9rem;">نقطة لكل إحالة</div>
                        </div>
                    </div>
                    
                    <!-- Referral Link -->
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-link"></i> رابط الإحالة الخاص بك
                        </h3>
                        <div class="input-group">
                            <input type="text" id="referralLink" readonly class="allow-copy"
                                   style="flex: 1; background: #f8f9fa; font-weight: bold; font-size: 0.95rem;">
                            <button onclick="copyReferralLink()" class="btn btn-warning">
                                <i class="far fa-copy"></i> نسخ
                            </button>
                        </div>
                        <p style="color: #666; font-size: 0.9rem; margin-top: 8px;">
                            <i class="fas fa-info-circle"></i>
                            سيحصل صديقك على 100 نقطة هدية عند التسجيل باستخدام رابطك
                        </p>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="historyTab" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-history"></i> سجل العمليات</h2>
                    </div>
                    
                    <!-- History Content -->
                    <div id="clicksHistory">
                        <div class="d-flex justify-between align-center mb-3" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="color: #333; margin: 0;">آخر المشاهدات</h4>
                            <div style="color: #666; font-size: 0.9rem;">
                                إجمالي النقاط: <span id="totalClicksPoints">0</span>
                            </div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>التاريخ</th>
                                        <th>الإعلان</th>
                                        <th>النقاط</th>
                                        <th>الحالة</th>
                                    </tr>
                                </thead>
                                <tbody id="clicksHistoryBody">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Help Tab -->
            <div id="helpTab" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-question-circle"></i> مركز المساعدة</h2>
                    </div>
                    
                    <!-- FAQ -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #333; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-question"></i> الأسئلة الشائعة
                        </h3>
                        
                        <div style="margin-bottom: 15px; background: #f8f9fa; padding: 15px; border-radius: 10px;">
                            <h4 style="color: #667eea; margin-bottom: 8px; cursor: pointer;" onclick="toggleFAQ(1)">
                                <i class="fas fa-chevron-down" style="transition: transform 0.3s;"></i>
                                كيف يمكنني كسب النقاط؟
                            </h4>
                            <div id="faq1" style="display: none; color: #666; padding-right: 20px;">
                                يمكنك كسب النقاط عن طريق:
                                <ul style="margin-top: 8px; padding-right: 20px;">
                                    <li>مشاهدة الإعلانات (5-25 نقطة لكل إعلان)</li>
                                    <li>إحالة الأصدقاء (500 نقطة لكل صديق)</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px; background: #f8f9fa; padding: 15px; border-radius: 10px;">
                            <h4 style="color: #667eea; margin-bottom: 8px; cursor: pointer;" onclick="toggleFAQ(2)">
                                <i class="fas fa-chevron-down" style="transition: transform 0.3s;"></i>
                                ما هو الحد الأدنى للسحب؟
                            </h4>
                            <div id="faq2" style="display: none; color: #666; padding-right: 20px;">
                                الحد الأدنى للسحب هو 30,000 نقطة (ما يعادل 1 دولار).
                                يمكنك السحب عبر فودافون كاش فقط.
                            </div>
                        </div>
                    </div>
                    
                    <!-- Contact Information -->
                    <div>
                        <h3 style="color: #333; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-headset"></i> تواصل معنا
                        </h3>
                        
                        <div class="grid-2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <a href="mailto:bo2584668@gmail.com" class="btn" style="display: flex; flex-direction: column; align-items: center; padding: 20px;">
                                <i class="fas fa-envelope" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <span>البريد الإلكتروني</span>
                                <small style="margin-top: 5px; opacity: 0.8; font-size: 0.85rem;">bo2584668@gmail.com</small>
                            </a>
                            
                            <a href="https://wa.me/201273740256" target="_blank" class="btn btn-success" style="display: flex; flex-direction: column; align-items: center; padding: 20px;">
                                <i class="fab fa-whatsapp" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <span>واتساب</span>
                                <small style="margin-top: 5px; opacity: 0.8; font-size: 0.85rem;">+201273740256</small>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Timer Modal -->
    <div id="timerModal" class="modal">
        <div class="modal-content">
            <h2 style="color: #333; margin-bottom: 15px;">شاهد الإعلان</h2>
            <p id="adDescription" style="color: #666; margin-bottom: 20px;"></p>
            
            <div class="timer" id="countdown">30</div>
            
            <p style="color: #FF416C; font-weight: bold; margin-bottom: 25px;">
                <i class="fas fa-exclamation-triangle"></i>
                إذا خرجت قبل انتهاء الوقت ستفقد 5 نقاط
            </p>
            
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button onclick="cancelAd()" class="btn btn-danger">
                    <i class="fas fa-times"></i> إلغاء
                </button>
                <button onclick="completeAd()" class="btn btn-success">
                    <i class="fas fa-check"></i> أكملت المشاهدة
                </button>
            </div>
        </div>
    </div>

    <!-- Captcha Modal -->
    <div id="captchaModal" class="modal">
        <div class="modal-content">
            <h2 style="color: #333; margin-bottom: 15px;">تأكيد المشاهدة</h2>
            <p style="color: #666; margin-bottom: 20px;">أدخل الرقم الذي يظهر في الصورة:</p>
            
            <div style="background: #f0f0f0; padding: 25px; border-radius: 10px; font-size: 2.5rem; letter-spacing: 15px; margin: 25px 0; font-family: monospace; font-weight: bold; user-select: none;">
                <span id="captchaText">1234</span>
            </div>
            
            <input type="text" id="captchaInput" placeholder="أدخل الرقم هنا" 
                   style="width: 100%; padding: 15px; border: 2px solid #667eea; border-radius: 10px; font-size: 1.2rem; text-align: center; margin-bottom: 20px;">
            
            <button onclick="verifyCaptcha()" class="btn btn-success" style="width: 100%;">
                <i class="fas fa-check-circle"></i> تأكيد
            </button>
        </div>
    </div>

    <!-- Withdrawal Modal -->
    <div id="withdrawalModal" class="modal">
        <div class="modal-content">
            <h2 style="color: #333; margin-bottom: 20px;">طلب سحب الرصيد</h2>
            
            <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                <h4 style="color: #333; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-info-circle"></i> معلومات السحب
                </h4>
                <ul style="color: #666; text-align: right; list-style: none; padding: 0;">
                    <li style="margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-check-circle" style="color: #00b09b;"></i>
                        الحد الأدنى للسحب: 30,000 نقطة
                    </li>
                    <li style="margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-check-circle" style="color: #00b09b;"></i>
                        30,000 نقطة = 1 دولار
                    </li>
                    <li style="margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-check-circle" style="color: #00b09b;"></i>
                        السحب عبر فودافون كاش فقط
                    </li>
                    <li style="display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-check-circle" style="color: #00b09b;"></i>
                        وقت المعالجة: 24-48 ساعة
                    </li>
                </ul>
            </div>
            
            <div style="margin-bottom: 20px;">
                <div class="d-flex justify-between align-center mb-2" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <label style="color: #333; font-weight: bold;">
                        <i class="fas fa-coins"></i> رصيدك الحالي:
                    </label>
                    <span id="modalPoints" style="color: #FFD700; font-weight: bold; font-size: 1.2rem;">0</span>
                </div>
                
                <div class="progress-bar mb-4">
                    <div class="progress-fill" id="withdrawalProgress" style="width: 0%"></div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 500;">المبلغ المراد سحبه (نقاط)</label>
                    <input type="number" id="withdrawAmount" placeholder="أدخل المبلغ بالنقاط" min="30000" 
                           style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 1.1rem;">
                </div>
                
                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 500;">رقم فودافون كاش</label>
                    <input type="text" id="phoneNumber" placeholder="أدخل رقم فودافون كاش (مثال: 01012345678)" 
                           style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 1.1rem;">
                    <p style="color: #666; font-size: 0.9rem; margin-top: 8px;">
                        <i class="fas fa-info-circle"></i>
                        تأكد من صحة الرقم، سيتم التواصل معك عليه عبر الواتساب
                    </p>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <div class="d-flex justify-between align-center mb-2" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="color: #333;">المبلغ بالدولار:</span>
                        <span style="color: #667eea; font-weight: bold;" id="withdrawalDollars">$0</span>
                    </div>
                    <div class="d-flex justify-between align-center">
                        <span style="color: #333;">رسوم المعالجة:</span>
                        <span style="color: #666;">مجانية</span>
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 25px;">
                    <button onclick="hideWithdrawalModal()" class="btn btn-danger" style="flex: 1;">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                    <button onclick="submitWithdrawal()" class="btn btn-success" style="flex: 2;">
                        <i class="fas fa-paper-plane"></i> تقديم طلب السحب
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===========================================
        // FIREBASE CONFIGURATION
        // ===========================================
        const firebaseConfig = {
            apiKey: "AIzaSyC4fZQ-BTUeHsN9nQtMGmnjJz-NKdcUgkc",
            authDomain: "advista-b64ab.firebaseapp.com",
            projectId: "advista-b64ab",
            storageBucket: "advista-b64ab.firebasestorage.app",
            messagingSenderId: "509713648189",
            appId: "1:509713648189:web:0ccd6ada1f4e07f85d3854",
            measurementId: "G-VG4S1SMKH8"
        };

        // ===========================================
        // GLOBAL VARIABLES
        // ===========================================
        let currentUser = null;
        let currentAd = null;
        let timerInterval = null;
        let timeLeft = 30;
        let currentCaptcha = "";
        let userIP = "";
        let db = null;
        let firebaseApp = null;

        // ===========================================
        // INITIALIZATION FUNCTIONS
        // ===========================================

        // تهيئة Firebase أولاً
        function initializeFirebase() {
            try {
                // التحقق من تحميل مكتبة Firebase
                if (typeof firebase === 'undefined') {
                    console.warn('Firebase library not loaded yet, retrying...');
                    setTimeout(initializeFirebase, 100);
                    return;
                }

                // التحقق من عدم تهيئة Firebase مسبقاً
                if (firebase.apps.length > 0) {
                    firebaseApp = firebase.apps[0];
                    db = firebase.firestore();
                    console.log('Firebase already initialized');
                    initializeGoogleSignIn();
                    return;
                }

                // تهيئة Firebase
                firebaseApp = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                console.log('Firebase initialized successfully');
                
                // تهيئة Google Sign-In بعد Firebase
                initializeGoogleSignIn();
                
            } catch (error) {
                console.error('Error initializing Firebase:', error);
                showLoginError('خطأ في تهيئة قاعدة البيانات. يرجى إعادة تحميل الصفحة.');
            }
        }

        // تهيئة Google Sign-In
        function initializeGoogleSignIn() {
            try {
                // الانتظار حتى يتم تحميل مكتبة Google
                if (typeof google === 'undefined') {
                    console.warn('Google Sign-In library not loaded yet, retrying...');
                    setTimeout(initializeGoogleSignIn, 100);
                    return;
                }

                // التحقق من تهيئة Firebase أولاً
                if (!db) {
                    console.warn('Firebase not initialized yet, waiting...');
                    setTimeout(initializeGoogleSignIn, 100);
                    return;
                }

                // تهيئة Google Sign-In
                google.accounts.id.initialize({
                    client_id: "805966277330-9j5j1nvluj69f8uieog0kk77p0jb46q4.apps.googleusercontent.com",
                    callback: handleCredentialResponse,
                    auto_select: false,
                    cancel_on_tap_outside: true,
                    context: "signin"
                });

                // عرض زر تسجيل الدخول
                google.accounts.id.renderButton(
                    document.getElementById("buttonDiv"),
                    {
                        theme: "filled_blue",
                        size: "large",
                        text: "signin_with",
                        shape: "rectangular",
                        width: "250",
                        locale: "ar",
                        logo_alignment: "left"
                    }
                );

                // عرض نافذة اختيار الحساب تلقائياً
                google.accounts.id.prompt();
                
                console.log('Google Sign-In initialized successfully');
                hideLoading();
                
            } catch (error) {
                console.error('Error initializing Google Sign-In:', error);
                showLoginError('خطأ في تهيئة نظام تسجيل الدخول. يرجى إعادة تحميل الصفحة.');
            }
        }

        // ===========================================
        // HANDLE GOOGLE LOGIN RESPONSE
        // ===========================================
        async function handleCredentialResponse(response) {
            try {
                // التحقق من استجابة الـ Credential
                if (!response || !response.credential) {
                    console.error('No credential returned from Google');
                    showLoginError('فشل تسجيل الدخول. يرجى المحاولة مرة أخرى.');
                    return;
                }

                showLoading('جاري تسجيل الدخول...');
                
                // فك تشفير JWT
                const userData = parseJwt(response.credential);
                if (!userData) {
                    showLoginError('فشل في تحليل بيانات المستخدم.');
                    return;
                }
                
                // الحصول على عنوان IP
                userIP = await getIP();
                
                // إنشاء كائن المستخدم
                const user = {
                    uid: userData.sub,
                    email: userData.email,
                    name: userData.name || userData.email.split('@')[0],
                    picture: userData.picture || '',
                    points: 0,
                    totalEarned: 0,
                    totalWithdrawn: 0,
                    dailyStats: {},
                    referralCode: generateReferralCode(),
                    referredBy: getReferralFromURL(),
                    referrals: [],
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString(),
                    lastActivity: new Date().toISOString(),
                    ip: userIP,
                    isActive: true,
                    withdrawalRequests: []
                };

                console.log("Login successful:", user.email);

                // التحقق من وجود المستخدم مسبقاً
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (userDoc.exists) {
                    // تحديث بيانات المستخدم الحالي
                    currentUser = userDoc.data();
                    
                    await db.collection('users').doc(user.uid).update({
                        lastLogin: new Date().toISOString(),
                        lastActivity: new Date().toISOString(),
                        ip: userIP
                    });
                } else {
                    // إنشاء مستخدم جديد
                    await db.collection('users').doc(user.uid).set(user);
                    currentUser = user;
                    
                    // إضافة مكافأة الإحالة إذا وجدت
                    const referralCode = getReferralFromURL();
                    if (referralCode) {
                        await handleReferral(referralCode, user.uid);
                    }
                }

                // التحقق إذا كان المستخدم مديراً
                if (user.email === "bo2584668@gmail.com") {
                    showAdminPanel();
                } else {
                    showUserDashboard();
                }

                hideLoading();
                
                // تحميل بيانات المستخدم
                await loadUserData();
                await loadAds();

            } catch (error) {
                console.error("Login error:", error);
                hideLoading();
                showLoginError("حدث خطأ في تسجيل الدخول: " + error.message);
            }
        }

        // ===========================================
        // JWT DECODE FUNCTION
        // ===========================================
        function parseJwt(token) {
            try {
                if (!token) {
                    console.error('Empty token provided');
                    return null;
                }
                
                const parts = token.split('.');
                if (parts.length !== 3) {
                    console.error('Invalid JWT token format');
                    return null;
                }
                
                const base64Url = parts[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));

                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error("JWT Parse Error:", error);
                return null;
            }
        }

        // ===========================================
        // USER DASHBOARD FUNCTIONS
        // ===========================================
        async function loadUserData() {
            if (!currentUser || !db) return;

            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    currentUser = userData;
                    
                    // تحديث واجهة المستخدم
                    document.getElementById('userEmail').textContent = userData.email;
                    document.getElementById('userPoints').textContent = formatNumber(userData.points || 0);
                    document.getElementById('totalEarned').textContent = formatNumber(userData.totalEarned || 0) + ' نقطة';
                    document.getElementById('modalPoints').textContent = formatNumber(userData.points || 0);
                    
                    // تحديث شريط التقدم
                    const points = userData.points || 0;
                    const progress = Math.min((points / 30000) * 100, 100);
                    document.getElementById('withdrawalProgress').style.width = progress + '%';
                    
                    // أرباح اليوم
                    const today = getTodayDate();
                    const dailyEarned = userData.dailyStats && userData.dailyStats[today] 
                        ? userData.dailyStats[today].earned 
                        : 0;
                    document.getElementById('dailyEarned').textContent = formatNumber(dailyEarned) + ' نقطة';
                    
                    // الإحالات
                    const referralCount = userData.referrals ? userData.referrals.length : 0;
                    document.getElementById('referralCount').textContent = formatNumber(referralCount) + ' مستخدم';
                    document.getElementById('totalReferrals').textContent = formatNumber(referralCount);
                    document.getElementById('referralEarnings').textContent = formatNumber(referralCount * 500);
                    
                    // رابط الإحالة
                    const referralLink = window.location.href.split('?')[0] + '?ref=' + userData.referralCode;
                    document.getElementById('referralLink').value = referralLink;
                    
                    // تحديث مبلغ السحب
                    updateWithdrawalAmount();
                }
            } catch (error) {
                console.error("Error loading user data:", error);
            }
        }

        async function loadAds() {
            try {
                // أولاً، تحميل من Firebase
                const adsSnapshot = await db.collection('ads')
                    .where('isActive', '==', true)
                    .where('budget', '>', 0)
                    .limit(20)
                    .get();

                let ads = [];
                adsSnapshot.forEach(doc => {
                    ads.push({ id: doc.id, ...doc.data() });
                });

                // إذا كان عدد الإعلانات أقل من 10، إنشاء إعلانات عينة
                if (ads.length < 10) {
                    const sampleAds = generateSampleAds(10 - ads.length);
                    ads = ads.concat(sampleAds);
                }

                // تصفية الإعلانات التي لم يشاهدها المستخدم اليوم
                const today = getTodayDate();
                const watchedAds = currentUser.dailyStats && currentUser.dailyStats[today] 
                    ? currentUser.dailyStats[today].watchedAds || [] 
                    : [];

                const availableAds = ads.filter(ad => !watchedAds.includes(ad.id));

                // تحديث واجهة المستخدم
                document.getElementById('adsCount').textContent = formatNumber(availableAds.length) + ' إعلان';
                document.getElementById('availableAdsText').textContent = `${availableAds.length} إعلان متاح`;
                
                const adsContainer = document.getElementById('adsContainer');
                const noAdsMessage = document.getElementById('noAdsMessage');
                
                if (availableAds.length === 0) {
                    adsContainer.innerHTML = '';
                    noAdsMessage.style.display = 'block';
                    return;
                }
                
                noAdsMessage.style.display = 'none';
                adsContainer.innerHTML = '';

                availableAds.forEach((ad, index) => {
                    const adElement = document.createElement('div');
                    adElement.className = 'ad-card';
                    adElement.onclick = () => startAd(ad);
                    
                    adElement.innerHTML = `
                        <div class="ad-title">${ad.title || `إعلان ${index + 1}`}</div>
                        <p style="color: #666; font-size: 0.95rem; margin: 10px 0; line-height: 1.5;">
                            ${ad.description || 'شاهد هذا الإعلان لمدة 30 ثانية لتحصل على النقاط'}
                        </p>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                            <div class="ad-reward">
                                <i class="fas fa-coins"></i>
                                ${ad.reward || 10} نقطة
                            </div>
                            <div style="color: #666; font-size: 0.9rem;">
                                <i class="fas fa-clock"></i> 30 ثانية
                            </div>
                        </div>
                        <div style="margin-top: 15px; color: #999; font-size: 0.85rem; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-user"></i> ${ad.publisher || 'Advista'}
                        </div>
                    `;
                    
                    adsContainer.appendChild(adElement);
                });

            } catch (error) {
                console.error("Error loading ads:", error);
            }
        }

        // ===========================================
        // AD VIEWING SYSTEM
        // ===========================================
        function startAd(ad) {
            // التحقق إذا كان المستخدم يشاهد إعلاناً بالفعل
            if (currentAd) {
                showAlert("يجب إنهاء الإعلان الحالي أولاً", "error");
                return;
            }

            currentAd = ad;
            timeLeft = 30;
            
            // عرض نافذة المؤقت
            document.getElementById('timerModal').style.display = 'flex';
            document.getElementById('adDescription').textContent = ad.description || 'شاهد هذا الإعلان لمدة 30 ثانية للحصول على النقاط';
            document.getElementById('countdown').textContent = timeLeft;
            
            // بدء العد التنازلي
            updateCountdown();
            timerInterval = setInterval(updateCountdown, 1000);
            
            // منع المستخدم من الخروج
            window.addEventListener('beforeunload', handleBeforeUnload);
            document.addEventListener('visibilitychange', handleVisibilityChange);
        }

        function updateCountdown() {
            const countdownElement = document.getElementById('countdown');
            countdownElement.textContent = timeLeft;
            
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                showCaptcha();
            } else {
                timeLeft--;
            }
        }

        function cancelAd() {
            clearInterval(timerInterval);
            hideTimerModal();
            
            if (currentUser && currentUser.points >= 5) {
                // خصم 5 نقاط
                deductPoints(5);
                showAlert("تم خصم 5 نقاط لإلغاء المشاهدة", "error");
            }
            
            resetAdViewing();
        }

        function completeAd() {
            clearInterval(timerInterval);
            showCaptcha();
        }

        function showCaptcha() {
            hideTimerModal();
            document.getElementById('captchaModal').style.display = 'flex';
            
            // إنشاء كابتشا عشوائي
            currentCaptcha = Math.floor(1000 + Math.random() * 9000).toString();
            document.getElementById('captchaText').textContent = currentCaptcha;
            document.getElementById('captchaInput').value = '';
            document.getElementById('captchaInput').focus();
        }

        async function verifyCaptcha() {
            const userInput = document.getElementById('captchaInput').value.trim();
            
            if (userInput === '') {
                showAlert("يرجى إدخال الرقم", "error");
                document.getElementById('captchaInput').focus();
                return;
            }
            
            if (userInput === currentCaptcha) {
                // منح النقاط
                const reward = currentAd.reward || 10;
                await addPoints(reward, currentAd.id);
                
                hideCaptchaModal();
                showAlert(`مبروك! لقد ربحت ${reward} نقطة`, "success");
                
                // إعادة تحميل البيانات
                await loadUserData();
                await loadAds();
                
            } else {
                showAlert("الرقم غير صحيح. حاول مرة أخرى", "error");
                document.getElementById('captchaInput').value = '';
                document.getElementById('captchaInput').focus();
            }
        }

        // ===========================================
        // POINTS MANAGEMENT
        // ===========================================
        async function addPoints(points, adId) {
            if (!currentUser || !points || !db) return;
            
            const today = getTodayDate();
            const userRef = db.collection('users').doc(currentUser.uid);
            
            try {
                // تحديث النقاط
                await userRef.update({
                    points: firebase.firestore.FieldValue.increment(points),
                    totalEarned: firebase.firestore.FieldValue.increment(points),
                    lastActivity: new Date().toISOString(),
                    [`dailyStats.${today}.earned`]: firebase.firestore.FieldValue.increment(points),
                    [`dailyStats.${today}.adsWatched`]: firebase.firestore.FieldValue.increment(1),
                    [`dailyStats.${today}.watchedAds`]: firebase.firestore.FieldValue.arrayUnion(adId),
                    [`dailyStats.${today}.lastAdTime`]: new Date().toISOString()
                });
                
                // تحديث ميزانية الإعلان إذا كان من Firebase
                if (currentAd.id && !currentAd.external) {
                    const adRef = db.collection('ads').doc(currentAd.id);
                    await adRef.update({
                        budget: firebase.firestore.FieldValue.increment(-points),
                        views: firebase.firestore.FieldValue.increment(1)
                    });
                }
                
                // تسجيل تاريخ المشاهدة
                await db.collection('clicks').add({
                    userId: currentUser.uid,
                    adId: adId,
                    points: points,
                    timestamp: new Date().toISOString(),
                    ip: userIP
                });
                
                resetAdViewing();
                
            } catch (error) {
                console.error("Error adding points:", error);
                showAlert("حدث خطأ في إضافة النقاط", "error");
            }
        }

        async function deductPoints(points) {
            if (!currentUser || points <= 0 || !db) return;
            
            try {
                const userRef = db.collection('users').doc(currentUser.uid);
                await userRef.update({
                    points: firebase.firestore.FieldValue.increment(-points),
                    lastActivity: new Date().toISOString()
                });
            } catch (error) {
                console.error("Error deducting points:", error);
            }
        }

        // ===========================================
        // WITHDRAWAL SYSTEM
        // ===========================================
        function showWithdrawalModal() {
            if (!currentUser) return;
            
            if (currentUser.points < 30000) {
                showAlert(`أنت تحتاج ${formatNumber(30000 - currentUser.points)} نقطة أخرى للسحب. الحد الأدنى 30,000 نقطة.`, "error");
                return;
            }
            
            document.getElementById('withdrawalModal').style.display = 'flex';
            document.getElementById('withdrawAmount').value = currentUser.points >= 30000 ? 30000 : currentUser.points;
            updateWithdrawalAmount();
            document.getElementById('withdrawAmount').focus();
        }

        function hideWithdrawalModal() {
            document.getElementById('withdrawalModal').style.display = 'none';
        }

        function updateWithdrawalAmount() {
            const amountInput = document.getElementById('withdrawAmount');
            if (!amountInput) return;
            
            const amount = parseInt(amountInput.value) || 0;
            const dollars = (amount / 30000).toFixed(2);
            document.getElementById('withdrawalDollars').textContent = `$${dollars}`;
            
            // تحديث شريط التقدم
            const points = currentUser?.points || 0;
            const progress = Math.min((amount / points) * 100, 100);
            document.getElementById('withdrawalProgress').style.width = progress + '%';
        }

        async function submitWithdrawal() {
            if (!currentUser || !db) return;
            
            const amount = parseInt(document.getElementById('withdrawAmount').value);
            const phone = document.getElementById('phoneNumber').value.trim();
            
            // التحقق من صحة البيانات
            if (!amount || isNaN(amount) || amount < 30000) {
                showAlert("الحد الأدنى للسحب هو 30,000 نقطة", "error");
                return;
            }
            
            if (amount > currentUser.points) {
                showAlert("نقاطك غير كافية", "error");
                return;
            }
            
            if (!phone || !/^01[0-9]{9}$/.test(phone)) {
                showAlert("رقم الهاتف غير صحيح. يجب أن يكون رقم فودافون كاش مصري", "error");
                return;
            }
            
            showLoading("جاري معالجة طلب السحب...");
            
            try {
                // إنشاء طلب سحب
                const withdrawalId = Date.now().toString();
                const withdrawalRequest = {
                    id: withdrawalId,
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    amount: amount,
                    points: amount,
                    phoneNumber: phone,
                    status: 'pending',
                    requestedAt: new Date().toISOString(),
                    approvedAt: null,
                    adminNotes: '',
                    ip: userIP
                };
                
                // حفظ في قاعدة البيانات
                await db.collection('withdrawals').doc(withdrawalId).set(withdrawalRequest);
                
                // تحديث نقاط المستخدم وإضافة إلى تاريخ السحوبات
                const userRef = db.collection('users').doc(currentUser.uid);
                await userRef.update({
                    points: firebase.firestore.FieldValue.increment(-amount),
                    totalWithdrawn: firebase.firestore.FieldValue.increment(amount),
                    lastActivity: new Date().toISOString(),
                    withdrawalRequests: firebase.firestore.FieldValue.arrayUnion(withdrawalId)
                });
                
                hideLoading();
                hideWithdrawalModal();
                showAlert("تم إرسال طلب السحب بنجاح. سيتم التواصل معك عبر الواتساب خلال 24 ساعة", "success");
                
                // تفريغ الحقول
                document.getElementById('phoneNumber').value = '';
                
                // إعادة تحميل بيانات المستخدم
                await loadUserData();
                
            } catch (error) {
                hideLoading();
                console.error("Withdrawal error:", error);
                showAlert("حدث خطأ في طلب السحب", "error");
            }
        }

        // ===========================================
        // REFERRAL SYSTEM
        // ===========================================
        async function handleReferral(referralCode, newUserId) {
            if (!db) return;
            
            try {
                // البحث عن المستخدم برمز الإحالة هذا
                const usersSnapshot = await db.collection('users')
                    .where('referralCode', '==', referralCode)
                    .limit(1)
                    .get();
                
                if (!usersSnapshot.empty) {
                    const referrerDoc = usersSnapshot.docs[0];
                    const referrerId = referrerDoc.id;
                    
                    // إضافة مكافأة الإحالة للمحيل
                    const referrerRef = db.collection('users').doc(referrerId);
                    await referrerRef.update({
                        points: firebase.firestore.FieldValue.increment(500),
                        totalEarned: firebase.firestore.FieldValue.increment(500),
                        lastActivity: new Date().toISOString(),
                        referrals: firebase.firestore.FieldValue.arrayUnion(newUserId)
                    });
                    
                    // تسجيل الإحالة
                    await db.collection('referrals').add({
                        referrerId: referrerId,
                        referredId: newUserId,
                        bonus: 500,
                        timestamp: new Date().toISOString()
                    });
                    
                    console.log("Referral bonus added for:", referrerId);
                }
            } catch (error) {
                console.error("Error handling referral:", error);
            }
        }

        function copyReferralLink() {
            const linkInput = document.getElementById('referralLink');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999);
            
            try {
                navigator.clipboard.writeText(linkInput.value);
                showAlert("تم نسخ رابط الإحالة بنجاح", "success");
            } catch (err) {
                document.execCommand('copy');
                showAlert("تم نسخ الرابط", "success");
            }
        }

        // ===========================================
        // UTILITY FUNCTIONS
        // ===========================================
        function showAlert(message, type = "success") {
            const alertDiv = document.getElementById('mainAlert');
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            const errorText = document.getElementById('loginErrorText');
            
            errorText.textContent = message;
            errorDiv.style.display = 'block';
        }

        function showLoading(message = "جاري التحميل...") {
            document.getElementById('loadingText').textContent = message;
            document.getElementById('loading').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function hideTimerModal() {
            document.getElementById('timerModal').style.display = 'none';
        }

        function hideCaptchaModal() {
            document.getElementById('captchaModal').style.display = 'none';
        }

        function showUserDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('userDashboard').style.display = 'block';
        }

        function showAdminPanel() {
            // في النسخة المبسطة، سنعرض لوحة المستخدم العادية للمدير
            showUserDashboard();
            showAlert("مرحباً بك يا مدير!", "success");
        }

        function logout() {
            if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {
                google.accounts.id.disableAutoSelect();
            }
            
            currentUser = null;
            document.getElementById('userDashboard').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            
            // إعادة تحميل الصفحة لتفريغ الذاكرة
            setTimeout(() => {
                window.location.reload();
            }, 500);
        }

        function getTodayDate() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
        }

        function generateReferralCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function getReferralFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('ref');
        }

        async function getIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'unknown';
            }
        }

        function resetAdViewing() {
            currentAd = null;
            clearInterval(timerInterval);
            window.removeEventListener('beforeunload', handleBeforeUnload);
            document.removeEventListener('visibilitychange', handleVisibilityChange);
        }

        function handleBeforeUnload(e) {
            if (currentAd) {
                e.preventDefault();
                e.returnValue = 'أنت تشاهد إعلانًا حاليًا. إذا خرجت ستفقد 5 نقاط.';
                return e.returnValue;
            }
        }

        function handleVisibilityChange() {
            if (document.hidden && currentAd) {
                cancelAd();
                showAlert("تم اكتشاف تغيير النافذة. تم إلغاء الإعلان", "error");
            }
        }

        function generateSampleAds(count) {
            const adTitles = [
                "موقع تسوق إلكتروني",
                "تطبيق توصيل طعام",
                "خدمة تدفق فيديو",
                "لعبة الجوال الجديدة",
                "منصة تعليمية",
                "تطبيق موسيقى",
                "خدمة حجز سفر",
                "تطبيق لياقة بدنية",
                "منصة عمل حر",
                "متجر إلكتروني"
            ];
            
            const adDescriptions = [
                "اكتشف أفضل العروض والتخفيضات الحصرية",
                "اطلب طعامك المفضل بخصم 20% لفترة محدودة",
                "اشترك الآن ومشاهدة بدون إعلانات لمدة شهر",
                "اللعبة الأكثر شهرة هذا الشهر، حمّلها الآن",
                "تعلم مهارات جديدة مجانًا مع خبراء المجال",
                "استمع لأحدث الأغاني بدون إعلانات لمدة أسبوع",
                "احجز رحلتك القادمة بأسعار مميزة وخصومات",
                "ابدأ رحلة اللياقة مع مدرب شخصي مجاني",
                "احصل على مشاريع مناسبة لمهاراتك ووقتك",
                "تسوق أحدث المنتجات بأسعار منافسة وجودة عالية"
            ];
            
            const publishers = [
                "Amazon",
                "Uber Eats",
                "Netflix",
                "Supercell",
                "Coursera",
                "Spotify",
                "Booking.com",
                "Fitbit",
                "Upwork",
                "AliExpress"
            ];
            
            const ads = [];
            for (let i = 0; i < count; i++) {
                ads.push({
                    id: 'sample_' + Date.now() + '_' + i,
                    title: adTitles[Math.floor(Math.random() * adTitles.length)],
                    description: adDescriptions[Math.floor(Math.random() * adDescriptions.length)],
                    reward: [5, 10, 15, 20, 25][Math.floor(Math.random() * 5)],
                    duration: 30,
                    publisher: publishers[Math.floor(Math.random() * publishers.length)],
                    budget: 10000,
                    isActive: true,
                    external: true
                });
            }
            return ads;
        }

        function switchTab(tabName) {
            // إخفاء جميع التبويبات
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // إزالة الفئة النشطة من جميع التبويبات
            document.querySelectorAll('#mainTabs .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // إظهار التبويب المحدد
            document.getElementById(tabName + 'Tab').style.display = 'block';
            
            // إضافة الفئة النشطة للتبويب المحدد
            event.target.classList.add('active');
        }

        function toggleFAQ(id) {
            const faqContent = document.getElementById('faq' + id);
            const icon = event.currentTarget.querySelector('i');
            
            if (faqContent.style.display === 'block') {
                faqContent.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            } else {
                faqContent.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            }
        }

        function formatNumber(num) {
            if (!num) return '0';
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function showPointsDetails() {
            if (!currentUser) return;
            
            const points = currentUser.points || 0;
            const needed = Math.max(0, 30000 - points);
            
            alert(`رصيدك الحالي: ${formatNumber(points)} نقطة\nالنقاط المتبقية للسحب: ${formatNumber(needed)} نقطة`);
        }

        // ===========================================
        // INITIALIZE APP ON LOAD
        // ===========================================
        window.onload = function() {
            // عرض شاشة التحميل
            showLoading('جاري تهيئة التطبيق...');
            
            // بدء تهيئة Firebase
            setTimeout(() => {
                initializeFirebase();
            }, 1000);
            
            // إضافة حماية النسخ
            document.addEventListener('copy', function(e) {
                if (!e.target.classList.contains('allow-copy')) {
                    e.preventDefault();
                    showAlert("لا يمكن نسخ النص من هذا الموقع", "error");
                }
            });
            
            // منع النقر الأيمن
            document.addEventListener('contextmenu', function(e) {
                if (!e.target.classList.contains('allow-copy')) {
                    e.preventDefault();
                    return false;
                }
            });
            
            // منع التكبير/التصغير
            document.addEventListener('wheel', function(e) {
                if (e.ctrlKey) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            // منع التكبير/التصغير بالكيبورد
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && (e.key === '+' || e.key === '-' || e.key === '0')) {
                    e.preventDefault();
                }
            });
            
            // منع تحديد النص
            document.addEventListener('selectstart', function(e) {
                if (!e.target.classList.contains('allow-copy')) {
                    e.preventDefault();
                    return false;
                }
            });
            
            // إخفاء النوافذ عند النقر خارجها
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
            
            // إضافة مستمع للتحكم بمبلغ السحب
            const withdrawAmountInput = document.getElementById('withdrawAmount');
            if (withdrawAmountInput) {
                withdrawAmountInput.addEventListener('input', updateWithdrawalAmount);
            }
        };
    </script>
</body>
</html>
