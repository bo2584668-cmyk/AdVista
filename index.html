<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Advista - كسب المال من مشاهدة الإعلانات</title>
    
    <!-- Firebase & Google Sign-In -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            touch-action: manipulation;
            overflow-x: hidden;
            color: #333;
        }
        
        /* Disable Zoom */
        body.no-zoom {
            touch-action: pan-x pan-y;
            max-zoom: 1;
            min-zoom: 1;
        }
        
        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Login Screen */
        #loginScreen {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 100%;
        }
        
        .logo {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .logo-icon {
            font-size: 4rem;
            color: #667eea;
        }
        
        .logo h1 {
            color: #667eea;
            font-size: 2.5rem;
            margin: 0;
        }
        
        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .points-display {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            padding: 10px 25px;
            border-radius: 50px;
            color: #333;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 3px 10px rgba(255, 165, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }
        
        .card-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .stat-item h3 {
            color: #666;
            font-size: 1rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
        }
        
        /* Ads Grid */
        .ads-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .ad-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .ad-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
        }
        
        .ad-title {
            font-weight: bold;
            color: #333;
            font-size: 1.2rem;
            margin-bottom: 10px;
        }
        
        .ad-reward {
            color: #FFD700;
            font-weight: bold;
            background: rgba(255, 215, 0, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        }
        
        .timer {
            font-size: 4rem;
            font-weight: bold;
            color: #667eea;
            margin: 30px 0;
            font-family: monospace;
        }
        
        /* Buttons */
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-decoration: none;
        }
        
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #FF416C, #FF4B2B);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #00b09b, #96c93d);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #FFD700, #FFA500);
        }
        
        /* Inputs */
        input, select, textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        /* Loading */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Copy Protection */
        .no-copy {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .allow-copy {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .user-info {
                justify-content: center;
                width: 100%;
            }
            
            .ads-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                padding: 25px;
                width: 95%;
            }
            
            .timer {
                font-size: 3rem;
            }
            
            .login-card {
                padding: 25px;
                margin: 15px;
            }
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }
        
        /* Alert */
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 10px 10px 0 0;
            background: #f1f1f1;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
        }
        
        /* Admin Panel */
        .admin-panel {
            display: none;
        }
        
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .admin-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        th, td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }
        
        tr:hover {
            background: #f5f5f5;
        }
    </style>
</head>
<body class="no-zoom no-copy" oncontextmenu="return false;">
    <!-- Loading Overlay -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-card">
            <div class="logo">
                <i class="fas fa-gem logo-icon"></i>
                <h1>Advista</h1>
                <p style="color: #666; font-size: 1.1rem;">كسب المال من مشاهدة الإعلانات</p>
            </div>
            
            <div style="margin: 30px 0;">
                <h2 style="color: #333; margin-bottom: 15px;">سجل الدخول لتبدأ الربح</h2>
                <p style="color: #666; margin-bottom: 20px;">سجل دخولك باستخدام حساب جوجل للبدء</p>
                
                <div id="googleSignInButton" style="margin: 25px 0;">
                    <div id="buttonDiv"></div>
                </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 30px;">
                <h3 style="color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-info-circle"></i> معلومات السحب
                </h3>
                <div style="text-align: right;">
                    <p style="color: #666; margin: 8px 0; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-check-circle" style="color: #00b09b;"></i>
                        الحد الأدنى للسحب: <strong>30,000 نقطة</strong>
                    </p>
                    <p style="color: #666; margin: 8px 0; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-check-circle" style="color: #00b09b;"></i>
                        30,000 نقطة = <strong>1 دولار</strong>
                    </p>
                    <p style="color: #666; margin: 8px 0; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-check-circle" style="color: #00b09b;"></i>
                        السحب عبر <strong>فودافون كاش</strong> فقط
                    </p>
                </div>
            </div>
            
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                <p style="color: #999; font-size: 0.9rem;">
                    <i class="fas fa-shield-alt"></i> معلوماتك محمية ولا يتم مشاركتها
                </p>
            </div>
        </div>
    </div>

    <!-- User Dashboard (Hidden by default) -->
    <div id="userDashboard" style="display: none;">
        <div class="container">
            <!-- Alert Messages -->
            <div id="alertMessage" class="alert" style="display: none;"></div>
            
            <!-- Header -->
            <div class="header">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <i class="fas fa-gem" style="font-size: 2rem; color: #667eea;"></i>
                    <div>
                        <h1 style="margin: 0; color: #667eea;">Advista</h1>
                        <p style="margin: 5px 0 0; color: #666; font-size: 0.9rem;" id="userEmail"></p>
                    </div>
                </div>
                
                <div class="user-info">
                    <div class="points-display">
                        <i class="fas fa-coins"></i>
                        <span id="userPoints">0</span> نقطة
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="showWithdrawalModal()" class="btn btn-success">
                            <i class="fas fa-wallet"></i> سحب رصيد
                        </button>
                        <button onclick="logout()" class="btn btn-danger">
                            <i class="fas fa-sign-out-alt"></i> خروج
                        </button>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-item">
                    <h3><i class="fas fa-chart-line"></i> إجمالي الأرباح</h3>
                    <div class="stat-value" id="totalEarned">0 نقطة</div>
                </div>
                
                <div class="stat-item">
                    <h3><i class="fas fa-calendar-day"></i> أرباح اليوم</h3>
                    <div class="stat-value" id="dailyEarned">0 نقطة</div>
                </div>
                
                <div class="stat-item">
                    <h3><i class="fas fa-users"></i> الإحالات</h3>
                    <div class="stat-value" id="referralCount">0 مستخدم</div>
                </div>
                
                <div class="stat-item">
                    <h3><i class="fas fa-ad"></i> الإعلانات المتاحة</h3>
                    <div class="stat-value" id="adsCount">0 إعلان</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab('ads')">الإعلانات</div>
                <div class="tab" onclick="switchTab('referral')">نظام الإحالة</div>
                <div class="tab" onclick="switchTab('history')">سجل العمليات</div>
                <div class="tab" onclick="switchTab('contact')">تواصل معنا</div>
            </div>

            <!-- Ads Tab -->
            <div id="adsTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-ad"></i> الإعلانات المتاحة للمشاهدة</h2>
                        <div style="color: #666; font-size: 0.9rem;">
                            <i class="fas fa-clock"></i> كل إعلان: 30 ثانية
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <p style="color: #666;">
                            <i class="fas fa-info-circle"></i> شاهد الإعلان لمدة 30 ثانية لتحصل على النقاط.
                            إذا خرجت قبل انتهاء الوقت ستفقد 5 نقاط.
                        </p>
                    </div>
                    
                    <div id="adsContainer" class="ads-grid">
                        <!-- Ads will be loaded here -->
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        <p style="color: #666;">
                            <i class="fas fa-sync-alt"></i> يتم تحديث الإعلانات كل 24 ساعة
                        </p>
                    </div>
                </div>
            </div>

            <!-- Referral Tab -->
            <div id="referralTab" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-share-alt"></i> نظام الإحالة</h2>
                    </div>
                    
                    <div style="text-align: center; padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white; margin-bottom: 30px;">
                        <i class="fas fa-gift" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <h2 style="margin-bottom: 10px; color: white;">احصل على 500 نقطة مجانًا!</h2>
                        <p>احصل على 500 نقطة عن كل صديق يسجل باستخدام رابطك</p>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-link"></i> رابط الإحالة الخاص بك
                        </h3>
                        <div class="input-group">
                            <input type="text" id="referralLink" readonly class="allow-copy"
                                   style="flex: 1; background: #f8f9fa; font-weight: bold;">
                            <button onclick="copyReferralLink()" class="btn btn-warning">
                                <i class="far fa-copy"></i> نسخ
                            </button>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 30px;">
                        <div style="background: #e8f4fd; padding: 20px; border-radius: 10px; text-align: center;">
                            <i class="fas fa-user-plus" style="font-size: 2rem; color: #667eea; margin-bottom: 10px;"></i>
                            <h4 style="color: #333; margin-bottom: 10px;">خطوة 1</h4>
                            <p style="color: #666;">شارك رابط الإحالة مع أصدقائك</p>
                        </div>
                        
                        <div style="background: #e8f4fd; padding: 20px; border-radius: 10px; text-align: center;">
                            <i class="fas fa-user-check" style="font-size: 2rem; color: #667eea; margin-bottom: 10px;"></i>
                            <h4 style="color: #333; margin-bottom: 10px;">خطوة 2</h4>
                            <p style="color: #666;">يسجل صديقك باستخدام رابطك</p>
                        </div>
                        
                        <div style="background: #e8f4fd; padding: 20px; border-radius: 10px; text-align: center;">
                            <i class="fas fa-coins" style="font-size: 2rem; color: #667eea; margin-bottom: 10px;"></i>
                            <h4 style="color: #333; margin-bottom: 10px;">خطوة 3</h4>
                            <p style="color: #666;">احصل على 500 نقطة فورًا</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="historyTab" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-history"></i> سجل العمليات</h2>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div class="tabs" style="border: none; padding: 0;">
                            <div class="tab active" onclick="showHistory('clicks')">مشاهدات الإعلانات</div>
                            <div class="tab" onclick="showHistory('withdrawals')">طلبات السحب</div>
                            <div class="tab" onclick="showHistory('referrals')">الإحالات</div>
                        </div>
                    </div>
                    
                    <div id="clicksHistory">
                        <table>
                            <thead>
                                <tr>
                                    <th>التاريخ</th>
                                    <th>الإعلان</th>
                                    <th>النقاط</th>
                                </tr>
                            </thead>
                            <tbody id="clicksHistoryBody">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="withdrawalsHistory" style="display: none;">
                        <table>
                            <thead>
                                <tr>
                                    <th>التاريخ</th>
                                    <th>المبلغ</th>
                                    <th>رقم الهاتف</th>
                                    <th>الحالة</th>
                                </tr>
                            </thead>
                            <tbody id="withdrawalsHistoryBody">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="referralsHistory" style="display: none;">
                        <table>
                            <thead>
                                <tr>
                                    <th>التاريخ</th>
                                    <th>المستخدم</th>
                                    <th>النقاط</th>
                                </tr>
                            </thead>
                            <tbody id="referralsHistoryBody">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Contact Tab -->
            <div id="contactTab" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-headset"></i> تواصل معنا</h2>
                    </div>
                    
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h3 style="color: #333; margin-bottom: 15px;">لديك استفسار أو مشكلة؟</h3>
                        <p style="color: #666;">نحن هنا لمساعدتك على مدار الساعة</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <a href="mailto:bo2584668@gmail.com" class="btn" style="display: flex; flex-direction: column; align-items: center; padding: 25px;">
                            <i class="fas fa-envelope" style="font-size: 2.5rem; margin-bottom: 15px;"></i>
                            <span>البريد الإلكتروني</span>
                            <small style="margin-top: 5px; opacity: 0.8;">bo2584668@gmail.com</small>
                        </a>
                        
                        <a href="https://wa.me/201273740256" target="_blank" class="btn btn-success" style="display: flex; flex-direction: column; align-items: center; padding: 25px;">
                            <i class="fab fa-whatsapp" style="font-size: 2.5rem; margin-bottom: 15px;"></i>
                            <span>واتساب</span>
                            <small style="margin-top: 5px; opacity: 0.8;">+201273740256</small>
                        </a>
                        
                        <a href="https://instagram.com/Baraa___offical" target="_blank" class="btn btn-danger" style="display: flex; flex-direction: column; align-items: center; padding: 25px;">
                            <i class="fab fa-instagram" style="font-size: 2.5rem; margin-bottom: 15px;"></i>
                            <span>إنستجرام</span>
                            <small style="margin-top: 5px; opacity: 0.8;">Baraa___offical</small>
                        </a>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 30px;">
                        <h4 style="color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-question-circle"></i> الأسئلة الشائعة
                        </h4>
                        
                        <div style="margin-bottom: 15px;">
                            <h5 style="color: #667eea; margin-bottom: 5px;">متى يمكنني السحب؟</h5>
                            <p style="color: #666;">يمكنك السحب عندما تصل إلى 30,000 نقطة (1 دولار)</p>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <h5 style="color: #667eea; margin-bottom: 5px;">كم تستغرق عملية السحب؟</h5>
                            <p style="color: #666;">تستغرق 24-48 ساعة بعد طلب السحب</p>
                        </div>
                        
                        <div>
                            <h5 style="color: #667eea; margin-bottom: 5px;">هل يمكنني مشاهدة أكثر من إعلان في نفس الوقت؟</h5>
                            <p style="color: #666;">لا، يمكنك مشاهدة إعلان واحد فقط في كل مرة</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel (Hidden by default) -->
    <div id="adminPanel" class="admin-panel">
        <div class="container">
            <div class="header">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <i class="fas fa-crown" style="font-size: 2rem; color: #FFD700;"></i>
                    <div>
                        <h1 style="margin: 0; color: #667eea;">لوحة تحكم Advista</h1>
                        <p style="margin: 5px 0 0; color: #666; font-size: 0.9rem;">لوحة تحكم المدير</p>
                    </div>
                </div>
                
                <div class="user-info">
                    <button onclick="switchToUserDashboard()" class="btn">
                        <i class="fas fa-user"></i> لوحة المستخدم
                    </button>
                    <button onclick="logout()" class="btn btn-danger">
                        <i class="fas fa-sign-out-alt"></i> خروج
                    </button>
                </div>
            </div>

            <!-- Admin Tabs -->
            <div class="tabs">
                <div class="tab active" onclick="switchAdminTab('dashboard')">الإحصائيات</div>
                <div class="tab" onclick="switchAdminTab('ads')">إدارة الإعلانات</div>
                <div class="tab" onclick="switchAdminTab('withdrawals')">طلبات السحب</div>
                <div class="tab" onclick="switchAdminTab('users')">المستخدمين</div>
                <div class="tab" onclick="switchAdminTab('settings')">الإعدادات</div>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminDashboard" class="admin-grid">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Timer Modal -->
    <div id="timerModal" class="modal">
        <div class="modal-content">
            <h2 style="color: #333; margin-bottom: 15px;">شاهد الإعلان</h2>
            <p id="adDescription" style="color: #666; margin-bottom: 20px;"></p>
            
            <div class="timer" id="countdown">30</div>
            
            <p style="color: #FF416C; font-weight: bold; margin-bottom: 25px;">
                <i class="fas fa-exclamation-triangle"></i>
                إذا خرجت قبل انتهاء الوقت ستفقد 5 نقاط
            </p>
            
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button onclick="cancelAd()" class="btn btn-danger">
                    <i class="fas fa-times"></i> إلغاء
                </button>
                <button onclick="completeAd()" class="btn btn-success">
                    <i class="fas fa-check"></i> أكملت المشاهدة
                </button>
            </div>
        </div>
    </div>

    <!-- Captcha Modal -->
    <div id="captchaModal" class="modal">
        <div class="modal-content">
            <h2 style="color: #333; margin-bottom: 15px;">تأكيد المشاهدة</h2>
            <p style="color: #666; margin-bottom: 20px;">أدخل الرقم الذي يظهر في الصورة:</p>
            
            <div style="background: #f0f0f0; padding: 25px; border-radius: 10px; font-size: 2.5rem; letter-spacing: 15px; margin: 25px 0; font-family: monospace; font-weight: bold;">
                <span id="captchaText">1234</span>
            </div>
            
            <input type="text" id="captchaInput" placeholder="أدخل الرقم هنا" 
                   style="width: 100%; padding: 15px; border: 2px solid #667eea; border-radius: 10px; font-size: 1.2rem; text-align: center; margin-bottom: 20px;">
            
            <button onclick="verifyCaptcha()" class="btn btn-success" style="width: 100%;">
                <i class="fas fa-check-circle"></i> تأكيد
            </button>
        </div>
    </div>

    <!-- Withdrawal Modal -->
    <div id="withdrawalModal" class="modal">
        <div class="modal-content">
            <h2 style="color: #333; margin-bottom: 20px;">طلب سحب الرصيد</h2>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                <h4 style="color: #333; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-info-circle"></i> معلومات السحب
                </h4>
                <ul style="color: #666; text-align: right; list-style: none; padding: 0;">
                    <li style="margin-bottom: 8px;">• الحد الأدنى للسحب: 30,000 نقطة</li>
                    <li style="margin-bottom: 8px;">• 30,000 نقطة = 1 دولار</li>
                    <li style="margin-bottom: 8px;">• السحب عبر فودافون كاش فقط</li>
                    <li>• وقت المعالجة: 24-48 ساعة</li>
                </ul>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #333; font-weight: bold;">
                    <i class="fas fa-coins"></i> رصيدك الحالي:
                    <span id="modalPoints" style="color: #FFD700;">0</span> نقطة
                </label>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #333;">المبلغ المراد سحبه (نقاط)</label>
                    <input type="number" id="withdrawAmount" placeholder="أدخل المبلغ بالنقاط" min="30000" 
                           style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px;">
                </div>
                
                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 5px; color: #333;">رقم فودافون كاش</label>
                    <input type="text" id="phoneNumber" placeholder="أدخل رقم فودافون كاش" 
                           style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px;">
                </div>
                
                <div style="color: #666; font-size: 0.9rem; margin-bottom: 20px;">
                    <p>بعد تقديم الطلب، سيتم التواصل معك على الواتساب للتحقق والدفع</p>
                </div>
                
                <div style="display: flex; gap: 15px;">
                    <button onclick="hideWithdrawalModal()" class="btn btn-danger" style="flex: 1;">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                    <button onclick="submitWithdrawal()" class="btn btn-success" style="flex: 1;">
                        <i class="fas fa-paper-plane"></i> تقديم الطلب
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===============================
        // Firebase Configuration
        // ===============================
        const firebaseConfig = {
            apiKey: "AIzaSyC4fZQ-BTUeHsN9nQtMGmnjJz-NKdcUgkc",
            authDomain: "advista-b64ab.firebaseapp.com",
            projectId: "advista-b64ab",
            storageBucket: "advista-b64ab.firebasestorage.app",
            messagingSenderId: "509713648189",
            appId: "1:509713648189:web:0ccd6ada1f4e07f85d3854",
            measurementId: "G-VG4S1SMKH8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ===============================
        // Global Variables
        // ===============================
        let currentUser = null;
        let currentAd = null;
        let timerInterval = null;
        let timeLeft = 30;
        let currentCaptcha = "";
        let userIP = "";

        // ===============================
        // Google Sign-In Initialization
        // ===============================
        function initializeGoogleSignIn() {
            if (typeof google === 'undefined') {
                setTimeout(initializeGoogleSignIn, 100);
                return;
            }

            google.accounts.id.initialize({
                client_id: "805966277330-9j5j1nvluj69f8uieog0kk77p0jb46q4.apps.googleusercontent.com",
                callback: handleCredentialResponse,
                auto_select: false,
                cancel_on_tap_outside: true,
                context: "signin"
            });

            google.accounts.id.renderButton(
                document.getElementById("buttonDiv"),
                {
                    theme: "filled_blue",
                    size: "large",
                    text: "signin_with",
                    shape: "rectangular",
                    width: "250",
                    locale: "ar",
                    logo_alignment: "left"
                }
            );

            google.accounts.id.prompt();
        }

        // ===============================
        // Handle Google Login Response
        // ===============================
        async function handleCredentialResponse(response) {
            try {
                showLoading();
                const userData = parseJwt(response.credential);
                
                // Get user IP
                userIP = await getIP();
                
                const user = {
                    uid: userData.sub,
                    email: userData.email,
                    name: userData.name || userData.email.split('@')[0],
                    picture: userData.picture || '',
                    points: 0,
                    totalEarned: 0,
                    dailyStats: {
                        [getTodayDate()]: {
                            earned: 0,
                            adsWatched: 0
                        }
                    },
                    referralCode: generateReferralCode(),
                    referredBy: getReferralFromURL(),
                    referrals: [],
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString(),
                    ip: userIP,
                    isActive: true,
                    withdrawalRequests: [],
                    totalWithdrawn: 0
                };

                console.log("Login successful:", user.email);

                // Check if user exists
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (userDoc.exists) {
                    // Update last login
                    await db.collection('users').doc(user.uid).update({
                        lastLogin: new Date().toISOString(),
                        ip: userIP
                    });
                    currentUser = userDoc.data();
                } else {
                    // Create new user
                    await db.collection('users').doc(user.uid).set(user);
                    currentUser = user;
                    
                    // Add referral bonus if applicable
                    const referralCode = getReferralFromURL();
                    if (referralCode) {
                        await handleReferral(referralCode, user.uid);
                    }
                }

                // Check if admin
                if (user.email === "bo2584668@gmail.com") {
                    showAdminPanel();
                } else {
                    showUserDashboard();
                }

                hideLoading();
                
                // Load user data
                await loadUserData();
                await loadAds();

            } catch (error) {
                console.error("Login error:", error);
                hideLoading();
                showAlert("حدث خطأ في تسجيل الدخول: " + error.message, "error");
            }
        }

        // ===============================
        // JWT Decode Function
        // ===============================
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));

                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error("JWT Parse Error:", error);
                return null;
            }
        }

        // ===============================
        // User Dashboard Functions
        // ===============================
        async function loadUserData() {
            if (!currentUser) return;

            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    currentUser = userData;
                    
                    // Update UI
                    document.getElementById('userEmail').textContent = userData.email;
                    document.getElementById('userPoints').textContent = userData.points?.toLocaleString() || '0';
                    document.getElementById('totalEarned').textContent = (userData.totalEarned || 0).toLocaleString() + ' نقطة';
                    document.getElementById('modalPoints').textContent = userData.points?.toLocaleString() || '0';
                    
                    // Daily earnings
                    const today = getTodayDate();
                    const dailyEarned = userData.dailyStats && userData.dailyStats[today] 
                        ? userData.dailyStats[today].earned 
                        : 0;
                    document.getElementById('dailyEarned').textContent = dailyEarned.toLocaleString() + ' نقطة';
                    
                    // Referrals
                    const referralCount = userData.referrals ? userData.referrals.length : 0;
                    document.getElementById('referralCount').textContent = referralCount + ' مستخدم';
                    
                    // Referral link
                    const referralLink = `${window.location.origin}${window.location.pathname}?ref=${userData.referralCode}`;
                    document.getElementById('referralLink').value = referralLink;
                    
                    // Load history
                    await loadHistory();
                }
            } catch (error) {
                console.error("Error loading user data:", error);
            }
        }

        async function loadAds() {
            try {
                // First, load from Firebase
                const adsSnapshot = await db.collection('ads')
                    .where('isActive', '==', true)
                    .where('budget', '>', 0)
                    .limit(50)
                    .get();

                let ads = [];
                adsSnapshot.forEach(doc => {
                    ads.push({ id: doc.id, ...doc.data() });
                });

                // If less than 45 ads, load sample ads
                if (ads.length < 45) {
                    const sampleAds = generateSampleAds(45 - ads.length);
                    ads = ads.concat(sampleAds);
                }

                // Filter ads user hasn't watched today
                const today = getTodayDate();
                const watchedAds = currentUser.dailyStats && currentUser.dailyStats[today] 
                    ? currentUser.dailyStats[today].watchedAds || [] 
                    : [];

                const availableAds = ads.filter(ad => !watchedAds.includes(ad.id));

                // Update UI
                document.getElementById('adsCount').textContent = availableAds.length + ' إعلان';
                const adsContainer = document.getElementById('adsContainer');
                adsContainer.innerHTML = '';

                if (availableAds.length === 0) {
                    adsContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; grid-column: 1 / -1;">
                            <i class="fas fa-ad" style="font-size: 4rem; color: #ddd; margin-bottom: 20px;"></i>
                            <h3 style="color: #666; margin-bottom: 15px;">لا توجد إعلانات متاحة حاليًا</h3>
                            <p style="color: #999;">يرجى العودة لاحقًا لمشاهدة إعلانات جديدة</p>
                        </div>
                    `;
                    return;
                }

                availableAds.forEach((ad, index) => {
                    const adElement = document.createElement('div');
                    adElement.className = 'ad-card';
                    adElement.onclick = () => startAd(ad);
                    
                    adElement.innerHTML = `
                        <div class="ad-title">${ad.title || `إعلان ${index + 1}`}</div>
                        <p style="color: #666; font-size: 0.95rem; margin: 12px 0; line-height: 1.5;">
                            ${ad.description || 'شاهد هذا الإعلان لمدة 30 ثانية لتحصل على النقاط'}
                        </p>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                            <div class="ad-reward">
                                <i class="fas fa-coins"></i>
                                ${ad.reward || 10} نقطة
                            </div>
                            <div style="color: #666; font-size: 0.9rem;">
                                <i class="fas fa-clock"></i> 30 ثانية
                            </div>
                        </div>
                        <div style="margin-top: 15px; color: #999; font-size: 0.85rem; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-user"></i> ${ad.publisher || 'Advista'}
                        </div>
                    `;
                    
                    adsContainer.appendChild(adElement);
                });

            } catch (error) {
                console.error("Error loading ads:", error);
                showAlert("حدث خطأ في تحميل الإعلانات", "error");
            }
        }

        // ===============================
        // Ad Viewing System
        // ===============================
        function startAd(ad) {
            // Check if user is already watching an ad
            if (currentAd) {
                showAlert("يجب إنهاء الإعلان الحالي أولاً", "error");
                return;
            }

            currentAd = ad;
            timeLeft = 30;
            
            // Show timer modal
            document.getElementById('timerModal').style.display = 'flex';
            document.getElementById('adDescription').textContent = ad.description || 'شاهد هذا الإعلان لمدة 30 ثانية للحصول على النقاط';
            
            // Start countdown
            updateCountdown();
            timerInterval = setInterval(updateCountdown, 1000);
            
            // Prevent user from leaving
            window.addEventListener('beforeunload', handleBeforeUnload);
            document.addEventListener('visibilitychange', handleVisibilityChange);
        }

        function updateCountdown() {
            const countdownElement = document.getElementById('countdown');
            countdownElement.textContent = timeLeft;
            
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                showCaptcha();
            } else {
                timeLeft--;
            }
        }

        function cancelAd() {
            clearInterval(timerInterval);
            hideTimerModal();
            
            if (currentUser && currentUser.points >= 5) {
                // Deduct 5 points
                deductPoints(5);
                showAlert("تم خصم 5 نقاط لإلغاء المشاهدة", "error");
            }
            
            resetAdViewing();
        }

        function completeAd() {
            clearInterval(timerInterval);
            showCaptcha();
        }

        function showCaptcha() {
            hideTimerModal();
            document.getElementById('captchaModal').style.display = 'flex';
            
            // Generate random captcha
            currentCaptcha = Math.floor(1000 + Math.random() * 9000).toString();
            document.getElementById('captchaText').textContent = currentCaptcha;
            document.getElementById('captchaInput').value = '';
            document.getElementById('captchaInput').focus();
        }

        async function verifyCaptcha() {
            const userInput = document.getElementById('captchaInput').value;
            
            if (userInput === currentCaptcha) {
                // Award points
                const reward = currentAd.reward || 10;
                await addPoints(reward, currentAd.id);
                
                hideCaptchaModal();
                showAlert(`مبروك! لقد ربحت ${reward} نقطة`, "success");
                
                // Reload data
                await loadUserData();
                await loadAds();
            } else {
                showAlert("الرقم غير صحيح. حاول مرة أخرى", "error");
                document.getElementById('captchaInput').value = '';
                document.getElementById('captchaInput').focus();
            }
        }

        // ===============================
        // Points Management
        // ===============================
        async function addPoints(points, adId) {
            if (!currentUser || !points) return;
            
            const today = getTodayDate();
            const userRef = db.collection('users').doc(currentUser.uid);
            
            try {
                // Update points
                await userRef.update({
                    points: firebase.firestore.FieldValue.increment(points),
                    totalEarned: firebase.firestore.FieldValue.increment(points),
                    [`dailyStats.${today}.earned`]: firebase.firestore.FieldValue.increment(points),
                    [`dailyStats.${today}.adsWatched`]: firebase.firestore.FieldValue.increment(1),
                    [`dailyStats.${today}.watchedAds`]: firebase.firestore.FieldValue.arrayUnion(adId)
                });
                
                // Update ad budget if it's from Firebase
                if (currentAd.id && !currentAd.external) {
                    const adRef = db.collection('ads').doc(currentAd.id);
                    await adRef.update({
                        budget: firebase.firestore.FieldValue.increment(-points),
                        views: firebase.firestore.FieldValue.increment(1)
                    });
                }
                
                // Record click history
                await db.collection('clicks').add({
                    userId: currentUser.uid,
                    adId: adId,
                    points: points,
                    timestamp: new Date().toISOString(),
                    ip: userIP
                });
                
                resetAdViewing();
                
            } catch (error) {
                console.error("Error adding points:", error);
                showAlert("حدث خطأ في إضافة النقاط", "error");
            }
        }

        async function deductPoints(points) {
            if (!currentUser || points <= 0) return;
            
            try {
                const userRef = db.collection('users').doc(currentUser.uid);
                await userRef.update({
                    points: firebase.firestore.FieldValue.increment(-points)
                });
            } catch (error) {
                console.error("Error deducting points:", error);
            }
        }

        // ===============================
        // Withdrawal System
        // ===============================
        function showWithdrawalModal() {
            if (!currentUser) return;
            
            if (currentUser.points < 30000) {
                showAlert(`أنت تحتاج ${(30000 - currentUser.points).toLocaleString()} نقطة أخرى للسحب. الحد الأدنى 30,000 نقطة.`, "error");
                return;
            }
            
            document.getElementById('withdrawalModal').style.display = 'flex';
            document.getElementById('withdrawAmount').value = currentUser.points >= 30000 ? 30000 : currentUser.points;
            document.getElementById('withdrawAmount').focus();
        }

        function hideWithdrawalModal() {
            document.getElementById('withdrawalModal').style.display = 'none';
        }

        async function submitWithdrawal() {
            if (!currentUser) return;
            
            const amount = parseInt(document.getElementById('withdrawAmount').value);
            const phone = document.getElementById('phoneNumber').value.trim();
            
            // Validation
            if (!amount || isNaN(amount) || amount < 30000) {
                showAlert("الحد الأدنى للسحب هو 30,000 نقطة", "error");
                return;
            }
            
            if (amount > currentUser.points) {
                showAlert("نقاطك غير كافية", "error");
                return;
            }
            
            if (!phone || !/^01[0-9]{9}$/.test(phone)) {
                showAlert("رقم الهاتف غير صحيح. يجب أن يكون رقم فودافون كاش مصري", "error");
                return;
            }
            
            showLoading();
            
            try {
                // Create withdrawal request
                const withdrawalId = Date.now().toString();
                const withdrawalRequest = {
                    id: withdrawalId,
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    amount: amount,
                    points: amount,
                    phoneNumber: phone,
                    status: 'pending',
                    requestedAt: new Date().toISOString(),
                    approvedAt: null,
                    adminNotes: '',
                    ip: userIP
                };
                
                // Save to database
                await db.collection('withdrawals').doc(withdrawalId).set(withdrawalRequest);
                
                // Update user points
                const userRef = db.collection('users').doc(currentUser.uid);
                await userRef.update({
                    points: firebase.firestore.FieldValue.increment(-amount),
                    withdrawalRequests: firebase.firestore.FieldValue.arrayUnion(withdrawalId)
                });
                
                // Send notification (simulated)
                await sendWithdrawalNotification(withdrawalRequest);
                
                hideLoading();
                hideWithdrawalModal();
                showAlert("تم إرسال طلب السحب بنجاح. سيتم التواصل معك عبر الواتساب خلال 24 ساعة", "success");
                
                // Clear form
                document.getElementById('phoneNumber').value = '';
                
                // Reload user data
                await loadUserData();
                
            } catch (error) {
                hideLoading();
                console.error("Withdrawal error:", error);
                showAlert("حدث خطأ في طلب السحب", "error");
            }
        }

        // ===============================
        // Referral System
        // ===============================
        async function handleReferral(referralCode, newUserId) {
            try {
                // Find user with this referral code
                const usersSnapshot = await db.collection('users')
                    .where('referralCode', '==', referralCode)
                    .limit(1)
                    .get();
                
                if (!usersSnapshot.empty) {
                    const referrerDoc = usersSnapshot.docs[0];
                    const referrerId = referrerDoc.id;
                    
                    // Add referral bonus to referrer
                    const referrerRef = db.collection('users').doc(referrerId);
                    await referrerRef.update({
                        points: firebase.firestore.FieldValue.increment(500),
                        totalEarned: firebase.firestore.FieldValue.increment(500),
                        referrals: firebase.firestore.FieldValue.arrayUnion(newUserId)
                    });
                    
                    // Record referral
                    await db.collection('referrals').add({
                        referrerId: referrerId,
                        referredId: newUserId,
                        bonus: 500,
                        timestamp: new Date().toISOString()
                    });
                    
                    console.log("Referral bonus added for:", referrerId);
                }
            } catch (error) {
                console.error("Error handling referral:", error);
            }
        }

        function copyReferralLink() {
            const linkInput = document.getElementById('referralLink');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999);
            
            try {
                navigator.clipboard.writeText(linkInput.value);
                showAlert("تم نسخ رابط الإحالة بنجاح", "success");
            } catch (err) {
                document.execCommand('copy');
                showAlert("تم نسخ الرابط", "success");
            }
        }

        // ===============================
        // History System
        // ===============================
        async function loadHistory() {
            if (!currentUser) return;
            
            try {
                // Load clicks history
                const clicksSnapshot = await db.collection('clicks')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get();
                
                const clicksHistoryBody = document.getElementById('clicksHistoryBody');
                clicksHistoryBody.innerHTML = '';
                
                if (clicksSnapshot.empty) {
                    clicksHistoryBody.innerHTML = `
                        <tr>
                            <td colspan="3" style="text-align: center; padding: 30px; color: #666;">
                                <i class="fas fa-history" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                                لا توجد عمليات سابقة
                            </td>
                        </tr>
                    `;
                } else {
                    clicksSnapshot.forEach(doc => {
                        const click = doc.data();
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${formatDate(click.timestamp)}</td>
                            <td>إعلان ${click.adId?.substring(0, 8) || 'غير معروف'}</td>
                            <td><span style="color: #00b09b; font-weight: bold;">+${click.points}</span></td>
                        `;
                        clicksHistoryBody.appendChild(row);
                    });
                }
                
                // Load withdrawals history
                const withdrawalsSnapshot = await db.collection('withdrawals')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('requestedAt', 'desc')
                    .limit(20)
                    .get();
                
                const withdrawalsHistoryBody = document.getElementById('withdrawalsHistoryBody');
                withdrawalsHistoryBody.innerHTML = '';
                
                if (withdrawalsSnapshot.empty) {
                    withdrawalsHistoryBody.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 30px; color: #666;">
                                <i class="fas fa-wallet" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                                لا توجد طلبات سحب سابقة
                            </td>
                        </tr>
                    `;
                } else {
                    withdrawalsSnapshot.forEach(doc => {
                        const withdrawal = doc.data();
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${formatDate(withdrawal.requestedAt)}</td>
                            <td><span style="color: #FFD700; font-weight: bold;">${withdrawal.points?.toLocaleString()}</span></td>
                            <td>${withdrawal.phoneNumber}</td>
                            <td>
                                <span style="padding: 5px 10px; border-radius: 20px; font-size: 0.85rem; 
                                      background: ${getStatusColor(withdrawal.status)}; color: white;">
                                    ${getStatusText(withdrawal.status)}
                                </span>
                            </td>
                        `;
                        withdrawalsHistoryBody.appendChild(row);
                    });
                }
                
            } catch (error) {
                console.error("Error loading history:", error);
            }
        }

        // ===============================
        // Admin Functions
        // ===============================
        function showAdminPanel() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('userDashboard').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadAdminDashboard();
        }

        function switchToUserDashboard() {
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('userDashboard').style.display = 'block';
        }

        async function loadAdminDashboard() {
            try {
                // Load stats
                const usersSnapshot = await db.collection('users').get();
                const withdrawalsSnapshot = await db.collection('withdrawals').get();
                const adsSnapshot = await db.collection('ads').get();
                
                const totalUsers = usersSnapshot.size;
                const activeUsers = usersSnapshot.docs.filter(doc => doc.data().isActive).length;
                const totalWithdrawals = withdrawalsSnapshot.size;
                const pendingWithdrawals = withdrawalsSnapshot.docs.filter(doc => doc.data().status === 'pending').length;
                const totalAds = adsSnapshot.size;
                const activeAds = adsSnapshot.docs.filter(doc => doc.data().isActive).length;
                
                const adminDashboard = document.getElementById('adminDashboard');
                adminDashboard.innerHTML = `
                    <div class="admin-card">
                        <h3><i class="fas fa-users"></i> المستخدمين</h3>
                        <div style="font-size: 2.5rem; font-weight: bold; color: #667eea; margin: 15px 0;">${totalUsers}</div>
                        <p style="color: #666;">${activeUsers} مستخدم نشط</p>
                    </div>
                    
                    <div class="admin-card">
                        <h3><i class="fas fa-wallet"></i> طلبات السحب</h3>
                        <div style="font-size: 2.5rem; font-weight: bold; color: #FFD700; margin: 15px 0;">${totalWithdrawals}</div>
                        <p style="color: #666;">${pendingWithdrawals} طلب بانتظار الموافقة</p>
                    </div>
                    
                    <div class="admin-card">
                        <h3><i class="fas fa-ad"></i> الإعلانات</h3>
                        <div style="font-size: 2.5rem; font-weight: bold; color: #00b09b; margin: 15px 0;">${totalAds}</div>
                        <p style="color: #666;">${activeAds} إعلان نشط</p>
                    </div>
                    
                    <div class="admin-card">
                        <h3><i class="fas fa-cog"></i> إجراءات سريعة</h3>
                        <div style="margin-top: 20px;">
                            <button onclick="createNewAd()" class="btn" style="width: 100%; margin-bottom: 10px;">
                                <i class="fas fa-plus"></i> إعلان جديد
                            </button>
                            <button onclick="viewWithdrawals()" class="btn btn-success" style="width: 100%; margin-bottom: 10px;">
                                <i class="fas fa-eye"></i> عرض طلبات السحب
                            </button>
                            <button onclick="viewUsers()" class="btn btn-warning" style="width: 100%;">
                                <i class="fas fa-users"></i> إدارة المستخدمين
                            </button>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error("Error loading admin dashboard:", error);
            }
        }

        // ===============================
        // Utility Functions
        // ===============================
        function showAlert(message, type = "success") {
            const alertDiv = document.getElementById('alertMessage');
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function hideTimerModal() {
            document.getElementById('timerModal').style.display = 'none';
        }

        function hideCaptchaModal() {
            document.getElementById('captchaModal').style.display = 'none';
        }

        function showUserDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('userDashboard').style.display = 'block';
        }

        function logout() {
            google.accounts.id.disableAutoSelect();
            currentUser = null;
            document.getElementById('userDashboard').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
        }

        function getTodayDate() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
        }

        function generateReferralCode() {
            return Math.random().toString(36).substring(2, 10).toUpperCase();
        }

        function getReferralFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('ref');
        }

        async function getIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'unknown';
            }
        }

        function resetAdViewing() {
            currentAd = null;
            clearInterval(timerInterval);
            window.removeEventListener('beforeunload', handleBeforeUnload);
            document.removeEventListener('visibilitychange', handleVisibilityChange);
        }

        function handleBeforeUnload(e) {
            if (currentAd) {
                e.preventDefault();
                e.returnValue = 'أنت تشاهد إعلانًا حاليًا. إذا خرجت ستفقد 5 نقاط.';
                return e.returnValue;
            }
        }

        function handleVisibilityChange() {
            if (document.hidden && currentAd) {
                cancelAd();
                showAlert("تم اكتشاف تغيير النافذة. تم إلغاء الإعلان", "error");
            }
        }

        async function sendWithdrawalNotification(withdrawal) {
            // In a real app, send email/WhatsApp to admin
            console.log("Withdrawal notification:", withdrawal);
            
            const adminEmail = 'bo2584668@gmail.com';
            const subject = `طلب سحب جديد - ${withdrawal.amount} نقطة`;
            const body = `
                طلب سحب جديد:
                
                المستخدم: ${withdrawal.userEmail}
                المبلغ: ${withdrawal.amount} نقطة (${(withdrawal.amount/30000).toFixed(2)} دولار)
                رقم الهاتف: ${withdrawal.phoneNumber}
                الوقت: ${new Date(withdrawal.requestedAt).toLocaleString('ar-EG')}
                IP: ${withdrawal.ip}
            `;
            
            console.log(`Email to ${adminEmail}: ${subject}\n${body}`);
        }

        function generateSampleAds(count) {
            const adTitles = [
                "موقع تسوق إلكتروني",
                "تطبيق توصيل طعام",
                "خدمة تدفق فيديو",
                "لعبة الجوال الجديدة",
                "منصة تعليمية",
                "تطبيق موسيقى",
                "خدمة حجز سفر",
                "تطبيق لياقة بدنية",
                "منصة عمل حر",
                "متجر إلكتروني"
            ];
            
            const adDescriptions = [
                "اكتشف أفضل العروض والتخفيضات",
                "اطلب طعامك المفضل بخصم 20%",
                "اشترك الآن ومشاهدة بدون إعلانات",
                "اللعبة الأكثر شهرة هذا الشهر",
                "تعلم مهارات جديدة مجانًا",
                "استمع لأحدث الأغاني بدون إعلانات",
                "احجز رحلتك القادمة بأسعار مميزة",
                "ابدأ رحلة اللياقة مع مدرب شخصي",
                "احصل على مشاريع مناسبة لمهاراتك",
                "تسوق أحدث المنتجات بأسعار منافسة"
            ];
            
            const ads = [];
            for (let i = 0; i < count; i++) {
                ads.push({
                    id: 'sample_' + Date.now() + '_' + i,
                    title: adTitles[Math.floor(Math.random() * adTitles.length)],
                    description: adDescriptions[Math.floor(Math.random() * adDescriptions.length)],
                    reward: Math.floor(Math.random() * 20) + 5, // 5-25 points
                    publisher: "شريك Advista",
                    budget: 10000,
                    isActive: true,
                    external: true
                });
            }
            return ads;
        }

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').style.display = 'block';
            
            // Add active class to selected tab
            event.target.classList.add('active');
        }

        function showHistory(type) {
            // Hide all history tables
            document.getElementById('clicksHistory').style.display = 'none';
            document.getElementById('withdrawalsHistory').style.display = 'none';
            document.getElementById('referralsHistory').style.display = 'none';
            
            // Remove active class from all tabs
            document.querySelectorAll('#historyTab .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected history
            document.getElementById(type + 'History').style.display = 'block';
            
            // Add active class to selected tab
            event.target.classList.add('active');
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('ar-EG', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getStatusColor(status) {
            switch(status) {
                case 'pending': return '#FFA500';
                case 'approved': return '#00b09b';
                case 'rejected': return '#FF416C';
                default: return '#666';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'pending': return 'قيد الانتظار';
                case 'approved': return 'تم الموافقة';
                case 'rejected': return 'مرفوض';
                default: return status;
            }
        }

        function switchAdminTab(tabName) {
            // This would switch between admin tabs
            console.log("Switch to admin tab:", tabName);
        }

        // ===============================
        // Initialize App
        // ===============================
        window.onload = function() {
            initializeGoogleSignIn();
            
            // Add copy protection
            document.addEventListener('copy', function(e) {
                if (!e.target.classList.contains('allow-copy')) {
                    e.preventDefault();
                    showAlert("لا يمكن نسخ النص من هذا الموقع", "error");
                }
            });
            
            // Disable right click
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
            });
            
            // Prevent zoom
            document.addEventListener('wheel', function(e) {
                if (e.ctrlKey) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            // Prevent keyboard zoom
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && (e.key === '+' || e.key === '-' || e.key === '0')) {
                    e.preventDefault();
                }
            });
            
            // Check if user is already logged in (simplified)
            // In a real app, you'd use Firebase Auth persistence
        };
    </script>
</body>
</html>
